<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£ | AustinMa&#39;s Blog</title>
<meta name="keywords" content="æ“ä½œç³»ç»Ÿç”³ä¼˜, os">
<meta name="description" content="è¿™æ˜¯æˆ‘çš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ç”³ä¼˜æ–‡æ¡£">
<meta name="author" content="
ä½œè€…:&nbsp;AustinMa">
<link rel="canonical" href="https://mksasx.github.io/posts/tech/os/great/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.557197a4f061e753a7b8e859202b40c279a6f38f74d06feec3d54053779f1ae2.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mksasx.github.io/img/1.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://mksasx.github.io/img/1.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://mksasx.github.io/img/1.jpg">
<link rel="apple-touch-icon" href="https://mksasx.github.io/img/1.jpg">
<link rel="mask-icon" href="https://mksasx.github.io/img/1.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£" />
<meta property="og:description" content="è¿™æ˜¯æˆ‘çš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ç”³ä¼˜æ–‡æ¡£" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mksasx.github.io/posts/tech/os/great/" />
<meta property="og:image" content="https://mksasx.github.io/posts/tech/os/great.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-09T16:31:30&#43;08:00" />
<meta property="article:modified_time" content="2022-10-09T16:31:30&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mksasx.github.io/posts/tech/os/great.png" />
<meta name="twitter:title" content="æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£"/>
<meta name="twitter:description" content="è¿™æ˜¯æˆ‘çš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ç”³ä¼˜æ–‡æ¡£"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://mksasx.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://mksasx.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "âš›ï¸ æ“ä½œç³»ç»Ÿ",
      "item": "https://mksasx.github.io/posts/tech/os/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£",
      "item": "https://mksasx.github.io/posts/tech/os/great/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£",
  "name": "æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£",
  "description": "è¿™æ˜¯æˆ‘çš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ç”³ä¼˜æ–‡æ¡£",
  "keywords": [
    "æ“ä½œç³»ç»Ÿç”³ä¼˜", "os"
  ],
  "articleBody": "Lab6-Challenge å®éªŒæŠ¥å‘Š å®éªŒæ¦‚è¿° åœ¨æœ¬å®éªŒä¸­ï¼Œæˆ‘é€šè¿‡ç¼–å†™æ–°å‡½æ•°ï¼Œæ–°çš„æ–¹æ³•å®ç°ä¸€äº›å°ç»„ä»¶ä»¥åŠé™„åŠ åŠŸèƒ½ï¼Œä¸°å¯Œäº†æˆ‘ä»¬çš„ shellçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬\"åå°è¿è¡Œ\"ï¼Œâ€œä¸€è¡Œå¤šå‘½ä»¤â€ï¼Œâ€œç®€å•å¼•å·æ”¯æŒâ€ï¼Œâ€œtree /mkdir /touch å‘½ä»¤â€ï¼Œâ€œæ¸…å±â€ï¼Œâ€œå½©è‰²è¾“å‡ºâ€ï¼Œâ€œå†å²å‘½ä»¤â€ï¼Œâ€œç¯å¢ƒå˜é‡â€ï¼Œâ€œcd å‘½ä»¤\"ç­‰ä»»åŠ¡ã€‚\nå„éƒ¨åˆ†å®ç°æ€è·¯åŠä»£ç  Easyéƒ¨åˆ† ï¼ˆ1ï¼‰å®ç°åå°è¿è¡Œ 1ã€é¦–å…ˆåœ¨getc.Sä¸­ï¼Œä¿®æ”¹æ±‡ç¼–ä»£ç ï¼Œä»¥é˜²æ­¢å‰å°è¢«é˜»å¡ï¼Œæ‰‹åŠ¨å¿½ç•¥è¾“å…¥ã€‚\nLEAF(sys_cgetc) 1: lb t0, 0x90000000 //beqz t0, 1b //nop move v0,t0 jr ra nop END(sys_cgetc) 2ã€ä¿®æ”¹shell\nåœ¨sh.cä¸­runcmd()å®šä¹‰ä¸€ä¸ªå˜é‡ hang æ ‡è®°æ˜¯å¦è¦åå°è¿è¡Œï¼Œåˆå§‹åŒ–ä¸º0ã€‚\ncase '\u0026': hang = 1; break; åœ¨è¿è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œè‹¥æ— \u0026ï¼Œæ­£å¸¸ç­‰å¾…ç¨‹åºè¿è¡Œç»“æŸï¼Œè‹¥æœ‰\u0026ï¼Œé‚£ä¹ˆå°±è°ƒç”¨fork()ç”Ÿæˆå­è¿›ç¨‹ï¼ŒåŒæ—¶è¦é˜²æ­¢é˜»å¡ï¼Œå¹¶ä¸”åœ¨ç¨‹åºè¿è¡Œç»“æŸåï¼Œè¾“å‡ºæç¤ºä¿¡æ¯ã€‚\n//æ— \u0026ï¼Œå°±ç­‰è¿›ç¨‹ç»“æŸ if (!hang) wait(r); //æœ‰\u0026ï¼Œå°±forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œç­‰å¾…æ–°åŠ è½½çš„ç¨‹åºè¿è¡Œå®Œæˆï¼Œè¾“å‡ºæç¤ºä¿¡æ¯ else { pid = fork(); if (pid == 0) //åˆ›å»ºcmdå­è¿›ç¨‹ { wait(r); //ç­‰å¾…æ–°åŠ è½½çš„ç¨‹åºè¿è¡Œå®Œ writef(\"\\n[%d] DONE\\t\", r);//æç¤ºä¿¡æ¯ for (i = 0; i \u003c argc; ++i) writef(\"%s \", argv[i]); char curpath[MAXPATHLEN]; int envid = syscall_getenvid(); int shellid = syscall_getfaid(envid); curpath_get(shellid, curpath); writef(\"\\n\" LIGHT_BLUE(% s) \" \" BOLD_GREEN($) \" \", curpath); writef(\"\\b \\b\"); exit(); } } ï¼ˆ2ï¼‰ä¸€è¡Œå¤šå‘½ä»¤ ä½¿ç”¨ fork åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œå·²ç»è¯†åˆ«çš„å‘½ä»¤ï¼Œcmdè¿›ç¨‹åˆ™ç»§ç»­è§£æä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤è¿è¡Œå‰ï¼Œéƒ½éœ€è¦å¯¹ç›¸åº”çš„çŠ¶æ€å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶ååä¸€æ¡æŒ‡ä»¤åœ¨å­è¿›ç¨‹è¿è¡Œç»“æŸåï¼Œå†è¿›è¡Œè¿è¡Œã€‚\ncase ';': if ((pid = fork()) == 0) //åˆ›å»ºå­è¿›ç¨‹ { goto runit; } wait(pid);//ç­‰å¾…å­è¿›ç¨‹è¿è¡Œç»“æŸ //å‚æ•°é‡æ–°åˆå§‹åŒ– argc = 0; hang = 0; rightpipe = 0; //çˆ¶è¿›ç¨‹è·³å‡ºswitchï¼Œ ç»§ç»­è§£æä¸‹ä¸€ä¸ªå‘½ä»¤ file_input = -1; file_output = -1; break; ï¼ˆ3ï¼‰å¼•å·æ”¯æŒ ä¿®æ”¹ token çš„éƒ¨åˆ†ï¼Œè¯†åˆ«åˆ°å¼•å·çš„æ—¶å€™ä¸€ç›´ç»§ç»­è¯»ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå¼•å·ã€‚\nif (*s == '\\\"') { *p1 = ++s; while (*s \u0026\u0026 !(*s == '\\\"' \u0026\u0026 *(s - 1) != '\\\\')) { ++s; } *s++ = 0; *p2 = s; return 'w'; } ï¼ˆ4ï¼‰tree / mkdir /touch tree\nä¸»å‡½æ•°tree()é€šè¿‡å‚æ•°çš„è§£ææ¥è°ƒç”¨walk()\nvoid tree(char *path, char *prefix) { struct Stat status; int r = stat(path, \u0026status); if (r \u003c 0) user_panic(\"stat %s: %e\", path, r); walk(path, 0); } walk()å‡½æ•°å®ç°å†…éƒ¨çš„é€’å½’è°ƒç”¨,ä¼ å…¥è·¯å¾„å’Œå±‚çº§æ•°é‡,éå†æ–‡ä»¶ã€‚å¯¹äºåµŒå¥—çš„ç›®å½•ï¼Œä½¿ç”¨é€’å½’çš„æ–¹å¼éå†ã€‚\nè¾“å‡ºæ—¶å€ŸåŠ©äºå±‚çº§æ•°é‡æ¥æ ¼å¼åŒ–è¾“å‡ºç»“æœã€‚\nvoid walk(char *path, int len) { int dir_fd; struct File f; int i; char newpath[MAXPATHLEN] = {0}; dir_fd = open(path, O_RDONLY); if (dir_fd \u003c 0) user_panic(\"failed: open %s: %e\", *path*, dir_fd); while (readn(dir_fd, \u0026f, sizeof (struct File)) == sizeof (struct File)) { if (f.f_name[0]) { struct File *dir = \u0026f; //æ ¼å¼åŒ–è¾“å‡º for (i = 0; i \u003c len*4; i++) fwritef(1, \" \"); fwritef(1, \"\\n\"); for (i = 0; i \u003c len*4; i++) fwritef(1, \" \"); fwritef(1, \"|-- \"); // è¾“å‡ºå½“å‰æ–‡ä»¶æˆ–ç›®å½• if (dir-\u003ef_type == FTYPE_REG) { fwritef(1, YELLOW(%s), dir-\u003ef_name); } //é€’å½’è¾“å‡ºå­ç›®å½• else if (dir-\u003ef_type == FTYPE_DIR) { fwritef(1, PURPLE(%s), dir-\u003ef_name); //æ‹¼æ¥å­ç›®å½•è·¯å¾„ strcat(newpath, path); strcat(newpath, dir-\u003ef_name); strcat(newpath, \"/\"); // writef(\"nxtpath:\\n%s\", npath);* walk(newpath, len + 1); } } } } mkdir\nä¸ºäº†ç®€åŒ–æ“ä½œï¼Œå®ç°åç»­mkdirï¼Œå¢åŠ ç³»ç»Ÿè°ƒç”¨æ¥å®ç°è·å¾—shellçš„id\nu_int sys_get_ShellId(int *sysno*, u_int *envid*) { struct Env *e ; envid2env(*envid*, \u0026e, 0); return e-\u003eenv_parent_id; } å¾—åˆ°å½“å‰åœ°å€curpathï¼Œæ‹¼æ¥å¾—åˆ°å®Œæ•´åœ°å€\nå¯¹O_MKDIRè¿›è¡Œopen\nvoid mkdir(char *path, char *prefix) { char curpath[MAXPATHLEN] = {0}; // writef(\"mkdir :envidæ˜¯ %d shellidæ˜¯ %d\\n\", id, shellid); int r; //è·å–ç›¸åº”çš„id int id = syscall_getenvid(); int shellid = syscall_get_ShellId(syscall_get_ShellId(id)); if ((r = curpath_get(shellid, curpath) )\u003c 0) user_panic(\"mkdir: Error: curpath get\\n\"); //pathçš„æ‹¼æ¥ if (path[0] == '/') { strcat(curpath, path); } else { if (curpath[strlen(curpath) - 1] != '/') strcat(curpath, \"/\"); strcat(curpath, path); } //è°ƒç”¨open r = open(curpath, O_RDWR|O_MKDIR); if (r \u003c 0) user_panic(\"Directory %s created error\\n\", curpath); fwritef(1, \"%s created successfully\\n\", curpath); } touch\nç±»ä¼¼äºmkdirï¼Œåªä¸è¿‡æ˜¯opençš„æ—¶å€™ä½¿ç”¨O_CREATå‚æ•°ã€‚\nvoid touch(char *path, char *prefix) { char curpath[MAXPATHLEN] = {0}; int r; //è·å–ç›¸åº”çš„id int id=syscall_getenvid(); int shell_id = syscall_get_ShellId(syscall_get_ShellId(id)); if ((r= curpath_get(shell_id, curpath)) \u003c 0) { fwritef(1, \"mkdir: Error: get curpath\\n\"); return; } //pathæ‹¼æ¥ if (path[0] == '/') { strcpy(curpath, path); } else { if (curpath[strlen(curpath) - 1] != '/') strcat(curpath, \"/\"); strcat(curpath, path); } r = open(curpath, O_CREAT|O_RDWR); if (r \u003c 0) { fwritef(1, \"mkdir: Error: create file\\n\"); return; } fwritef(1, \"File %s created!\", curpath); } Normaléƒ¨åˆ† å†å²å‘½ä»¤åŠŸèƒ½ é¦–å…ˆåˆ›å»ºè¯»å–/å†™å…¥å†å²æ–‡ä»¶ API\nvoid history_init(); void history_save(char *s); int history_read(char(*cmd)[128]); åˆå§‹åŒ–å‡½æ•°\nvoid history_init() { int r; if ((r = open(\"/.history\", O_CREAT | O_RDWR)) \u003c 0) user_panic(\"His : Init Failed: %d.\", r); } å°†æ¯ä¸€ä¸ªè¾“å…¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œåˆ©ç”¨history_save()ä¿å­˜è¿›ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘åˆ›å»ºçš„æ˜¯.historyæ–‡ä»¶ï¼Œæ¯è¡Œå­˜æ”¾ä¸€æ¡æŒ‡ä»¤ã€‚\nvoid history_save(char *s) { int r; if ((r = open(\"/.history\", O_CREAT | O_RDWR | O_APPEND)) \u003c 0) { user_panic(\"His : Open failed\"); } fwritef(r, s); fwritef(r, \"\\n\"); close(r); } int history_read(char cmd[][128]) { int r, fd; char buf[128 * 128]; if ((fd = open(\"/.history\", O_RDONLY)) \u003c 0) { user_panic(\"His : Open failed\"); } if ((r = read(fd, buf, sizeof(buf))) \u003c 0) { user_panic(\"His : Read failed\"); } close(fd); int i = 0, cmdi = 0; while (buf[i]) { int cmdj = 0; while (buf[i] \u0026\u0026 buf[i] != '\\n') cmd[cmdi][cmdj++] = buf[i++]; if (!buf[i]) break; ++i; ++cmdi; } return cmdi; } é€šè¿‡ç¼–å†™ä¸€ä¸ªç”¨æˆ·æ€ç¨‹åº history.bæ–‡ä»¶å¹¶å†™å…¥ç£ç›˜ä¸­ï¼Œä½¿å¾—æ¯æ¬¡è°ƒç”¨history.b æ—¶ï¼Œèƒ½å¤Ÿå°†æ–‡ä»¶ï¼ˆ .history ï¼‰çš„å†…å®¹å…¨éƒ¨è¾“å‡ºã€‚åœ¨ user/history.c ä¸­ è¿›è¡Œè¯»å–/.historyæ–‡ä»¶\n#include \"lib.h\" void umain(int argc, char **argv) { if (argc != 1) { fwritef(1, \"usage: history\\n\"); return; } int his = open(\".history\", O_RDONLY | O_CREAT); char ch; fwritef(1, \"\\x1b[33m-*- HISTORY -*-\\x1b[0m\\n\"); fwritef(1, \"\\x1b[33m1\\x1b[0m\\t\"); int cnt = 1; int fl = 0; while (read(his, \u0026ch, 1) == 1) { if (fl) { fwritef(1, \"\\x1b[33m%d\\x1b[0m\\t\", cnt); fl = 0; } fwritef(1, \"%c\", ch); if (ch == '\\n') { cnt++; fl = 1; } } } æŒ‰é”®è¯†åˆ«ï¼Œé”®å…¥ä¸Šä¸‹é”®æ—¶ï¼Œåˆ‡æ¢å†å²å‘½ä»¤\nç»æŸ¥é˜…èµ„æ–™ï¼Œå…‰æ ‡é”®å¯¹åº”çš„å­—ç¬¦å¦‚ä¸‹ï¼š\næŒ‰é”® å¸¸è§„æ¨¡å¼ åº”ç”¨ç¨‹åºæ¨¡å¼ â†‘ ESC [ A ESC O A â†“ ESC [ B ESC O B æ­¥éª¤\nè·å–ç¼“å†²åŒºbuf[]åä¸‰ä¸ªå­—ç¬¦ æ•è·åˆ°åï¼ŒæŠµæ¶ˆå…‰æ ‡ç§»åŠ¨æ“ä½œ æ¸…ç©ºç¼“å†²åŒºï¼Œå°†å…‰æ ‡ç§»åˆ°å·¦ä¾§ æ‰“å°å‡ºç›¸åº”é¡ºåºçš„æŒ‡ä»¤ ä»£ç åˆ†æ\nif (i \u003e= 2 \u0026\u0026 buf[i - 2] == 27 \u0026\u0026 buf[i - 1] == 91 \u0026\u0026 buf[i] == 65) { writef(\"%c%c%c\", 27, 91, 65); for (i -= 2; i; --i) writef(\"\\b \\b\"); if (cmdi) strcpy(buf, cmds[--cmdi]); else strcpy(buf, cmds[cmdi]); writef(\"%s\", buf); i = strlen(buf) - 1; } else if (i \u003e= 2 \u0026\u0026 buf[i - 2] == 27 \u0026\u0026 buf[i - 1] == 91 \u0026\u0026 buf[i] == 66) { if (cmdi \u003c nn - 1) { for (i -= 2; i; --i) writef(\"\\b \\b\"); strcpy(buf, cmds[++cmdi]); writef(\"%s\", buf); } else { buf[i - 2] = buf[i - 1] = buf[i] = '\\0'; } i = strlen(buf) - 1; } Challengeéƒ¨åˆ† ç¯å¢ƒå˜é‡ åœ¨æœ¬éƒ¨åˆ†ï¼Œæˆ‘ä¸éƒ¨åˆ†åŒå­¦è¿›è¡Œäº†è¿›è¡Œäº†äº¤æµä¸æ¢è®¨ï¼Œæœ€ç»ˆç»“åˆåŠ©æ•™çš„æç¤ºä»¥åŠé—®é¢˜æè¿°ï¼Œå¾—åˆ°äº†ä¸‹é¢ä¸€ç§è¾ƒä¸ºæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚\né¦–å…ˆæˆ‘ä»¬éœ€è¦è‡ªå®šä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œæ¥è¡¨ç¤ºç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­éœ€è¦æœ‰è¿™äº›å±æ€§ï¼šç¯å¢ƒå˜é‡æ‹¥æœ‰è€…çš„idã€ç¯å¢ƒå˜é‡çš„åå­— ã€ç¯å¢ƒå˜é‡çš„å€¼ã€åªè¯»æ€§ã€å±€éƒ¨æ€§ã€æœ‰æ•ˆæ€§ï¼Œç„¶åå»ºç«‹ä¸€ä¸ªç¯å¢ƒå˜é‡è¡¨ï¼Œä»¥è¾¾åˆ°å¤šä¸ªç¨‹åºä½¿ç”¨çš„ç›®çš„\nstruct Var { int envid; //ç¯å¢ƒå˜é‡æ‹¥æœ‰è€…çš„id char name[64]; //ç¯å¢ƒå˜é‡çš„åå­— char val[128]; //ç¯å¢ƒå˜é‡çš„å€¼ int readonly; //åªè¯»æ€§ int local; //å±€éƒ¨æ€§ int ava; //æœ‰æ•ˆæ€§,ä¸º0ä»£è¡¨è¿˜æœªç”Ÿæ•ˆï¼Œå³ä¸å­˜åœ¨ï¼ˆç‹­ä¹‰ç†è§£ï¼‰ }; æ–°å¢ç³»ç»Ÿè°ƒç”¨,ä»¥å®ç°å¯¹ç¯å¢ƒå˜é‡çš„å¢åˆ æ”¹æŸ¥\nåœ¨lib/syscall.S:\n.word sys_get_var .word sys_set_var user/syscall_lib.c\nint syscall_get_var(u_int envid, char *name, char *val, int op) { return msyscall(SYS_get_var, envid, name, val, op, 0); } int syscall_set_var(u_int envid, char *name, char *val, int op, int perm) { return msyscall(SYS_set_var, envid, name, val, op, perm); } å¢ï¼šsyscall_set_var(op=0)â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªava=0çš„Varï¼Œå†™å…¥è¿™ä¸ªVar\nåˆ ï¼šsyscall_set_var(op=1)â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°nameå¯¹åº”çš„è¦åˆ é™¤çš„varï¼Œè®¾ç½®å…¶ava=0\næ”¹ï¼šsyscall_set_var(op=0)â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°nameå¯¹åº”çš„è¦ä¿®æ”¹çš„varï¼Œæ”¹ä¸ºå‚æ•°ä¸­çš„è¿™ä¸ªvar\næŸ¥ï¼šæŸ¥è¯¢ç‰¹å®šçš„æœ‰æ•ˆçš„ç¯å¢ƒå˜é‡/å…¨éƒ¨æœ‰æ•ˆçš„ç¯å¢ƒå˜é‡\nç‰¹å®šçš„ï¼šsyscall_get_var(op=0)â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°æ‰€æœ‰ava=1çš„ï¼Œä¸”åå­—ä¸æŸ¥è¯¢æ¡ä»¶ç›¸åŒçš„var å…¨éƒ¨çš„ï¼šsyscall_get_var(op=1)â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°æ‰€æœ‰ava=1çš„var å…·ä½“ä»£ç å®ç°ï¼Œå—é™äºç¯‡å¹…ï¼Œä¸å®Œæ•´è´´ä¸Šï¼Œéœ€è¦æ³¨æ„çš„å‡ ç‚¹\nè®¾ç½®setæ—¶çš„æƒé™ä½ VAR_LOCAL ï¼Œ VAR_RDONLY æ¥æ§åˆ¶è®¿é—®æƒé™,è®¾ç½®å¯¹åº”Varçš„localï¼Œreadonlyå˜é‡\næ–°å¢äº†é”™è¯¯ç±»å‹ E_VAR_NOT_FOUND , E_VAR_FULL , E_VAR_RDONLY\nåœ¨è¿›è¡Œåä¸‰è€…æ—¶ï¼Œè¦æ³¨æ„é¢å¤–åˆ¤æ–­å½“å‰ç»´æŠ¤å˜é‡æ˜¯å¦ä¸ºå±€éƒ¨çš„ä»¥åŠå…¶ä¸å½“å‰shellidçš„å…³ç³»ï¼Œå†™ä¸€ä¸ªç®€å•çš„å‡½æ•°è¿›è¡Œåˆ¤æ–­ã€‚\n//shellidé€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ å…¥ int judge(u_int shellid, struct Var *var) { if (var-\u003elocal == 0) { return 1; } else { if (shellid == var-\u003eenvid) { return 1; } else { return 0; } } } ä¸»è¦ä½¿ç”¨strcatï¼Œstrcmpï¼Œstrcpyè¿›è¡Œå­—ç¬¦ä¸²å¤„ç†ï¼Œæ¯”è¾ƒã€‚åˆ©ç”¨äº†æ¯”è¾ƒå‚»çš„forå¾ªç¯ã€‚\nç„¶åæ¯”å¦‚è¯´åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”nameï¼Œæ„å»ºäº†ä¸€ä¸ªå°å‡½æ•°ï¼Œæ–¹ä¾¿åˆ¤æ–­\nint contain_name(char *name) { int i = 0; for (i = 0; i \u003c NVARS; i++) { struct Var *v = \u0026vars[i]; if (v-\u003eava \u0026\u0026 strcmp(v-\u003ename, *name*) == 0) { return 1; } } return 0; } æ³¨æ„æƒé™ä½çš„è®¾ç½®\ndeclare\nåœ¨umainä¸­ï¼Œè®¾ç½®flag,ä»¥åŠperm\nvoid umain(int argc, char **argv) { int i; ARGBEGIN { default: usage(); case 'r': flag[(u_char) ARGC()]++; case 'x': flag[(u_char) ARGC()]++; break; } ARGEND int perm = 0; if (flag['r']) { perm |= VAR_RDONLY; } if (flag['x']) { perm |= VAR_LOCAL; } char *arg2 = argv[1]; while(*arg2 == '=') { arg2++; } if (argc == 0) declare_nothing(); else if (argc == 1) set(argv[0], \"\", perm); else if (argc == 2) set(argv[0], arg2, perm); else writef(1, \"too many args\"); //writef(\"declare ok**\"); } åœ¨setå‡½æ•°ä¸­è°ƒç”¨å‰è¿°æ‰€å†™ç³»ç»Ÿè°ƒç”¨ï¼Œå®ç°declareï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æƒé™ä½çš„è®¾å®šï¼Œä»¥åŠä¼ å…¥å‚æ•°\nvoid set(char *name, char *value, int perm) { int r; int shellid = syscall_get_ShellId(syscall_get_ShellId(syscall_getenvid())); if ((r = syscall_set_var(shellid, name, value, 0, perm)) \u003c 0) { if (r == -E_VAR_FULL) fwritef(1, \"declare: vars are full\\n\", name); if (r == -E_VAR_RDONLY) fwritef(1, \"declare: [%s] is readonly\\n\", name); return; } } echo\nåœ¨å®ç°echoçš„æ—¶å€™ï¼Œåœ¨umainè§£æçš„æ—¶å€™ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹\nvoid umain(int argc, char **argv) { int i, nflag; nflag = 0; if (argc \u003e 1 \u0026\u0026 strcmp(argv[1], \"-n\") == 0) { nflag = 1; argc--; argv++; } for (i = 1; i \u003c argc; i++) { if (i \u003e 1) write(1, \" \", 1); if (argv[i][0] == '$') { char value[128]; syscall_env_var(\u0026argv[i][1], value, 1); write(1, value, strlen(value)); } else { write(1, argv[i], strlen(argv[i])); } } if (!nflag) write(1, \"\\n\", 1); } unset\nåœ¨unset.c ä¸­ï¼Œ ç›´æ¥è°ƒç”¨syscall_set_var å³å¯.\nå…¶ä»–æ”¯æŒæˆ–è€…å‰ç½®æ¡ä»¶ ï¼ˆ1ï¼‰clearæ¸…å± #define CLEAR() printf(\"\\033[2J\") ï¼ˆ2ï¼‰å½©è‰²è¾“å‡º å®šä¹‰åœ¨sh.hä¸­\nç”¨ç±»ä¼¼äº\\033[32m å®ç°ç»¿è‰²è¾“å‡ºï¼Œç±»ä¼¼å¯ä»¥å®ç°å…¶ä»–é¢œè‰²çš„è¾“å‡ºã€‚\nç”¨ \\033[1m å¯ä»¥å®ç°åŠ ç²—æ•ˆæœã€‚\nç”¨ \\033[m è¡¨ç¤ºé¢œè‰²è¾“å‡ºç»“æŸã€‚\nï¼ˆ3ï¼‰cdå‘½ä»¤ åˆ©ç”¨ç¯å¢ƒå˜é‡ç»´æŠ¤curpath(å½“å‰è·¯å¾„)ï¼Œåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨å¯ä»¥è·å–å’Œè®¾ç½®å½“å‰è·¯å¾„ï¼Œå¹¶å°è£…ä¸€å¥— APIï¼›\nvoid curpath_init(int envid,char *path); int curpath_get(int envid,char *path); int curpath_set(int envid,char *path); int curpath_get_parent(int envid,char *path); å½“ä½¿ç”¨âˆ¶\ncd.âˆ¶ä¸æ”¹å˜è·¯å¾„\ncd ..âˆ¶è¿”å›ä¸Šä¸€çº§ç›®å½•ï¼ˆè‹¥ä¸ºæ ¹ç›®å½•ï¼Œåˆ™ä¸å†è¿”å›ï¼‰\ncd folder âˆ¶è¿›å…¥ç›®å½•æ—¶\nå¯¹æ‰€æœ‰çš„å‘½ä»¤éƒ½é‡å†™ï¼ŒåŠ å…¥ curpath çš„è·å–ã€‚å¦‚æœä¼ å…¥çš„å‘½ä»¤æ˜¯ä¸€ä¸ªä»¥ /å¼€å¤´çš„è·¯å¾„ï¼Œåˆ™ä¸ºç»å¯¹è·¯å¾„;å¦åˆ™ä¸ºç›¸å¯¹è·¯å¾„ã€‚\nint i, r; int path[256]; int faid = syscall_get_ShellId(syscall_get_ShellId(syscall_getenvid())); if (argc == 1) { fwritef(1, \"cd: too few args\\n\"); return; } else { for (i = 1; i \u003c argc; i++) { //æ˜¾ç¤ºå½“å‰ç›®å½• if (strcmp(argv[i], \".\") == 0) return; //ä¸Šä¸€çº§ç›®å½• if (strcmp(argv[i], \"..\") == 0) { curpath_get_parent(faid, path); curpath_set(faid, path); fwritef(1, \"cd(now_path): %s\", path); return; } else //è¿›å…¥æŸä¸€ä¸ªç›®å½• { if ((r = curpath_get(faid, path)) \u003c 0) { fwritef(1, \"cd: get environment var failed\"); return; } strcat(path, argv[i]); int len = strlen(path); if (path[len - 1] != '/') strcat(path, \"/\"); struct Stat st; r = stat(path, \u0026st); if (r == -E_VAR_NOT_FOUND) fwritef(1, \"cd: %s not found\\n\", path); else if (r \u003c 0) fwritef(1, \"cd: cannot cd %s\\n\", path); else if (!st.st_isdir) fwritef(1, \"cd: %s is not directory\\n\", path); else { if ((r = curpath_set(faid, path)) \u003c 0) fwritef(1, \"Environment var not found\"); fwritef(1, \"curpath: %s\", path); } return; } } } ï¼ˆ4ï¼‰rmå‘½ä»¤ //ç±»ä¼¼äºåˆ›å»ºæ–‡ä»¶ï¼Œæœ‰å°æ”¹åŠ¨ if ((r = remove(curpath)) \u003c 0) { fwritef(1, \"File %s Not Exists!\\n\", curpath); return; } ï¼ˆ5ï¼‰openä¿®æ”¹ åœ¨open()ä¸­ï¼Œé¦–å…ˆéœ€è¦åŠ å…¥APPEND,MKDIR,CREATä»£ç ã€‚\n#define O_APPEND 0x1000\nuser/file.cä¸­çš„open() ä¸­åŠ å…¥O_APPENDæ‰“å¼€æ–¹å¼æ‰©å……ä»£ç \nif ((mode \u0026 O_APPEND) != 0) { ffd-\u003ef_fd.fd_offset = size; } fs/serv.cä¸­çš„serve_open()ä¸­åŠ å…¥CREAT, MKDIRæ‰“å¼€æ–¹å¼æ‰©å…….\nif ((r = file_open((char *) path, \u0026f)) \u003c 0) { if (r == -E_NOT_FOUND \u0026\u0026 (rq-\u003ereq_omode \u0026 O_CREAT)) { if ((r = file_create((char *)path, \u0026f)) \u003c 0) { return; } f-\u003ef_type = FTYPE_REG; } else if (r == -E_NOT_FOUND \u0026\u0026 (rq-\u003ereq_omode \u0026 O_MKDIR)) { if ((r = file_create((char *)path, \u0026f)) \u003c 0) { return; } f-\u003ef_type = FTYPE_DIR; } else { ipc_send(envid, r, 0, 0); return; } } ï¼ˆ6ï¼‰ç¯å¢ƒå˜é‡çš„è·å–ï¼Œå½“å‰åœ°å€çš„æ“ä½œ void curpath_init(int envid, char *path) { int r; // set op 0 declare with perm if ((r = syscall_set_var(envid, CURPATH_KEY, path, 0, 0)) \u003c 0) user_panic(\"Init curpath failed: %u.\", r); return ; } int curpath_get(int envid, char *path) { int r; //op1 get one //writef(\"get from env : %d\", envid); if ((r = syscall_get_var(envid, CURPATH_KEY, path, 1)) \u003c 0) return r; return 0; } int curpath_set(int envid, char *path) { int r; // op0 declare with perm if ((r = syscall_set_var(envid, CURPATH_KEY, path, 0, 0)) \u003c 0) return r; return r; } int curpath_get_parent(int envid, char *path) { int r, i; if ((r = curpath_get(envid, path)) \u003c 0) return r; if (strlen(path) == 1) return 0; for (i = strlen(path) - 2; path[i - 1] != '/'; i--); path[i] = 0; return r; } å®éªŒéš¾ç‚¹åŠæ€»ç»“ åœ¨æœ¬å®éªŒä¸­ï¼Œæˆ‘é€šè¿‡ç¼–å†™æ–°å‡½æ•°ï¼Œæ–°çš„æ–¹æ³•å®ç°ä¸€äº›å°ç»„ä»¶ä»¥åŠé™„åŠ åŠŸèƒ½ï¼Œä¸°å¯Œäº†æˆ‘ä»¬çš„ shellçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬\"åå°è¿è¡Œâ€ï¼Œâ€œä¸€è¡Œå¤šå‘½ä»¤â€ï¼Œâ€œç®€å•å¼•å·æ”¯æŒâ€ï¼Œâ€œtree /mkdir /touch å‘½ä»¤â€ï¼Œâ€œæ¸…å±â€ï¼Œâ€œå½©è‰²è¾“å‡ºâ€ï¼Œâ€œå†å²å‘½ä»¤â€ï¼Œâ€œç¯å¢ƒå˜é‡â€ï¼Œâ€œcd å‘½ä»¤\"ç­‰ä»»åŠ¡ã€‚\næˆ‘è®¤ä¸ºå®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äº\nä¿®æ”¹è‹¥å¹²çš„æŒ‡ä»¤ï¼Œä½¿ä¹‹æˆä¸ºå†…ç½®çš„æŒ‡ä»¤ åœ¨å†å²å‘½ä»¤ä¸­ï¼Œå¦‚ä½•å®ç°è¯†åˆ«é”®ä½ï¼ˆé€šè¿‡æŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼‰ï¼Œå¦‚ä½•å®ç°å†å²å‘½ä»¤ä¿å­˜ï¼Œè¾“å‡º ä»¥åŠåœ¨challengeéƒ¨åˆ†çš„ç¯å¢ƒå˜é‡çš„å®ç°ï¼ˆæ–°å®šä¹‰ç»“æ„ä½“ï¼Œå¹¶ä¸”ä¹¦å†™ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥åŠå¢åŠ ç›¸åº”çš„openï¼ˆï¼‰å‚æ•°ï¼Œé”™è¯¯ç ï¼Œå¹¶åŠ ä»¥åˆç†è¿ç”¨ï¼‰ ä¸€äº›å­—ç¬¦ä¸²å¤„ç†æ–¹æ³•çš„ä½¿ç”¨ï¼Œä»¥åŠå„ä¸ªç»†èŠ‚çš„æ³¨æ„ä»¥åŠé€ä¸ªå‡»ç ´ã€‚ ç»ˆäºåº¦è¿‡äº†éš¾æ±çš„ä¸€å­¦æœŸå­¦ä¹ ï¼Œåœ¨åšå®Œäº†lab6æŒ‘æˆ˜æ€§ä»»åŠ¡ä»¥åï¼Œæˆ‘å¯¹osçš„å­¦ä¹ ä½“ä¼šæœ‰äº†è¿›ä¸€æ­¥çš„å‡åï¼Œä¹Ÿå¯¹è¯¾ç¨‹å†…å®¹æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ï¼Œæ„Ÿè°¢osè¯¾ç¨‹ç»„å¯¹æˆ‘ä»¬çš„ç£¨ç»ƒä»¥åŠæå‡ï¼\n",
  "wordCount" : "4641",
  "inLanguage": "en",
  "image":"https://mksasx.github.io/posts/tech/os/great.png","datePublished": "2022-10-09T16:31:30+08:00",
  "dateModified": "2022-10-09T16:31:30+08:00",
  "author":[{
    "@type": "Person",
    "name": "AustinMa"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mksasx.github.io/posts/tech/os/great/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AustinMa's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mksasx.github.io/img/1.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mksasx.github.io/" accesskey="h" title="AustinMa&#39;s Blog (Alt + H)">
            <img src="https://mksasx.github.io/img/Avator.jpg" alt="logo" aria-label="logo"
                 height="35">AustinMa&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mksasx.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs" style="margin-bottom: 5px;"><a href="https://mksasx.github.io/">ğŸ ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://mksasx.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://mksasx.github.io/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a>&nbsp;Â»&nbsp;<a href="https://mksasx.github.io/posts/tech/os/">âš›ï¸ æ“ä½œç³»ç»Ÿ</a></div>
            <h1 class="post-title">
                æ“ä½œç³»ç»Ÿç”³ä¼˜æ–‡æ¡£
            </h1>
            <div class="post-description">
                è¿™æ˜¯æˆ‘çš„æ“ä½œç³»ç»Ÿè¯¾ç¨‹ç”³ä¼˜æ–‡æ¡£
            </div>
            <div class="post-meta">åˆ›å»º:&nbsp;<span title='2022-10-09 16:31:30 +0800 CST'>2022-10-09</span>&nbsp;|&nbsp;æ›´æ–°:&nbsp;2022-10-09&nbsp;|&nbsp;å­—æ•°:&nbsp;4641å­—&nbsp;|&nbsp;æ—¶é•¿:&nbsp;10åˆ†é’Ÿ&nbsp;|&nbsp;
ä½œè€…:&nbsp;AustinMa



                &nbsp;|&nbsp;æ ‡ç­¾: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://mksasx.github.io/tags/os/">os</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| è®¿é—®: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://mksasx.github.io/posts/tech/os/great.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#lab6-challenge-%e5%ae%9e%e9%aa%8c%e6%8a%a5%e5%91%8a" aria-label="Lab6-Challenge å®éªŒæŠ¥å‘Š">Lab6-Challenge å®éªŒæŠ¥å‘Š</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e6%a6%82%e8%bf%b0" aria-label="å®éªŒæ¦‚è¿°">å®éªŒæ¦‚è¿°</a></li>
                <li>
                    <a href="#%e5%90%84%e9%83%a8%e5%88%86%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af%e5%8f%8a%e4%bb%a3%e7%a0%81" aria-label="å„éƒ¨åˆ†å®ç°æ€è·¯åŠä»£ç ">å„éƒ¨åˆ†å®ç°æ€è·¯åŠä»£ç </a><ul>
                        
                <li>
                    <a href="#easy%e9%83%a8%e5%88%86" aria-label="Easyéƒ¨åˆ†">Easyéƒ¨åˆ†</a><ul>
                        
                <li>
                    <a href="#1%e5%ae%9e%e7%8e%b0%e5%90%8e%e5%8f%b0%e8%bf%90%e8%a1%8c" aria-label="ï¼ˆ1ï¼‰å®ç°åå°è¿è¡Œ">ï¼ˆ1ï¼‰å®ç°åå°è¿è¡Œ</a></li>
                <li>
                    <a href="#2%e4%b8%80%e8%a1%8c%e5%a4%9a%e5%91%bd%e4%bb%a4" aria-label="ï¼ˆ2ï¼‰ä¸€è¡Œå¤šå‘½ä»¤">ï¼ˆ2ï¼‰ä¸€è¡Œå¤šå‘½ä»¤</a></li>
                <li>
                    <a href="#3%e5%bc%95%e5%8f%b7%e6%94%af%e6%8c%81" aria-label="ï¼ˆ3ï¼‰å¼•å·æ”¯æŒ">ï¼ˆ3ï¼‰å¼•å·æ”¯æŒ</a></li>
                <li>
                    <a href="#4tree--mkdir-touch" aria-label="ï¼ˆ4ï¼‰tree / mkdir /touch">ï¼ˆ4ï¼‰tree / mkdir /touch</a></li></ul>
                </li>
                <li>
                    <a href="#normal%e9%83%a8%e5%88%86" aria-label="Normaléƒ¨åˆ†">Normaléƒ¨åˆ†</a><ul>
                        
                <li>
                    <a href="#%e5%8e%86%e5%8f%b2%e5%91%bd%e4%bb%a4%e5%8a%9f%e8%83%bd" aria-label="å†å²å‘½ä»¤åŠŸèƒ½">å†å²å‘½ä»¤åŠŸèƒ½</a></li></ul>
                </li>
                <li>
                    <a href="#challenge%e9%83%a8%e5%88%86" aria-label="Challengeéƒ¨åˆ†">Challengeéƒ¨åˆ†</a><ul>
                        
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" aria-label="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%85%b6%e4%bb%96%e6%94%af%e6%8c%81%e6%88%96%e8%80%85%e5%89%8d%e7%bd%ae%e6%9d%a1%e4%bb%b6" aria-label="å…¶ä»–æ”¯æŒæˆ–è€…å‰ç½®æ¡ä»¶">å…¶ä»–æ”¯æŒæˆ–è€…å‰ç½®æ¡ä»¶</a><ul>
                        
                <li>
                    <a href="#1clear%e6%b8%85%e5%b1%8f" aria-label="ï¼ˆ1ï¼‰clearæ¸…å±">ï¼ˆ1ï¼‰clearæ¸…å±</a></li>
                <li>
                    <a href="#2%e5%bd%a9%e8%89%b2%e8%be%93%e5%87%ba" aria-label="ï¼ˆ2ï¼‰å½©è‰²è¾“å‡º">ï¼ˆ2ï¼‰å½©è‰²è¾“å‡º</a></li>
                <li>
                    <a href="#3cd%e5%91%bd%e4%bb%a4" aria-label="ï¼ˆ3ï¼‰cdå‘½ä»¤">ï¼ˆ3ï¼‰cdå‘½ä»¤</a></li>
                <li>
                    <a href="#4rm%e5%91%bd%e4%bb%a4" aria-label="ï¼ˆ4ï¼‰rmå‘½ä»¤">ï¼ˆ4ï¼‰rmå‘½ä»¤</a></li>
                <li>
                    <a href="#5open%e4%bf%ae%e6%94%b9" aria-label="ï¼ˆ5ï¼‰openä¿®æ”¹">ï¼ˆ5ï¼‰openä¿®æ”¹</a></li>
                <li>
                    <a href="#6%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e7%9a%84%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e5%9c%b0%e5%9d%80%e7%9a%84%e6%93%8d%e4%bd%9c" aria-label="ï¼ˆ6ï¼‰ç¯å¢ƒå˜é‡çš„è·å–ï¼Œå½“å‰åœ°å€çš„æ“ä½œ">ï¼ˆ6ï¼‰ç¯å¢ƒå˜é‡çš„è·å–ï¼Œå½“å‰åœ°å€çš„æ“ä½œ</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e9%9a%be%e7%82%b9%e5%8f%8a%e6%80%bb%e7%bb%93" aria-label="å®éªŒéš¾ç‚¹åŠæ€»ç»“">å®éªŒéš¾ç‚¹åŠæ€»ç»“</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="lab6-challenge-å®éªŒæŠ¥å‘Š">Lab6-Challenge å®éªŒæŠ¥å‘Š<a hidden class="anchor" aria-hidden="true" href="#lab6-challenge-å®éªŒæŠ¥å‘Š">#</a></h1>
<h2 id="å®éªŒæ¦‚è¿°">å®éªŒæ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#å®éªŒæ¦‚è¿°">#</a></h2>
<p>åœ¨æœ¬å®éªŒä¸­ï¼Œæˆ‘é€šè¿‡ç¼–å†™æ–°å‡½æ•°ï¼Œæ–°çš„æ–¹æ³•å®ç°ä¸€äº›å°ç»„ä»¶ä»¥åŠé™„åŠ åŠŸèƒ½ï¼Œä¸°å¯Œäº†æˆ‘ä»¬çš„ shellçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬&quot;åå°è¿è¡Œ&quot;ï¼Œ&ldquo;ä¸€è¡Œå¤šå‘½ä»¤&rdquo;ï¼Œ&ldquo;ç®€å•å¼•å·æ”¯æŒ&rdquo;ï¼Œ&ldquo;tree /mkdir /touch å‘½ä»¤&rdquo;ï¼Œ&ldquo;æ¸…å±&rdquo;ï¼Œ&ldquo;å½©è‰²è¾“å‡º&rdquo;ï¼Œ&ldquo;å†å²å‘½ä»¤&rdquo;ï¼Œ&ldquo;ç¯å¢ƒå˜é‡&rdquo;ï¼Œ&ldquo;cd å‘½ä»¤&quot;ç­‰ä»»åŠ¡ã€‚</p>
<h2 id="å„éƒ¨åˆ†å®ç°æ€è·¯åŠä»£ç ">å„éƒ¨åˆ†å®ç°æ€è·¯åŠä»£ç <a hidden class="anchor" aria-hidden="true" href="#å„éƒ¨åˆ†å®ç°æ€è·¯åŠä»£ç ">#</a></h2>
<h3 id="easyéƒ¨åˆ†">Easyéƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#easyéƒ¨åˆ†">#</a></h3>
<h4 id="1å®ç°åå°è¿è¡Œ">ï¼ˆ1ï¼‰å®ç°åå°è¿è¡Œ<a hidden class="anchor" aria-hidden="true" href="#1å®ç°åå°è¿è¡Œ">#</a></h4>
<p><strong>1ã€é¦–å…ˆåœ¨getc.Sä¸­ï¼Œä¿®æ”¹æ±‡ç¼–ä»£ç ï¼Œä»¥é˜²æ­¢å‰å°è¢«é˜»å¡ï¼Œæ‰‹åŠ¨å¿½ç•¥è¾“å…¥ã€‚</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>LEAF(sys_cgetc)
</span></span><span style="display:flex;"><span>1:  lb  t0, 0x90000000
</span></span><span style="display:flex;"><span>  //beqz   t0, 1b
</span></span><span style="display:flex;"><span>  //nop
</span></span><span style="display:flex;"><span>  move   v0,t0
</span></span><span style="display:flex;"><span>  jr  ra
</span></span><span style="display:flex;"><span>  nop
</span></span><span style="display:flex;"><span>END(sys_cgetc) 
</span></span></code></pre></div><p><strong>2ã€ä¿®æ”¹shell</strong></p>
<p>åœ¨<code>sh.c</code>ä¸­<code>runcmd()</code>å®šä¹‰ä¸€ä¸ªå˜é‡ hang æ ‡è®°æ˜¯å¦è¦åå°è¿è¡Œï¼Œåˆå§‹åŒ–ä¸º0ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;&amp;&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	hang <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">break</span>;
</span></span></code></pre></div><p>åœ¨è¿è¡Œå‘½ä»¤çš„æ—¶å€™ï¼Œè‹¥æ— &amp;ï¼Œæ­£å¸¸ç­‰å¾…ç¨‹åºè¿è¡Œç»“æŸï¼Œè‹¥æœ‰&amp;ï¼Œé‚£ä¹ˆå°±è°ƒç”¨<code>fork()</code>ç”Ÿæˆå­è¿›ç¨‹ï¼ŒåŒæ—¶è¦é˜²æ­¢é˜»å¡ï¼Œå¹¶ä¸”åœ¨ç¨‹åºè¿è¡Œç»“æŸåï¼Œè¾“å‡ºæç¤ºä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//æ— &amp;ï¼Œå°±ç­‰è¿›ç¨‹ç»“æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hang)
</span></span><span style="display:flex;"><span>       wait(r); 
</span></span><span style="display:flex;"><span><span style="color:#75715e">//æœ‰&amp;ï¼Œå°±forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œç­‰å¾…æ–°åŠ è½½çš„ç¨‹åºè¿è¡Œå®Œæˆï¼Œè¾“å‡ºæç¤ºä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>       pid <span style="color:#f92672">=</span> fork();
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">//åˆ›å»ºcmdå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       {
</span></span><span style="display:flex;"><span>           wait(r); <span style="color:#75715e">//ç­‰å¾…æ–°åŠ è½½çš„ç¨‹åºè¿è¡Œå®Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>           writef(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[%d] DONE</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, r);<span style="color:#75715e">//æç¤ºä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>           <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> argc; <span style="color:#f92672">++</span>i)
</span></span><span style="display:flex;"><span>           writef(<span style="color:#e6db74">&#34;%s &#34;</span>, argv[i]);
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">char</span> curpath[MAXPATHLEN];
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> envid <span style="color:#f92672">=</span> syscall_getenvid();
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> shellid <span style="color:#f92672">=</span> syscall_getfaid(envid);
</span></span><span style="display:flex;"><span>           curpath_get(shellid, curpath);
</span></span><span style="display:flex;"><span>           writef(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> LIGHT_BLUE(<span style="color:#f92672">%</span> s) <span style="color:#e6db74">&#34; &#34;</span> BOLD_GREEN(<span style="color:#960050;background-color:#1e0010">$</span>) <span style="color:#e6db74">&#34; &#34;</span>, curpath);
</span></span><span style="display:flex;"><span>           writef(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>           exit();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2ä¸€è¡Œå¤šå‘½ä»¤">ï¼ˆ2ï¼‰ä¸€è¡Œå¤šå‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#2ä¸€è¡Œå¤šå‘½ä»¤">#</a></h4>
<p>ä½¿ç”¨ fork åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œå·²ç»è¯†åˆ«çš„å‘½ä»¤ï¼Œcmdè¿›ç¨‹åˆ™ç»§ç»­è§£æä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤è¿è¡Œå‰ï¼Œéƒ½éœ€è¦å¯¹ç›¸åº”çš„çŠ¶æ€å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶ååä¸€æ¡æŒ‡ä»¤åœ¨å­è¿›ç¨‹è¿è¡Œç»“æŸåï¼Œå†è¿›è¡Œè¿è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;;&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((pid <span style="color:#f92672">=</span> fork()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">//åˆ›å»ºå­è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> runit;  
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    wait(pid);<span style="color:#75715e">//ç­‰å¾…å­è¿›ç¨‹è¿è¡Œç»“æŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//å‚æ•°é‡æ–°åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    argc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    hang <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    rightpipe <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//çˆ¶è¿›ç¨‹è·³å‡ºswitchï¼Œ ç»§ç»­è§£æä¸‹ä¸€ä¸ªå‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    file_input <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;  
</span></span><span style="display:flex;"><span>    file_output <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span></code></pre></div><h4 id="3å¼•å·æ”¯æŒ">ï¼ˆ3ï¼‰å¼•å·æ”¯æŒ<a hidden class="anchor" aria-hidden="true" href="#3å¼•å·æ”¯æŒ">#</a></h4>
<p>ä¿®æ”¹ token çš„éƒ¨åˆ†ï¼Œè¯†åˆ«åˆ°å¼•å·çš„æ—¶å€™ä¸€ç›´ç»§ç»­è¯»ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå¼•å·ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>s <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>p1 <span style="color:#f92672">=</span> <span style="color:#f92672">++</span>s;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">*</span>s <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(<span style="color:#f92672">*</span>s <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\&#34;&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">*</span>(s <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\\&#39;</span>))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>s;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>s<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>p2 <span style="color:#f92672">=</span> s;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;w&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="4tree--mkdir-touch">ï¼ˆ4ï¼‰tree / mkdir /touch<a hidden class="anchor" aria-hidden="true" href="#4tree--mkdir-touch">#</a></h4>
<ul>
<li>
<p><strong>tree</strong></p>
<p>ä¸»å‡½æ•°<code>tree()</code>é€šè¿‡å‚æ•°çš„è§£ææ¥è°ƒç”¨<code>walk()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tree</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>prefix) {    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> Stat status;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r <span style="color:#f92672">=</span> stat(path, <span style="color:#f92672">&amp;</span>status); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (r <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) user_panic(<span style="color:#e6db74">&#34;stat %s: %e&#34;</span>, path, r);
</span></span><span style="display:flex;"><span>    walk(path, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>walk()</code>å‡½æ•°å®ç°å†…éƒ¨çš„é€’å½’è°ƒç”¨,ä¼ å…¥è·¯å¾„å’Œå±‚çº§æ•°é‡,éå†æ–‡ä»¶ã€‚å¯¹äºåµŒå¥—çš„ç›®å½•ï¼Œä½¿ç”¨é€’å½’çš„æ–¹å¼éå†ã€‚</p>
<p>è¾“å‡ºæ—¶å€ŸåŠ©äºå±‚çº§æ•°é‡æ¥æ ¼å¼åŒ–è¾“å‡ºç»“æœã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">walk</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">int</span> len) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> dir_fd; 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> File f;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i; 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> newpath[MAXPATHLEN] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>}; 
</span></span><span style="display:flex;"><span>  dir_fd <span style="color:#f92672">=</span> open(path, O_RDONLY); 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (dir_fd <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) user_panic(<span style="color:#e6db74">&#34;failed: open %s: %e&#34;</span>, <span style="color:#f92672">*</span>path<span style="color:#f92672">*</span>, dir_fd);  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (readn(dir_fd, <span style="color:#f92672">&amp;</span>f, <span style="color:#66d9ef">sizeof</span> (<span style="color:#66d9ef">struct</span> File)) <span style="color:#f92672">==</span> <span style="color:#66d9ef">sizeof</span> (<span style="color:#66d9ef">struct</span> File)) 
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>   	<span style="color:#66d9ef">if</span> (f.f_name[<span style="color:#ae81ff">0</span>]) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> File <span style="color:#f92672">*</span>dir <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>f;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//æ ¼å¼åŒ–è¾“å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>      fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);  
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>; i<span style="color:#f92672">++</span>) fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>      fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;|-- &#34;</span>); 
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// è¾“å‡ºå½“å‰æ–‡ä»¶æˆ–ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (dir<span style="color:#f92672">-&gt;</span>f_type <span style="color:#f92672">==</span> FTYPE_REG) {
</span></span><span style="display:flex;"><span>        fwritef(<span style="color:#ae81ff">1</span>, YELLOW(<span style="color:#f92672">%</span>s), dir<span style="color:#f92672">-&gt;</span>f_name); 
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//é€’å½’è¾“å‡ºå­ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (dir<span style="color:#f92672">-&gt;</span>f_type <span style="color:#f92672">==</span> FTYPE_DIR) {
</span></span><span style="display:flex;"><span>        fwritef(<span style="color:#ae81ff">1</span>, PURPLE(<span style="color:#f92672">%</span>s), dir<span style="color:#f92672">-&gt;</span>f_name); 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//æ‹¼æ¥å­ç›®å½•è·¯å¾„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        strcat(newpath, path);        
</span></span><span style="display:flex;"><span>		strcat(newpath, dir<span style="color:#f92672">-&gt;</span>f_name); 
</span></span><span style="display:flex;"><span>        strcat(newpath, <span style="color:#e6db74">&#34;/&#34;</span>); 
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// writef(&#34;nxtpath:\n%s&#34;, npath);*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        walk(newpath, len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>mkdir</strong></p>
<ul>
<li>
<p>ä¸ºäº†ç®€åŒ–æ“ä½œï¼Œå®ç°åç»­mkdirï¼Œå¢åŠ ç³»ç»Ÿè°ƒç”¨æ¥å®ç°è·å¾—shellçš„id</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>u_int <span style="color:#a6e22e">sys_get_ShellId</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>sysno<span style="color:#f92672">*</span>, u_int <span style="color:#f92672">*</span>envid<span style="color:#f92672">*</span>) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> Env <span style="color:#f92672">*</span>e ; 
</span></span><span style="display:flex;"><span>  envid2env(<span style="color:#f92672">*</span>envid<span style="color:#f92672">*</span>, <span style="color:#f92672">&amp;</span>e, <span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> e<span style="color:#f92672">-&gt;</span>env_parent_id; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>å¾—åˆ°å½“å‰åœ°å€curpathï¼Œæ‹¼æ¥å¾—åˆ°å®Œæ•´åœ°å€</p>
</li>
<li>
<p>å¯¹O_MKDIRè¿›è¡Œopen</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mkdir</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>prefix) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> curpath[MAXPATHLEN] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// writef(&#34;mkdir :envidæ˜¯ %d shellidæ˜¯ %d\n&#34;, id, shellid); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> r; 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//è·å–ç›¸åº”çš„id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> id <span style="color:#f92672">=</span> syscall_getenvid(); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> shellid <span style="color:#f92672">=</span> syscall_get_ShellId(syscall_get_ShellId(id)); 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> curpath_get(shellid, curpath) )<span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) user_panic(<span style="color:#e6db74">&#34;mkdir: Error: curpath get</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//pathçš„æ‹¼æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (path[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span>) {
</span></span><span style="display:flex;"><span>		strcat(curpath, path); 
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (curpath[strlen(curpath) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>            strcat(curpath, <span style="color:#e6db74">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>        strcat(curpath, path);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//è°ƒç”¨open
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	r <span style="color:#f92672">=</span> open(curpath, O_RDWR<span style="color:#f92672">|</span>O_MKDIR); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (r <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) user_panic(<span style="color:#e6db74">&#34;Directory %s created error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, curpath); 
</span></span><span style="display:flex;"><span>	fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;%s created successfully</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, curpath);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>touch</strong></p>
<p>ç±»ä¼¼äºmkdirï¼Œåªä¸è¿‡æ˜¯opençš„æ—¶å€™ä½¿ç”¨O_CREATå‚æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">touch</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>prefix) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> curpath[MAXPATHLEN] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>}; 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> r;  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//è·å–ç›¸åº”çš„id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> id<span style="color:#f92672">=</span>syscall_getenvid();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> shell_id <span style="color:#f92672">=</span> syscall_get_ShellId(syscall_get_ShellId(id));  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ((r<span style="color:#f92672">=</span> curpath_get(shell_id, curpath)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;mkdir: Error: get curpath</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>; 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//pathæ‹¼æ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (path[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span>) {
</span></span><span style="display:flex;"><span>		strcpy(curpath, path);  		
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (curpath[strlen(curpath) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>			strcat(curpath, <span style="color:#e6db74">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>		strcat(curpath, path); 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	r <span style="color:#f92672">=</span> open(curpath, O_CREAT<span style="color:#f92672">|</span>O_RDWR); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (r <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;mkdir: Error: create file</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>); 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>; 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;File %s created!&#34;</span>, curpath);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="normaléƒ¨åˆ†">Normaléƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#normaléƒ¨åˆ†">#</a></h3>
<h4 id="å†å²å‘½ä»¤åŠŸèƒ½">å†å²å‘½ä»¤åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#å†å²å‘½ä»¤åŠŸèƒ½">#</a></h4>
<ol>
<li>
<p><strong>é¦–å…ˆåˆ›å»ºè¯»å–/å†™å…¥å†å²æ–‡ä»¶ API</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">history_init</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">history_save</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">history_read</span>(<span style="color:#66d9ef">char</span>(<span style="color:#f92672">*</span>cmd)[<span style="color:#ae81ff">128</span>]);
</span></span></code></pre></div><p><strong>åˆå§‹åŒ–å‡½æ•°</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">history_init</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/.history&#34;</span>, O_CREAT <span style="color:#f92672">|</span> O_RDWR)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        user_panic(<span style="color:#e6db74">&#34;His : Init Failed: %d.&#34;</span>, r);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>å°†æ¯ä¸€ä¸ªè¾“å…¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œåˆ©ç”¨<code>history_save()</code>ä¿å­˜è¿›ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘åˆ›å»ºçš„æ˜¯<code>.history</code>æ–‡ä»¶ï¼Œæ¯è¡Œå­˜æ”¾ä¸€æ¡æŒ‡ä»¤ã€‚</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">history_save</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/.history&#34;</span>, O_CREAT <span style="color:#f92672">|</span> O_RDWR <span style="color:#f92672">|</span> O_APPEND)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        user_panic(<span style="color:#e6db74">&#34;His : Open failed&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    fwritef(r, s);
</span></span><span style="display:flex;"><span>    fwritef(r, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    close(r);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">history_read</span>(<span style="color:#66d9ef">char</span> cmd[][<span style="color:#ae81ff">128</span>])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r, fd;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">128</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/.history&#34;</span>, O_RDONLY)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        user_panic(<span style="color:#e6db74">&#34;His : Open failed&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> read(fd, buf, <span style="color:#66d9ef">sizeof</span>(buf))) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        user_panic(<span style="color:#e6db74">&#34;His : Read failed&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    close(fd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, cmdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (buf[i])
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> cmdj <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (buf[i] <span style="color:#f92672">&amp;&amp;</span> buf[i] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>            cmd[cmdi][cmdj<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> buf[i<span style="color:#f92672">++</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>buf[i])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>i;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">++</span>cmdi;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cmdi;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>é€šè¿‡ç¼–å†™ä¸€ä¸ªç”¨æˆ·æ€ç¨‹åº</strong> <code>history.b</code>æ–‡ä»¶å¹¶å†™å…¥ç£ç›˜ä¸­ï¼Œä½¿å¾—æ¯æ¬¡è°ƒç”¨<code>history.b </code>æ—¶ï¼Œèƒ½å¤Ÿå°†æ–‡ä»¶ï¼ˆ .history ï¼‰çš„å†…å®¹å…¨éƒ¨è¾“å‡ºã€‚åœ¨ user/history.c ä¸­ è¿›è¡Œè¯»å–/.historyæ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;lib.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">umain</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;usage: history</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> his <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;.history&#34;</span>, O_RDONLY <span style="color:#f92672">|</span> O_CREAT);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> ch;
</span></span><span style="display:flex;"><span>	fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[33m-*- HISTORY -*-</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[0m</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[33m1</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[0m</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> fl <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (read(his, <span style="color:#f92672">&amp;</span>ch, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (fl)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[33m%d</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[0m</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#34;</span>, cnt);
</span></span><span style="display:flex;"><span>			fl <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;%c&#34;</span>, ch);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>			fl <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>æŒ‰é”®è¯†åˆ«ï¼Œé”®å…¥ä¸Šä¸‹é”®æ—¶ï¼Œåˆ‡æ¢å†å²å‘½ä»¤</strong></p>
</li>
</ol>
<ul>
<li>
<p><strong>ç»æŸ¥é˜…èµ„æ–™ï¼Œå…‰æ ‡é”®å¯¹åº”çš„å­—ç¬¦å¦‚ä¸‹ï¼š</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">æŒ‰é”®</th>
<th style="text-align:center">å¸¸è§„æ¨¡å¼</th>
<th style="text-align:center">åº”ç”¨ç¨‹åºæ¨¡å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">â†‘</td>
<td style="text-align:center">ESC [ A</td>
<td style="text-align:center">ESC O A</td>
</tr>
<tr>
<td style="text-align:center">â†“</td>
<td style="text-align:center">ESC [ B</td>
<td style="text-align:center">ESC O B</td>
</tr>
</tbody>
</table>
</li>
<li>
<p><strong>æ­¥éª¤</strong></p>
<ul>
<li>è·å–ç¼“å†²åŒºbuf[]åä¸‰ä¸ªå­—ç¬¦</li>
<li>æ•è·åˆ°åï¼ŒæŠµæ¶ˆå…‰æ ‡ç§»åŠ¨æ“ä½œ</li>
<li>æ¸…ç©ºç¼“å†²åŒºï¼Œå°†å…‰æ ‡ç§»åˆ°å·¦ä¾§</li>
<li>æ‰“å°å‡ºç›¸åº”é¡ºåºçš„æŒ‡ä»¤</li>
</ul>
</li>
<li>
<p><strong>ä»£ç åˆ†æ</strong></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span> buf[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">27</span> <span style="color:#f92672">&amp;&amp;</span> buf[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">91</span> <span style="color:#f92672">&amp;&amp;</span> buf[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">65</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    writef(<span style="color:#e6db74">&#34;%c%c%c&#34;</span>, <span style="color:#ae81ff">27</span>, <span style="color:#ae81ff">91</span>, <span style="color:#ae81ff">65</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">-=</span> <span style="color:#ae81ff">2</span>; i; <span style="color:#f92672">--</span>i)
</span></span><span style="display:flex;"><span>        writef(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (cmdi)
</span></span><span style="display:flex;"><span>        strcpy(buf, cmds[<span style="color:#f92672">--</span>cmdi]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strcpy</span>(buf, cmds[cmdi]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    writef(<span style="color:#e6db74">&#34;%s&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> strlen(buf) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span> buf[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">27</span> <span style="color:#f92672">&amp;&amp;</span> buf[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">91</span> <span style="color:#f92672">&amp;&amp;</span> buf[i] <span style="color:#f92672">==</span> <span style="color:#ae81ff">66</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (cmdi <span style="color:#f92672">&lt;</span> nn <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">-=</span> <span style="color:#ae81ff">2</span>; i; <span style="color:#f92672">--</span>i)
</span></span><span style="display:flex;"><span>            writef(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        strcpy(buf, cmds[<span style="color:#f92672">++</span>cmdi]);
</span></span><span style="display:flex;"><span>        writef(<span style="color:#e6db74">&#34;%s&#34;</span>, buf);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        buf[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> buf[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> buf[i] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    i <span style="color:#f92672">=</span> strlen(buf) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="challengeéƒ¨åˆ†">Challengeéƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#challengeéƒ¨åˆ†">#</a></h3>
<h4 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡<a hidden class="anchor" aria-hidden="true" href="#ç¯å¢ƒå˜é‡">#</a></h4>
<p>åœ¨æœ¬éƒ¨åˆ†ï¼Œæˆ‘ä¸éƒ¨åˆ†åŒå­¦è¿›è¡Œäº†è¿›è¡Œäº†äº¤æµä¸æ¢è®¨ï¼Œæœ€ç»ˆç»“åˆåŠ©æ•™çš„æç¤ºä»¥åŠé—®é¢˜æè¿°ï¼Œå¾—åˆ°äº†ä¸‹é¢ä¸€ç§è¾ƒä¸ºæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</p>
<ol>
<li>
<p><strong>é¦–å…ˆæˆ‘ä»¬éœ€è¦è‡ªå®šä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼Œæ¥è¡¨ç¤ºç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­éœ€è¦æœ‰è¿™äº›å±æ€§ï¼šç¯å¢ƒå˜é‡æ‹¥æœ‰è€…çš„idã€ç¯å¢ƒå˜é‡çš„åå­— ã€ç¯å¢ƒå˜é‡çš„å€¼ã€åªè¯»æ€§ã€å±€éƒ¨æ€§ã€æœ‰æ•ˆæ€§ï¼Œç„¶åå»ºç«‹ä¸€ä¸ªç¯å¢ƒå˜é‡è¡¨ï¼Œä»¥è¾¾åˆ°å¤šä¸ªç¨‹åºä½¿ç”¨çš„ç›®çš„</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> Var {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> envid;  <span style="color:#75715e">//ç¯å¢ƒå˜é‡æ‹¥æœ‰è€…çš„id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   	<span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">64</span>]; <span style="color:#75715e">//ç¯å¢ƒå˜é‡çš„åå­— 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">char</span> val[<span style="color:#ae81ff">128</span>]; <span style="color:#75715e">//ç¯å¢ƒå˜é‡çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> readonly; <span style="color:#75715e">//åªè¯»æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> local; <span style="color:#75715e">//å±€éƒ¨æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> ava; <span style="color:#75715e">//æœ‰æ•ˆæ€§,ä¸º0ä»£è¡¨è¿˜æœªç”Ÿæ•ˆï¼Œå³ä¸å­˜åœ¨ï¼ˆç‹­ä¹‰ç†è§£ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}; 
</span></span></code></pre></div></li>
<li>
<p><strong>æ–°å¢ç³»ç»Ÿè°ƒç”¨</strong>,ä»¥å®ç°å¯¹ç¯å¢ƒå˜é‡çš„<strong>å¢åˆ æ”¹æŸ¥</strong></p>
<ul>
<li>
<p>åœ¨<code>lib/syscall.S</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.word sys_get_var
</span></span><span style="display:flex;"><span>.word sys_set_var
</span></span></code></pre></div></li>
<li>
<p>user/syscall_lib.c</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">syscall_get_var</span>(u_int envid, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>val, <span style="color:#66d9ef">int</span> op) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> msyscall(SYS_get_var, envid, name, val, op, <span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">syscall_set_var</span>(u_int envid, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>val, <span style="color:#66d9ef">int</span> op, <span style="color:#66d9ef">int</span> perm) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> msyscall(SYS_set_var, envid, name, val, op, perm);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>å¢ï¼š</strong><code>syscall_set_var(op=0)</code>â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªava=0çš„Varï¼Œå†™å…¥è¿™ä¸ªVar</p>
<p><strong>åˆ </strong>ï¼š<code>syscall_set_var(op=1)</code>â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°nameå¯¹åº”çš„è¦åˆ é™¤çš„varï¼Œè®¾ç½®å…¶ava=0</p>
<p><strong>æ”¹</strong>ï¼š<code>syscall_set_var(op=0)</code>â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°nameå¯¹åº”çš„è¦ä¿®æ”¹çš„varï¼Œæ”¹ä¸ºå‚æ•°ä¸­çš„è¿™ä¸ªvar</p>
<p><strong>æŸ¥</strong>ï¼šæŸ¥è¯¢ç‰¹å®šçš„æœ‰æ•ˆçš„ç¯å¢ƒå˜é‡/å…¨éƒ¨æœ‰æ•ˆçš„ç¯å¢ƒå˜é‡</p>
<ul>
<li>ç‰¹å®šçš„ï¼š<code>syscall_get_var(op=0)</code>â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°æ‰€æœ‰ava=1çš„ï¼Œä¸”åå­—ä¸æŸ¥è¯¢æ¡ä»¶ç›¸åŒçš„var</li>
<li>å…¨éƒ¨çš„ï¼š<code>syscall_get_var(op=1)</code>â€”â€”éå†ç¯å¢ƒå˜é‡è¡¨ï¼Œæ‰¾åˆ°æ‰€æœ‰ava=1çš„var</li>
</ul>
</li>
<li>
<p>å…·ä½“ä»£ç å®ç°ï¼Œå—é™äºç¯‡å¹…ï¼Œä¸å®Œæ•´è´´ä¸Šï¼Œéœ€è¦æ³¨æ„çš„å‡ ç‚¹</p>
<ul>
<li>
<p>è®¾ç½®setæ—¶çš„æƒé™ä½ VAR_LOCAL ï¼Œ VAR_RDONLY æ¥æ§åˆ¶è®¿é—®æƒé™,è®¾ç½®å¯¹åº”Varçš„localï¼Œreadonlyå˜é‡</p>
</li>
<li>
<p>æ–°å¢äº†é”™è¯¯ç±»å‹ E_VAR_NOT_FOUND , E_VAR_FULL , E_VAR_RDONLY</p>
</li>
<li>
<p>åœ¨è¿›è¡Œåä¸‰è€…æ—¶ï¼Œè¦æ³¨æ„é¢å¤–åˆ¤æ–­å½“å‰ç»´æŠ¤å˜é‡æ˜¯å¦ä¸ºå±€éƒ¨çš„ä»¥åŠå…¶ä¸å½“å‰shellidçš„å…³ç³»ï¼Œå†™ä¸€ä¸ªç®€å•çš„å‡½æ•°è¿›è¡Œåˆ¤æ–­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//shellidé€šè¿‡ç³»ç»Ÿè°ƒç”¨ä¼ å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">judge</span>(u_int shellid, <span style="color:#66d9ef">struct</span> Var <span style="color:#f92672">*</span>var) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (var<span style="color:#f92672">-&gt;</span>local <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; 
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (shellid <span style="color:#f92672">==</span> var<span style="color:#f92672">-&gt;</span>envid) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; 	
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; 
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>ä¸»è¦ä½¿ç”¨strcatï¼Œstrcmpï¼Œstrcpyè¿›è¡Œå­—ç¬¦ä¸²å¤„ç†ï¼Œæ¯”è¾ƒã€‚åˆ©ç”¨äº†æ¯”è¾ƒå‚»çš„forå¾ªç¯ã€‚</p>
</li>
<li>
<p>ç„¶åæ¯”å¦‚è¯´åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”nameï¼Œæ„å»ºäº†ä¸€ä¸ªå°å‡½æ•°ï¼Œæ–¹ä¾¿åˆ¤æ–­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">contain_name</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NVARS; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> Var <span style="color:#f92672">*</span>v <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>vars[i];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (v<span style="color:#f92672">-&gt;</span>ava <span style="color:#f92672">&amp;&amp;</span> strcmp(v<span style="color:#f92672">-&gt;</span>name, <span style="color:#f92672">*</span>name<span style="color:#f92672">*</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>; 
</span></span><span style="display:flex;"><span>    }  
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>æ³¨æ„æƒé™ä½çš„è®¾ç½®</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>declare</strong></p>
<ul>
<li>
<p>åœ¨<code>umain</code>ä¸­ï¼Œè®¾ç½®flag,ä»¥åŠperm</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">umain</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    ARGBEGIN
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            usage();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;r&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            flag[(u_char) ARGC()]<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;x&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			flag[(u_char) ARGC()]<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ARGEND
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> perm <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (flag[<span style="color:#e6db74">&#39;r&#39;</span>]) {
</span></span><span style="display:flex;"><span>		perm <span style="color:#f92672">|=</span> VAR_RDONLY; 
</span></span><span style="display:flex;"><span>	} 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (flag[<span style="color:#e6db74">&#39;x&#39;</span>]) {
</span></span><span style="display:flex;"><span>		perm <span style="color:#f92672">|=</span> VAR_LOCAL; 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>arg2 <span style="color:#f92672">=</span> argv[<span style="color:#ae81ff">1</span>]; 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span>(<span style="color:#f92672">*</span>arg2 <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;=&#39;</span>) {
</span></span><span style="display:flex;"><span>		arg2<span style="color:#f92672">++</span>; 
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) declare_nothing(); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) set(argv[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;&#34;</span>, perm);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) set(argv[<span style="color:#ae81ff">0</span>], arg2, perm);
</span></span><span style="display:flex;"><span>  	<span style="color:#66d9ef">else</span> writef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;too many args&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//writef(&#34;declare ok**&#34;); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div></li>
<li>
<p>åœ¨setå‡½æ•°ä¸­è°ƒç”¨å‰è¿°æ‰€å†™ç³»ç»Ÿè°ƒç”¨ï¼Œå®ç°declareï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æƒé™ä½çš„è®¾å®šï¼Œä»¥åŠä¼ å…¥å‚æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>value, <span style="color:#66d9ef">int</span> perm) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> shellid <span style="color:#f92672">=</span> syscall_get_ShellId(syscall_get_ShellId(syscall_getenvid())); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> syscall_set_var(shellid, name, value, <span style="color:#ae81ff">0</span>, perm)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>       	<span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>E_VAR_FULL) fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;declare: vars are full</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>E_VAR_RDONLY) fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;declare: [%s] is readonly</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><strong>echo</strong></p>
<p>åœ¨å®ç°echoçš„æ—¶å€™ï¼Œåœ¨umainè§£æçš„æ—¶å€™ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">umain</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i, nflag;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nflag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> strcmp(argv[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;-n&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        nflag <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        argc<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>        argv<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;</span> argc; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            write(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (argv[i][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;$&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> value[<span style="color:#ae81ff">128</span>];
</span></span><span style="display:flex;"><span>            syscall_env_var(<span style="color:#f92672">&amp;</span>argv[i][<span style="color:#ae81ff">1</span>], value, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            write(<span style="color:#ae81ff">1</span>, value, strlen(value));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            write(<span style="color:#ae81ff">1</span>, argv[i], strlen(argv[i]));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>nflag)
</span></span><span style="display:flex;"><span>        write(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><strong>unset</strong></p>
<p>åœ¨<code>unset.c </code>ä¸­ï¼Œ ç›´æ¥è°ƒç”¨syscall_set_var å³å¯.</p>
</li>
</ol>
<h3 id="å…¶ä»–æ”¯æŒæˆ–è€…å‰ç½®æ¡ä»¶">å…¶ä»–æ”¯æŒæˆ–è€…å‰ç½®æ¡ä»¶<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–æ”¯æŒæˆ–è€…å‰ç½®æ¡ä»¶">#</a></h3>
<h4 id="1clearæ¸…å±">ï¼ˆ1ï¼‰clearæ¸…å±<a hidden class="anchor" aria-hidden="true" href="#1clearæ¸…å±">#</a></h4>
<p><code>#define CLEAR() printf(&quot;\033[2J&quot;) </code></p>
<h4 id="2å½©è‰²è¾“å‡º">ï¼ˆ2ï¼‰å½©è‰²è¾“å‡º<a hidden class="anchor" aria-hidden="true" href="#2å½©è‰²è¾“å‡º">#</a></h4>
<p>å®šä¹‰åœ¨<code>sh.h</code>ä¸­</p>
<p>ç”¨ç±»ä¼¼äº\033[32m å®ç°ç»¿è‰²è¾“å‡ºï¼Œç±»ä¼¼å¯ä»¥å®ç°å…¶ä»–é¢œè‰²çš„è¾“å‡ºã€‚</p>
<p>ç”¨ \033[1m å¯ä»¥å®ç°åŠ ç²—æ•ˆæœã€‚</p>
<p>ç”¨ \033[m è¡¨ç¤ºé¢œè‰²è¾“å‡ºç»“æŸã€‚</p>
<h4 id="3cdå‘½ä»¤">ï¼ˆ3ï¼‰cdå‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#3cdå‘½ä»¤">#</a></h4>
<p>åˆ©ç”¨ç¯å¢ƒå˜é‡ç»´æŠ¤curpath(å½“å‰è·¯å¾„)ï¼Œåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨å¯ä»¥è·å–å’Œè®¾ç½®å½“å‰è·¯å¾„ï¼Œå¹¶å°è£…ä¸€å¥— APIï¼›</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">curpath_init</span>(<span style="color:#66d9ef">int</span> envid,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">curpath_get</span>(<span style="color:#66d9ef">int</span> envid,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">curpath_set</span>(<span style="color:#66d9ef">int</span> envid,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">curpath_get_parent</span>(<span style="color:#66d9ef">int</span> envid,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path);
</span></span></code></pre></div><p>å½“ä½¿ç”¨âˆ¶</p>
<ul>
<li>
<p>cd.âˆ¶ä¸æ”¹å˜è·¯å¾„</p>
</li>
<li>
<p>cd ..âˆ¶è¿”å›ä¸Šä¸€çº§ç›®å½•ï¼ˆè‹¥ä¸ºæ ¹ç›®å½•ï¼Œåˆ™ä¸å†è¿”å›ï¼‰</p>
</li>
<li>
<p>cd folder âˆ¶è¿›å…¥ç›®å½•æ—¶</p>
</li>
</ul>
<p>å¯¹æ‰€æœ‰çš„å‘½ä»¤éƒ½é‡å†™ï¼ŒåŠ å…¥ curpath çš„è·å–ã€‚å¦‚æœä¼ å…¥çš„å‘½ä»¤æ˜¯ä¸€ä¸ªä»¥ /å¼€å¤´çš„è·¯å¾„ï¼Œåˆ™ä¸ºç»å¯¹è·¯å¾„;å¦åˆ™ä¸ºç›¸å¯¹è·¯å¾„ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> i, r;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> path[<span style="color:#ae81ff">256</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> faid <span style="color:#f92672">=</span> syscall_get_ShellId(syscall_get_ShellId(syscall_getenvid()));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;cd: too few args</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;</span> argc; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//æ˜¾ç¤ºå½“å‰ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (strcmp(argv[i], <span style="color:#e6db74">&#34;.&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//ä¸Šä¸€çº§ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (strcmp(argv[i], <span style="color:#e6db74">&#34;..&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            curpath_get_parent(faid, path);
</span></span><span style="display:flex;"><span>            curpath_set(faid, path);
</span></span><span style="display:flex;"><span>            fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;cd(now_path): %s&#34;</span>, path);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//è¿›å…¥æŸä¸€ä¸ªç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> curpath_get(faid, path)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;cd: get environment var failed&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            strcat(path, argv[i]);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> len <span style="color:#f92672">=</span> strlen(path);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (path[len <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>                strcat(path, <span style="color:#e6db74">&#34;/&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">struct</span> Stat st;
</span></span><span style="display:flex;"><span>            r <span style="color:#f92672">=</span> stat(path, <span style="color:#f92672">&amp;</span>st);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>E_VAR_NOT_FOUND)
</span></span><span style="display:flex;"><span>                fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;cd: %s not found</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (r <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;cd: cannot cd %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (<span style="color:#f92672">!</span>st.st_isdir)
</span></span><span style="display:flex;"><span>                fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;cd: %s is not directory</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, path);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> curpath_set(faid, path)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                    fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;Environment var not found&#34;</span>);
</span></span><span style="display:flex;"><span>                fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;curpath: %s&#34;</span>, path);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="4rmå‘½ä»¤">ï¼ˆ4ï¼‰rmå‘½ä»¤<a hidden class="anchor" aria-hidden="true" href="#4rmå‘½ä»¤">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//ç±»ä¼¼äºåˆ›å»ºæ–‡ä»¶ï¼Œæœ‰å°æ”¹åŠ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> remove(curpath)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    fwritef(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;File %s Not Exists!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, curpath);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="5openä¿®æ”¹">ï¼ˆ5ï¼‰openä¿®æ”¹<a hidden class="anchor" aria-hidden="true" href="#5openä¿®æ”¹">#</a></h4>
<p>åœ¨open()ä¸­ï¼Œé¦–å…ˆéœ€è¦åŠ å…¥APPEND,MKDIR,CREATä»£ç ã€‚</p>
<p><code>#define O_APPEND 0x1000</code></p>
<p><code>user/file.c</code>ä¸­çš„<code>open()</code> ä¸­åŠ å…¥O_APPENDæ‰“å¼€æ–¹å¼æ‰©å……ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((mode <span style="color:#f92672">&amp;</span> O_APPEND) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) { 
</span></span><span style="display:flex;"><span>	ffd<span style="color:#f92672">-&gt;</span>f_fd.fd_offset <span style="color:#f92672">=</span> size; 
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p><code>fs/serv.c</code>ä¸­çš„<code>serve_open()</code>ä¸­åŠ å…¥CREAT, MKDIRæ‰“å¼€æ–¹å¼æ‰©å…….</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> file_open((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) path, <span style="color:#f92672">&amp;</span>f)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>E_NOT_FOUND <span style="color:#f92672">&amp;&amp;</span> (rq<span style="color:#f92672">-&gt;</span>req_omode <span style="color:#f92672">&amp;</span> O_CREAT)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> file_create((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)path, <span style="color:#f92672">&amp;</span>f)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            f<span style="color:#f92672">-&gt;</span>f_type <span style="color:#f92672">=</span> FTYPE_REG;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (r <span style="color:#f92672">==</span> <span style="color:#f92672">-</span>E_NOT_FOUND <span style="color:#f92672">&amp;&amp;</span> (rq<span style="color:#f92672">-&gt;</span>req_omode <span style="color:#f92672">&amp;</span> O_MKDIR)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> file_create((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)path, <span style="color:#f92672">&amp;</span>f)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            f<span style="color:#f92672">-&gt;</span>f_type <span style="color:#f92672">=</span> FTYPE_DIR;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            ipc_send(envid, r, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h4 id="6ç¯å¢ƒå˜é‡çš„è·å–å½“å‰åœ°å€çš„æ“ä½œ">ï¼ˆ6ï¼‰ç¯å¢ƒå˜é‡çš„è·å–ï¼Œå½“å‰åœ°å€çš„æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#6ç¯å¢ƒå˜é‡çš„è·å–å½“å‰åœ°å€çš„æ“ä½œ">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">curpath_init</span>(<span style="color:#66d9ef">int</span> envid, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>	 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// set op 0 declare with perm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> syscall_set_var(envid, CURPATH_KEY, path, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) user_panic(<span style="color:#e6db74">&#34;Init curpath failed: %u.&#34;</span>, r);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">curpath_get</span>(<span style="color:#66d9ef">int</span> envid, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//op1 get one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//writef(&#34;get from env : %d&#34;, envid); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> syscall_get_var(envid, CURPATH_KEY, path, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> r;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">curpath_set</span>(<span style="color:#66d9ef">int</span> envid, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// op0 declare with perm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> syscall_set_var(envid, CURPATH_KEY, path, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> r;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> r; 
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">curpath_get_parent</span>(<span style="color:#66d9ef">int</span> envid, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> r, i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((r <span style="color:#f92672">=</span> curpath_get(envid, path)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> r;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (strlen(path) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> strlen(path) <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>; path[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/&#39;</span>; i<span style="color:#f92672">--</span>);
</span></span><span style="display:flex;"><span>    path[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> r; 
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="å®éªŒéš¾ç‚¹åŠæ€»ç»“">å®éªŒéš¾ç‚¹åŠæ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#å®éªŒéš¾ç‚¹åŠæ€»ç»“">#</a></h2>
<p>åœ¨æœ¬å®éªŒä¸­ï¼Œæˆ‘é€šè¿‡ç¼–å†™æ–°å‡½æ•°ï¼Œæ–°çš„æ–¹æ³•å®ç°ä¸€äº›å°ç»„ä»¶ä»¥åŠé™„åŠ åŠŸèƒ½ï¼Œä¸°å¯Œäº†æˆ‘ä»¬çš„ shellçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬&quot;åå°è¿è¡Œ&rdquo;ï¼Œ&ldquo;ä¸€è¡Œå¤šå‘½ä»¤&rdquo;ï¼Œ&ldquo;ç®€å•å¼•å·æ”¯æŒ&rdquo;ï¼Œ&ldquo;tree /mkdir /touch å‘½ä»¤&rdquo;ï¼Œ&ldquo;æ¸…å±&rdquo;ï¼Œ&ldquo;å½©è‰²è¾“å‡º&rdquo;ï¼Œ&ldquo;å†å²å‘½ä»¤&rdquo;ï¼Œ&ldquo;ç¯å¢ƒå˜é‡&rdquo;ï¼Œ&ldquo;cd å‘½ä»¤&quot;ç­‰ä»»åŠ¡ã€‚</p>
<p>æˆ‘è®¤ä¸ºå®éªŒçš„ä¸»è¦éš¾ç‚¹åœ¨äº</p>
<ul>
<li>ä¿®æ”¹è‹¥å¹²çš„æŒ‡ä»¤ï¼Œä½¿ä¹‹æˆä¸ºå†…ç½®çš„æŒ‡ä»¤</li>
<li>åœ¨å†å²å‘½ä»¤ä¸­ï¼Œå¦‚ä½•å®ç°è¯†åˆ«é”®ä½ï¼ˆé€šè¿‡æŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼‰ï¼Œå¦‚ä½•å®ç°å†å²å‘½ä»¤ä¿å­˜ï¼Œè¾“å‡º</li>
<li>ä»¥åŠåœ¨challengeéƒ¨åˆ†çš„ç¯å¢ƒå˜é‡çš„å®ç°ï¼ˆæ–°å®šä¹‰ç»“æ„ä½“ï¼Œå¹¶ä¸”ä¹¦å†™ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥åŠå¢åŠ ç›¸åº”çš„openï¼ˆï¼‰å‚æ•°ï¼Œé”™è¯¯ç ï¼Œå¹¶åŠ ä»¥åˆç†è¿ç”¨ï¼‰</li>
<li>ä¸€äº›å­—ç¬¦ä¸²å¤„ç†æ–¹æ³•çš„ä½¿ç”¨ï¼Œä»¥åŠå„ä¸ªç»†èŠ‚çš„æ³¨æ„ä»¥åŠé€ä¸ªå‡»ç ´ã€‚</li>
</ul>
<p>ç»ˆäºåº¦è¿‡äº†éš¾æ±çš„ä¸€å­¦æœŸå­¦ä¹ ï¼Œåœ¨åšå®Œäº†lab6æŒ‘æˆ˜æ€§ä»»åŠ¡ä»¥åï¼Œæˆ‘å¯¹osçš„å­¦ä¹ ä½“ä¼šæœ‰äº†è¿›ä¸€æ­¥çš„å‡åï¼Œä¹Ÿå¯¹è¯¾ç¨‹å†…å®¹æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ï¼Œæ„Ÿè°¢osè¯¾ç¨‹ç»„å¯¹æˆ‘ä»¬çš„ç£¨ç»ƒä»¥åŠæå‡ï¼</p>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="/img/alipay.jpg" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://mksasx.github.io/posts/sport/%E7%AF%AE%E7%90%83%E5%9F%BA%E6%9C%AC%E6%88%98%E6%9C%AF%E5%8F%8A%E5%9B%BE%E8%A7%A3/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>ç¯®çƒåŸºæœ¬æˆ˜æœ¯åŠå›¾è§£</span>
  </a>
  <a class="next" href="https://mksasx.github.io/posts/tech/algorithm/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>æ’åºç®—æ³•</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://vercal-mogodb-comment.vercel.app/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou',
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://mksasx.github.io/" style="color:#939393;">AustinMa&#39;s Blog</a>
         All Rights Reserved
    </span>

    

     
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"AustinMa's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"AustinMa's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"AustinMa's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
