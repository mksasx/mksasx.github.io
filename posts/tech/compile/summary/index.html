<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>编译期末总结文档 | AustinMa&#39;s Blog</title>
<meta name="keywords" content="编译期末总结, Compiler">
<meta name="description" content="这是我的编译课程期末总结文档">
<meta name="author" content="
作者:&nbsp;AustinMa">
<link rel="canonical" href="https://mksasx.github.io/posts/tech/compile/summary/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8d8b767ac9b1d8bce25f548e0a8aeaef8929f1e46f3e5b25efa3ff8f103cf9da.css" integrity="" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mksasx.github.io/img/1.jpg">
<link rel="icon" type="image/png" sizes="16x16" href="https://mksasx.github.io/img/1.jpg">
<link rel="icon" type="image/png" sizes="32x32" href="https://mksasx.github.io/img/1.jpg">
<link rel="apple-touch-icon" href="https://mksasx.github.io/img/1.jpg">
<link rel="mask-icon" href="https://mksasx.github.io/img/1.jpg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="编译期末总结文档" />
<meta property="og:description" content="这是我的编译课程期末总结文档" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mksasx.github.io/posts/tech/compile/summary/" />
<meta property="og:image" content="https://mksasx.github.io/posts/tech/os/great.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-30T12:31:30&#43;08:00" />
<meta property="article:modified_time" content="2022-12-30T12:31:30&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mksasx.github.io/posts/tech/os/great.png" />
<meta name="twitter:title" content="编译期末总结文档"/>
<meta name="twitter:description" content="这是我的编译课程期末总结文档"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "📚文章",
      "item": "https://mksasx.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "👨🏻‍💻 技术",
      "item": "https://mksasx.github.io/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "⚛️ 编译",
      "item": "https://mksasx.github.io/posts/tech/compile/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "编译期末总结文档",
      "item": "https://mksasx.github.io/posts/tech/compile/summary/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "编译期末总结文档",
  "name": "编译期末总结文档",
  "description": "这是我的编译课程期末总结文档",
  "keywords": [
    "编译期末总结", "Compiler"
  ],
  "articleBody": "编译设计文档 姓名：马泽远\n学号：20373793\n一. 参考编译器介绍 Pcode代码生成部分（包括Pcode代码执行）部分参考了《自己动手写编译器》。\n其余部分参考了往年的编译指导文档，包括一些往届学长的编译器设计架构\n二. 编译器总体设计 总体结构 我的编译器总体结构按照编译的顺序，即词法分析、语法分析、语义分析、代码生成，分为四个部分。\n有几个类用来定义基本的一些需要用到的变量，比如**TokenWord类对应着单词类**，其属性包括单词内容，类别码，所在行数。类似的，还有**Symbol类对应着符号类**,Expressions类对应着表达式类,用于表示一个具有多个表达式的大表达式，以及**SymbolTable类对应着符号表类**，Func类对应着函数类，还有**Error类**。\n另外的几个类，则是分别对应着相应的几个编译器执行过程，LexicalAanlysis类对应词法分析，GrammarAanlysis类综合了语法分析，语义分析、错误处理，以及生成中间代码（Pcode码）\n而对于Pcode的定义，执行则是单独设置了一个文件包**PcodeGeneration,其中包含对Pcode的Function、Execute，retinfo，variety**以及其本身。\nCompiler类对应着编译器的总入口。在其中，依次调用**LexicalAanlysis，GrammarAanlysis，PcodeExecutor类，即可完成词法分析到语法分析到语义分析到代码生成的整个过程，形成了类似一个单向链**，每一个部分都是一个单独的模块。\n文件组织 src │ Compiler.java #入口程序 │ Error.java #错误类 │ Expressions.java #表达式类 │ Func.java #函数类 │ GrammarAnalysis.java #语法分析、错误处理、代码生成类 │ lexicalAnalysis.java #词法分析类 │ Symbol.java #符号类 │ SymbolTable.java #符号表类 │ TokenWord.java #单词类 └─PcodeGeneration Function.java #Pcode中的函数类 LabelCreator.java #标签制造 Pcode.java #Pcode代码类 PcodeExecutor.java #Pcode运行虚拟机类 PcodeKey.java #枚举Pcode中的关键词 RetInfo.java #返回信息类 Variety.java #变量类 类图 三. 词法分析设计 1 总述 词法分析的总任务是从源程序中识别出单词，记录单词类别和单词值。在词法分析的设计中给了一张表，其中有三项是加粗说明的，分别是 变量名（Ident），整常数（IntConst） 和 格式字符串（FormatString） 而剩下都可以认为是 特殊字符。\n词法分析的作业本质上就是把文件转换成一个个的词，在之后的文章中我们称之为 TokenWord。然后再把分出来的**TokenWord**进行类别的判断，最后输出。\n2 实现 2.1 文件读写 InputStreamReader Reader = new InputStreamReader(new FileInputStream(\"testfile.txt\"), \"UTF-8\"); BufferedReader bufferedReader = new BufferedReader(Reader); OutputStreamWriter Writer = new OutputStreamWriter(new FileOutputStream(\"output.txt\"), \"UTF-8\"); BufferedWriter bufferedWriter = new BufferedWriter(Writer); 利用bufferedReader逐行读入文件，注意需要手动加入换行符（最后添加的一个要删掉）\nwhile ((line = bufferedReader.readLine()) != null) { str.append(line).append(\"\\n\"); } str.delete(str.length() - 1, str.length()); 将lexicalAnalysis中分析得到的tokenWords写出\nfor(TokenWord tokenWord :lexicalAnalysis.tokenWords) { bufferedWriter.write(tokenWord.getClassCode()+\" \"+ tokenWord.getToken()+\"\\n\"); } 2.2 词法分析过程 准备工作 标识符定义采用enum枚举ClassCode的方法\npublic static enum ClassCode { IDENFR, INTCON, STRCON, ...... 同时采用HashMap构造一些特定标识符的对应关系\npublic static HashMap\u003cString, String\u003e ResCode = new HashMap\u003cString, String\u003e(); public static boolean hasResCode(String token) { return ResCode.containsKey(token); } static { ResCode.put(\"main\", \"MAINTK\"); ResCode.put(\"const\", \"CONSTTK\"); ...... 具体分析 总体采取逐个字符读入的方式，同时一些特定字符采取预读取来判断。\n逐个字符读入 public void getCh() { ch = allFile.charAt(cursor); cursor++; } 跳过换行、空格、\\t、\\r while (ch == '\\n' || ch == ' ' || ch == '\\t' || ch == '\\r') { if (ch == '\\n' || ch == '\\r') { LineNum++; } if (cursor \u003c= allFile.length() - 1) { getCh(); } } 标识符 字母或者下划线开头，先从ResCode看是否是保留字,否则按照IDNEFR处理\nif (isLetter(ch) || ch == '_') { while (isLetter(ch) || isDigit_with_0(ch) || ch == '_') { Token.append(ch); if (cursor \u003c= allFile.length() - 1) { getCh(); } } //reback if (cursor \u003e 0) { cursor--; } if (hasResCode(Token.toString())) { classCode = ClassCode.valueOf(ResCode.get(Token.toString())); tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } else { classCode = ClassCode.IDENFR; tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } INTCON 先判断是否是0\nif (isDigit_with_0(ch)) { if (ch == '0') { Token.append(ch); } else { while (isDigit_with_0(ch)) { Token.append(ch); getCh(); } if (cursor \u003e 0) { cursor--; } classCode = ClassCode.INTCON; tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } } 字符串 遇到\"开始，直到遇到下一个\"\nif (ch == '\"') { Token.append(ch); if (cursor \u003c= allFile.length() - 1) { getCh(); } while (cursor \u003c= allFile.length() - 1 \u0026\u0026 ch != '\"') { Token.append(ch); getCh(); } Token.append(ch); classCode = ClassCode.STRCON; tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } 单个字符或者必须两个字符的TokenWord 比如[，]，+，\u0026\u0026等，直接读就可以\n可能是单个也可能两个字符的TokenWord 比如\u003e=，!=之类的\n采用预读\nif (ch == '=') { Token.append(ch); if (cursor \u003c= allFile.length() - 1) { getCh(); if (ch == '=') { Token.append(ch); classCode = ClassCode.EQL; tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } else { classCode = ClassCode.ASSIGN; if (cursor \u003e 0) { cursor--; } tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } } else { classCode = ClassCode.ASSIGN; tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } } 注释 遇到/的情况下，采用预读\n//：并且一直读到遇到换行符\n/*：利用BackStr = allFile.substring(cursor);提取出第一个*后面的字符串BackStr；然后判断其中有没有*/，若是没有，就将后面的内容全部注释掉，若是有就将cursor移动到其后面，但是注意要遇到换行符时加行数。\n否则/：直接按照DIV输出\nif (ch == '/') { Token.append(ch); if (cursor \u003c= allFile.length() - 1) { getCh(); if (ch == '/') { if (cursor \u003c= allFile.length() - 1) { getCh(); } while (ch != '\\n') { if (cursor \u003c= allFile.length() - 1) getCh(); else { noteFlag = true; break; } } if (!noteFlag) { LineNum++; } noteFlag = false; return -2; } else if (ch == '*') { String BackStr; boolean flagnote; int cursortmp = cursor; BackStr = allFile.substring(cursor); if (!BackStr.contains(\"*/\")) { cursor = allFile.length(); return -2; } else { cursor = cursor + BackStr.indexOf(\"*/\") + 2; int originLength = allFile.substring(cursortmp, cursor).length(); int replaceLength = allFile.substring(cursortmp, cursor).replace(\"\\n\", \"\").length(); LineNum += originLength - replaceLength; return -2; } } else { classCode = ClassCode.DIV; if (cursor \u003e 0) { cursor--; } tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } } else { classCode = ClassCode.DIV; tokenWords.add(new TokenWord(classCode.toString(),Token.toString(),LineNum)); } } 四. 语法分析设计 1 总述 在语法分析阶段，根据词法分析程序识别出的Token单词，根据SysY语法规则识别出各种语法元素。采用递归下降法对语法中定义的语法成分进行分析。注意要消除左递归，以及面对可能的回溯问题进行预读。\n从**CompUnit**开始逐层往下进行分析。\n2 具体实现 设置getWordMove(),getNowWord(),getNextWord(),getThirdWord()工具函数用于读入tokenWord,同时设置GrammarString,curTokenWord等全局变量，用于存储获得的语法分析成分，以及当前所读到的tokenWord。\n对于普通的语法成分，我逐个读入tokenWord，然后对其进行常规的分析。\n对于表达式Expression，我首先扫描出整个的Expression,然后对于具有左递归性的语法规则，再依据特定的分隔符，对整个大的Expression进行分割成若干个较短的Expression，然后依次调用对应子表达式的分析方法，进行递归下降法进行分析。\n构建了一个新的Expressions类，用于存放分割出的子表达式,其中记录有分隔符，分割出的子表达式\npublic class Expressions { private ArrayList\u003cTokenWord\u003e symbols; private ArrayList\u003cArrayList\u003cTokenWord\u003e\u003e expressions; public ArrayList\u003cArrayList\u003cTokenWord\u003e\u003e getExpressions() { return expressions; } public ArrayList\u003cTokenWord\u003e getSymbols() { return symbols; } public Expressions(ArrayList\u003cTokenWord\u003e symbols, ArrayList\u003cArrayList\u003cTokenWord\u003e\u003e expressions) { this.symbols = symbols; this.expressions = expressions; } } 2.1 获取表达式–getExpression 通过一些特定的判断条件，结合当前字符以及前一个字符的值进行判断，以及是否位于函数的判断等，进行表达式的获取（后续改写的时候比较繁琐）\npublic ArrayList\u003cTokenWord\u003e getExpression() { TokenWord preWord = null; TokenWord word = getNowWord(); ArrayList\u003cTokenWord\u003e exp = new ArrayList\u003c\u003e(); boolean inFunc = false; int FuncFlag = 0; int FlagSmall = 0; int FlagBig = 0; while (true) { if (word.ClassCodeOf(\"SEMICN\") || word.ClassCodeOf(\"ASSIGN\") || word.ClassCodeOf(\"RBRACE\") || word.ClassCodeOfTrueStmt()) { break; } //不在函数声明或者引用内，且遇到',' if (word.ClassCodeOf(\"COMMA\") \u0026\u0026 !inFunc) { break; } //单词不在表达式内 if (preWord != null) { if ((preWord.ClassCodeOf(\"INTCON\") || preWord.ClassCodeOf(\"IDENFR\")) \u0026\u0026 (word.ClassCodeOf(\"INTCON\") || word.ClassCodeOf(\"IDENFR\"))) { break; } if ((preWord.ClassCodeOf(\"RPARENT\") || preWord.ClassCodeOf(\"RBRACK\")) \u0026\u0026 (word.ClassCodeOf(\"INTCON\") || word.ClassCodeOf(\"IDENFR\"))) { break; } if (FlagSmall == 0 \u0026\u0026 FlagBig == 0) { if (preWord.ClassCodeOf(\"INTCON\") \u0026\u0026 word.ClassCodeOf(\"LBRACK\")) { break; } if (preWord.ClassCodeOf(\"INTCON\") \u0026\u0026 word.ClassCodeOf(\"LBRACE\")) { break; } } } if (word.ClassCodeOfNotInExp()) { break; } //在函数内部 if (word.ClassCodeOf(\"IDENFR\")) { if (getNextWord().ClassCodeOf(\"LPARENT\")) { inFunc = true; } } //(),[]识别 if (word.ClassCodeOf(\"LPARENT\")) { FlagSmall++; if (inFunc) { FuncFlag++; } } if (word.ClassCodeOf(\"RPARENT\")) { FlagSmall--; if (inFunc) { FuncFlag--; if (FuncFlag == 0) { inFunc = false; } } } switch (word.getClassCode()) { case \"LBRACK\": FlagBig++; break; case \"RBRACK\": FlagBig--; break; } if (FlagSmall \u003c 0) { break; } if (FlagBig \u003c 0) { break; } curTokenWord = tokenWords.get(cursor); cursor++; exp.add(curTokenWord); preWord = word; word = getNowWord(); } return exp; } 2.2 递归下降 对于一条语法推导规则，若其推导出的式子中含有$V_{N}$,那么考虑采用递归下降分析法\n在我的实现中，我每读一个tokenWord，检查它属于哪一个$V_{N}$，然后进入下一个相应的分析函数。\n例如CompUnit:\nCompUnit → {Decl} {FuncDef} MainFuncDef // 1.是否存在Decl 2.是否存在 FuncDef 具体实现：\npublic void analyseCompUnit() { TokenWord word = getNowWord(); while (word.ClassCodeOf(\"CONSTTK\") || (word.ClassCodeOf(\"INTTK\") \u0026\u0026 getNextWord().ClassCodeOf(\"IDENFR\") \u0026\u0026 !getThirdWord().ClassCodeOf(\"LPARENT\"))) { analyseDecl(); word = getNowWord(); } while (word.ClassCodeOf(\"VOIDTK\") || ((word.ClassCodeOf(\"INTTK\") \u0026\u0026 !getNextWord().ClassCodeOf(\"MAINTK\")))) { analyseFuncDef(); word = getNowWord(); } if (word.ClassCodeOf(\"INTTK\") \u0026\u0026 getNextWord().ClassCodeOf(\"MAINTK\")) { analyseMainFuncDef(); } else { Error(); } GrammarString.add(\"\"); } 又比如Stmt\n语句 Stmt → LVal '=' Exp ';' // 每种类型的语句都要覆盖 | [Exp] ';' //有无Exp两种情况 | Block | 'if' '(' Cond ')' Stmt [ 'else' Stmt ] // 1.有else 2.无else | 'while' '(' Cond ')' Stmt | 'break' ';' | 'continue' ';' | 'return' [Exp] ';' // 1.有Exp 2.无Exp | LVal '=' 'getint''('')'';' | 'printf''('FormatString{','Exp}')'';' // 1.有Exp 2.无Exp 具体实现：\npublic void analyseStmt() { TokenWord word = getNowWord(); if (word.ClassCodeOf(\"IDENFR\")) { ArrayList\u003cTokenWord\u003e exp = getExpression(); if (!getNowWord().ClassCodeOf(\"SEMICN\")) { analyseLVal(exp); getWordMove();//= if (getNowWord().ClassCodeOf(\"GETINTTK\")) { getWordMove();//getint getWordMove();//( getWordMove();//) getWordMove();//; } else { analyseExp(getExpression());// getWordMove(); //; } } else { analyseExp(exp); getWordMove();//; } } else if (word.ClassCodeOfBeginOfExp()) { analyseExp(getExpression()); getWordMove();//; } else if (word.ClassCodeOf(\"LBRACE\")) { analyseBlock(); } else if (word.ClassCodeOf(\"IFTK\")) { getWordMove();//if getWordMove();//( analyseCond(); getWordMove();//) analyseStmt(); word = getNowWord(); if (word.ClassCodeOf(\"ELSETK\")) { getWordMove(); //else analyseStmt(); } } else if (word.ClassCodeOf(\"WHILETK\")) { getWordMove();//while getWordMove();//( analyseCond(); getWordMove();//) analyseStmt(); } else if (word.ClassCodeOf(\"BREAKTK\")) { getWordMove();//break getWordMove();//; } else if (word.ClassCodeOf(\"CONTINUETK\")) { getWordMove();//continue getWordMove();//; } else if (word.ClassCodeOf(\"RETURNTK\")) { getWordMove();//return word = getNowWord(); if (word.ClassCodeOfBeginOfExp()) { analyseExp(getExpression()); } getWordMove();//; } else if (word.ClassCodeOf(\"PRINTFTK\")) { getWordMove();//printf getWordMove();//( getWordMove();//STRCON word = getNowWord(); while (word.ClassCodeOf(\"COMMA\")) { getWordMove();//, analyseExp(getExpression()); word = getNowWord(); } getWordMove();//) getWordMove();//; } else if (word.ClassCodeOf(\"SEMICN\")) { getWordMove();//; } GrammarString.add(\"\"); } 在以上的分析过程中，需要注意的是\n一些语法成分内部分析过程的细节性注意（括号匹配等问题） 面对$V_{N}$，需要getNowWord()预读，但是不能直接加入GrammarString中，需要进一步判断属于哪个$V_{N}$ 2.3 左递归消除 采用转换为BNF范式的方法消除左递归\n例如加减表达式\nAddExp → MulExp | AddExp ('+' | '−') MulExp // 1.MulExp 2.+ 需覆盖 3.- 需覆盖 改写为\nAddExp → MulExp ('+' | '−') MulExp ('+' | '−') MulExp ... 改写完以后，构造**divideExp()**方法，将整个大的表达式进行分割，再依次调用子程序进行分析\nprivate Expressions (divideExp(ArrayList exp, ArrayList symbol):\n输入：表达式exp,分隔符列表\n返回：分割出的子表达式，分割符号列表 ———— return new Expressions(symbols, exps)\npublic Expressions divideExp(ArrayList\u003cTokenWord\u003e exp, ArrayList\u003cString\u003e symbol) { ArrayList\u003cArrayList\u003cTokenWord\u003e\u003e exps = new ArrayList\u003c\u003e(); ArrayList\u003cTokenWord\u003e tmpExp = new ArrayList\u003c\u003e(); ArrayList\u003cTokenWord\u003e symbols = new ArrayList\u003c\u003e(); boolean unaryFlag = false; int FlagSmall = 0; int FlagBig = 0; for (TokenWord word : exp) { switch (word.getClassCode()) { case \"LPARENT\": FlagSmall++; break; case \"RPARENT\": FlagSmall--; break; case \"LBRACK\": FlagBig++; break; case \"RBRACK\": FlagBig--; break; } //遇到指定分隔符，并且(),[]得到匹配 if (symbol.contains(word.getClassCode()) \u0026\u0026 FlagSmall == 0 \u0026\u0026 FlagBig == 0) { //如果分隔符是单目运算符 if (word.ClassCodeOfUnary()) { //如果上一个word不是识别符,),],int常数，那么不在此处分割，仅将当前word加入exp if (!unaryFlag) { tmpExp.add(word); continue; } } //如果上一个word不是识别符,),],int常数，向exps中加入当前表达式，并且重置表达式，向分隔符列表中加入当前word exps.add(tmpExp); symbols.add(word); tmpExp = new ArrayList\u003c\u003e(); } else { tmpExp.add(word); } unaryFlag = word.ClassCodeOf(\"IDENFR\") || word.ClassCodeOf(\"RPARENT\") || word.ClassCodeOf(\"INTCON\") || word.ClassCodeOf(\"RBRACK\"); } exps.add(tmpExp); return new Expressions(symbols, exps); } 最终例如加减表达式,分析代码如下\npublic void analyseAddExp(ArrayList\u003cTokenWord\u003e exp) { Expressions exps = divideExp(exp, new ArrayList\u003c\u003e(Arrays.asList(\"PLUS\", \"MINU\"))); int j = 0; for (ArrayList\u003cTokenWord\u003e tmpExp : exps.getExpressions()) { analyseMulExp(tmpExp); GrammarString.add(\"\"); if (j \u003c exps.getSymbols().size()) { GrammarString.add(exps.getSymbols().get(j++).toString()); } } } 五. 错误处理设计 1 总体设计 新定义类\n定义Error类，存放错误的类型，所在行数 定义Symbol类，type是指符号的类型,例如const,var,para。Dimension是一个整数,指出了符号的维数。如果为0，则符号为int。如果为1，则符号为int[]；如果为2，则符号为int[][]…。token是指Symbol的内容。layer就是这个符号所在的层级。 public Symbol(String type, int Dimension, TokenWord tokenWord, int layer) { this.type = type; this.Dimension = Dimension; this.token = tokenWord.getToken(); this.layer = layer; } 定义SymbolTable类来存放符号表，在其中用HashMap mapSymbol来存放符号，同时在其中定义了一些基础的方法\n定义Func类，分别记录函数名、函数返回类型（void，int）、以及函数的参数类型\n用ArrayList TypeOfParas来记录函数的参数类型，0、1、2分别代表着int,int[],int[][]\nType Example Integer Void （函数返回值为空） -1 Int a 0 Int[] a[] 1 Int[] [] a[] [3] 2 在GrammarAnalysis类中，我定义了如下几个新的变量\nprivate final ArrayList\u003cError\u003e errors = new ArrayList\u003c\u003e(); //函数名Hashmap private final HashMap\u003cString, Func\u003e funcs = new HashMap\u003c\u003e(); //层级layer对应符号表,每当进入一个新层级，就将layer++，新构造一个SymbolTables private final HashMap\u003cInteger, SymbolTable\u003e SymbolTables = new HashMap\u003c\u003e(); private int layer = -1; private boolean ReturnFlag = false;//表示当前函数是否需要返回。 private int IndexWhile = 0; //表示当前代码块是否在while中。 注意：\n在AnalyseBlock中对于一个自定义函数，与函数的参数是同一个Layer的（否则无法判断函数内部重复定义函数参数等错误）而对于main函数，进入到Block的时候，Layer要加1（main函数内部可以重复定义全局变量）\nprivate boolean analyseBlock(boolean fromFunc) { ... if (!fromFunc) { IncreaseLayer(); } ... if (!fromFunc) { DecreaseLayer(); } } 2 具体分析 Errors a 检查格式就好\npublic boolean IllegalFormatString() { int i = 1; while (i \u003c= content.length() - 2) { if (NormalChar(content.charAt(i))) { if (content.charAt(i) == '\\\\') { if (content.charAt(i + 1) != 'n') { return true; } } i++; } else { if (content.charAt(i) == '%' \u0026\u0026 content.charAt(i + 1) == 'd') { i++; } else { return true; } } } return false; } b c b: 对于变量、函数参数来说，每次我得到一个Ident识别符，检查是否有相同的符号被定义在同一层级。对于函数来说，直接查看funcs.containsKey(curTokenWord.getToken())。\n//判断当前区块是否有当前符号 b public boolean existSymbolInThisArea(TokenWord tokenWord) { return SymbolTables.get(layer).SymbolExist(tokenWord); } c: 检查所有层级的符号表，此函数符号是否已定义。函数直接查看funcs\nprivate boolean hasSymbol(Word word) { for (Symbols s : symbols.values()) { if (s.hasSymbol(word)) { return true; } } return false; } d e 首先，为了获取每一个函数参数（可能为表达式）的真实维数，我在语法分析器的递归下降过程中，按照Exp-\u003eAdd-\u003eMul-\u003eUnary-\u003ePrimary/Func-\u003eLval/Exp这个路径，每个分析函数分别返回维数（调用下一层获得），直到Lval。\npublic int analyseExp(ArrayList\u003cTokenWord\u003e exp) { int Dimension = analyseAddExp(exp); GrammarString.add(\"\"); return Dimension; } 在Lval中，结束递归调用，返回最终结果\n注意\n例如a[3][5],lval对应a[3],那么实际数组维数是1 考虑到a[b[3]]\nprivate int analyseLVal(ArrayList\u003cWord\u003e exp) { TokenWord Ident = exp.get(0); if (!existSymbol(Ident)) { Error(\"c\", Ident.getLineNum()); } GrammarString.add(Ident.toString());//Ident //若是数组\tif (exp.size() \u003e 1) { ArrayList\u003cTokenWord\u003e tmpExp = new ArrayList\u003c\u003e(); int flag = 0; //逐个扫描 for (int i = 1; i \u003c exp.size(); i++) { TokenWord word = exp.get(i); if (word.ClassCodeOf(\"LBRACK\")) { if (flag == 0) { Dimension++; //a[]这种，而不是a[[]](不能加维数) } flag++; if (flag == 1) { GrammarString.add(word.toString()); tmpExp = new ArrayList\u003c\u003e(); } else { tmpExp.add(word); } } else if (word.ClassCodeOf(\"RBRACK\")) { flag--; if (flag == 0) { analyseExp(tmpExp); GrammarString.add(word.toString()); } else { tmpExp.add(word); } } else { tmpExp.add(word); } } if (flag \u003e 0) { analyseExp(tmpExp); Error(\"k\", exp.get(exp.size() - 1).getLineNum()); // not sure } } GrammarString.add(\"\"); //如上注意 if (existSymbol(Ident)) { return getSymbol(Ident).getDimension() - Dimension; } else { return 0; } } 定义checkFuncParas函数来进行参数数目，参数维数判断,在分析analyseFuncRParams时进行调用\n//检查函数参数匹配问题 private void checkFuncParas(TokenWord funcName, ArrayList\u003cInteger\u003e standardTypeOfParas, ArrayList\u003cInteger\u003e nowTypeOfParas) { if (standardTypeOfParas.size() != nowTypeOfParas.size()) { Error(\"d\", funcName.getLineNum()); } else { for (int i = 0; i \u003c standardTypeOfParas.size(); i++) { if (!Objects.equals(standardTypeOfParas.get(i), nowTypeOfParas.get(i))) { Error(\"e\", funcName.getLineNum()); } } } } public void analyseFuncRParams(ArrayList\u003cTokenWord\u003e exp, TokenWord Ident, ArrayList\u003cInteger\u003e TypeOfParas) { ArrayList\u003cInteger\u003e nowParas = new ArrayList\u003c\u003e(); Expressions exps = divideExp(exp, new ArrayList\u003c\u003e(Collections.singletonList(\"COMMA\"))); int j = 0; for (ArrayList\u003cTokenWord\u003e tmpExp : exps.getExpressions()) { int Dimension = analyseExp(tmpExp); nowParas.add(Dimension); if (j \u003c exps.getSymbols().size()) { GrammarString.add(exps.getSymbols().get(j++).toString()); } } if (TypeOfParas != null) { checkFuncParas(Ident, TypeOfParas, nowParas); } GrammarString.add(\"\"); } 然后在analyseFuncRParams时，如果遇到了函数调用那么进行判断\nif (exp.size() \u003e 3) { //实参列表有东西 analyseFuncRParams(new ArrayList\u003c\u003e(exp.subList(2, exp.size() - 1)), Ident, TypeOfParas); } else { //实参列表没东西 if (TypeOfParas != null) { if (TypeOfParas.size() != 0) { Error(\"d\", Ident.getLineNum()); } } } f g 如果当前函数需要返回，会有一个全局变量 ReturnFlag来显示，初始化为false。其在analyseFuncDef()以及analyseMainFuncDef()中，得到赋值。\n对于f\n在分析Stmt中的RETURNTK时候，若 ReturnFlag为false,那么就产生**f**错误\n对于g\n定义了hasReturn变量，其在analyseBlock→BlockItem/Stmt→Stmt这条路径上进行调用传递，并作为返回值返回\n然后在analyseFuncDef()以及analyseMainFuncDef()中对ReturnFlag \u0026\u0026 !hasReturn进行判断，若是真则产生**g**错误\nh 判断是否为常数即可\nif (isConst(word)) { Error(\"h\", word.getLineNum()); } i j k 定义函数来检查，以）为例\n//检查右小括号 public void checkRightParent() { if (getNowWord().getClassCode().equals(\"RPARENT\")) { getWordMove(); } else { Error(\"j\", curTokenWord.getLineNum()); } } l 分析Stmt遇到PRINTFTK时，判断一下printf里面逗号的数量和STRCON中的要求输出数是否一致即可\nm 如果代码块在While循环中，则有一个全局变量WhileFlag表示,其值不为0。在遇到break或是continue的时候判断一下即可\n六. 生成代码设计 在这一部分中，我选择生成pcode代码。我设计了一种基于逆波兰表达式堆栈和符号表的虚拟Pcode代码,在进行语法分析的过程中，随之生成Pcode代码。 同时，我设计了执行它们的虚拟机。Pcode虚拟机是用于运行Pcode命令的虚构机器。 它由一个代码区(pcodes)、一个指令指针(EIP)、一个main函数指针(mainAddress）、一个堆栈（存放各种数值）、存放返回信息的数组、一个变量表var_table,一个函数表func_table和一个标签表label_table组成。\n在接下来的文章中，我将首先介绍如何生成pcode，然后介绍pcode如何执行。\n编码前设计 如何生成Pcode 新增的类 在PcodeGeneration包中，我新增了\nFunction类————记录函数声明在Pcodes代码中的位置以及其参数数量\npublic Function(int index, int argsNum) { this.StackOffset = index; this.ParamsNum = argsNum; } LabelCreator类————用于产生标签\nVariety类————记录变量在栈上的位置，维度数，各维数的数量\nRetInfo类————记录函数的返回地址（调用函数指令的下一条指令的EIP），调用函数前栈上的末尾位置（stack.size() - 1），虚拟机中当前的变量表（var_table），函数的参数数量，函数所需调用的参数数量，目前已有的参数数量\npublic RetInfo(int eip, int stackPtr, HashMap\u003cString, Variety\u003e varTable, int paramsNum, int callArgsNum, int nowArgsNum) { this.eip = eip; this.stackPtr = stackPtr; this.varTable = varTable; this.paramsNum = paramsNum; this.callParamsNum = callArgsNum; this.nowParamsNum = nowArgsNum; } Pcode类————记录一个Pcode指令的名称key,FirstValue,LastValue(如有)，同时规定了Pcode的规范化输出（label,func,call,print进行特殊考虑)\n@Override public String toString() { String first = \"\"; String second = \"\"; if (key.equals(PcodeKey.label)) { return FirstValue.toString() + \": \"; } if (key.equals(PcodeKey.func)) { return \"FUNC @\" + FirstValue.toString() + \":\"; } if (key.equals(PcodeKey.call)) { return \"$\" + FirstValue.toString(); } if (key.equals(PcodeKey.print)) { return key + \" \" + FirstValue; } if (FirstValue == null) { first = \"\"; } else { first = FirstValue.toString(); } if (SecondValue == null) { second = \"\"; } else { second = \", \" + SecondValue.toString(); } return key + \" \" + first + second; } PcodeKey枚举类，存放Pcode的基本指令名称,后面会详细介绍\n变量声明 如何区分不同的变量 根据唯一的作用域号区分不同作用域的变量，如：CurLayerId + \"_\" + Ident.getToken()。在这种情况下，除了递归函数调用以外，代码中不会多次重复出现该变量，可以通过将varTable到堆栈来解决。\n不区分const和var。\n非数组变量：新建一个变量var并让它指向堆栈顶部。如果它有初始化，push初始化的值进入堆栈（如果int x=q这种初始化，那么需要push q，然后再getvalue）。如果未初始化，则添加一个defaultvalue命令来将变量的默认初始值(我将其推入0)推送到堆栈。 数组变量：新建一个变量var并让它指向堆栈顶部。然后push其各维的维数，然后用dimarrayvar命令表示他是数组,如果它有初始化，依次push初始化的值进入堆栈。如果未初始化，则添加一个defaultvalue命令来将变量的默认初始值(我将其推入0)推送到堆栈。 如果是getint，那么加入getint eg：int x[1][3];\nvar 1_x push 1 push 3 dimarrayvar 1_x, 2 defaultvalue 1_x, 2 赋值语句 首先push待赋值的变量（若是数组，还需要push偏移量），然后利用getaddress计算并将变量的地址推送到堆栈顶部。然后分析赋值语句右侧的表达式，对于数值，直接push,对于表达式，利用getvalue获取表达式的值。（若是算术运算表达式，就先执行）在此之后，堆栈中有两个数字，即地址和值。利用pop将该值分配给该地址。\n变量取值 例如要取得x[0][2]的值\npush 2_x push 0 push 2 getvalue 2_x, 0 函数定义 直接Pcodes.add(new Pcode(PcodeKey.func, curTokenWord.getToken()));（mainfunc特殊定义）\n函数形参 fparam+名字+维数\n注意：若是数组，需要先push进去各维数量（二维形参，只需要push第二维数量）\n函数调用 实参类型\n数值：先push函数实参，再rparam+函数实参名字+维数,再call相应函数名\n变量：先push变量名\n若是数组，就getaddress加维数\n若是普通变量，就getvalue+维数；若是a[1][3]这种，就先push进去1,3，再getvalue\n剩下的操作同上\n函数返回 ret 0代表无返回值\nret 1代表有返回值，在ret之前会有push（由分析表达式产生）之类的，代表返回指的具体数值\n打印语句 Pcodes.add(new Pcode(PcodeKey.print, STRCON.getToken(), OutputNum)); 注意：打印变量，则按照老套路，先push变量，再getvalue例如printf(\"%d\",x);，则是push 2_x , getvalue 2_x, 0 print \"%d\"\n条件跳转控制语句 首先，我定义了三个ArrayList,分别存放着对应标签的HashMap\nprivate ArrayList\u003cHashMap\u003cString, String\u003e\u003e If_Labels = new ArrayList\u003c\u003e(); private ArrayList\u003cHashMap\u003cString, String\u003e\u003e While_Labels = new ArrayList\u003c\u003e(); private ArrayList\u003cHashMap\u003cInteger, String\u003e\u003e Cond_Labels = new ArrayList\u003c\u003e(); 每当遇到IFTK或其他判断语句时，生成相应标签\npublic void getNewIfLabel() { HashMap\u003cString, String\u003e tmpIfLabel = new HashMap\u003c\u003e(); tmpIfLabel.put(\"if\", LabelCreator.CreateLabel(\"if\")); tmpIfLabel.put(\"else\", LabelCreator.CreateLabel(\"else\")); tmpIfLabel.put(\"endif\", LabelCreator.CreateLabel(\"endif\")); tmpIfLabel.put(\"ifblock\", LabelCreator.CreateLabel(\"ifblock\")); If_Labels.add(tmpIfLabel); } 以if为例子\nif (word.ClassCodeOf(\"IFTK\")) { getNewIfLabel(); Pcodes.add(new Pcode(PcodeKey.label, If_Labels.get(If_Labels.size() - 1).get(\"if\"))); getWordMove();//if getWordMove();//( analyseCond(\"if\"); checkRightParent(); Pcodes.add(new Pcode(PcodeKey.jz, If_Labels.get(If_Labels.size() - 1).get(\"else\"))); Pcodes.add(new Pcode(PcodeKey.label, If_Labels.get(If_Labels.size() - 1).get(\"ifblock\"))); analyseStmt(); word = getNowWord(); Pcodes.add(new Pcode(PcodeKey.jmp, If_Labels.get(If_Labels.size() - 1).get(\"endif\"))); Pcodes.add(new Pcode(PcodeKey.label, If_Labels.get(If_Labels.size() - 1).get(\"else\"))); if (word.ClassCodeOf(\"ELSETK\")) { getWordMove(); //else analyseStmt(); } Pcodes.add(new Pcode(PcodeKey.label, If_Labels.get(If_Labels.size() - 1).get(\"endif\"))); If_Labels.remove(If_Labels.size() - 1); } while\nif (word.ClassCodeOf(\"WHILETK\")) { getNewWhileLabel(); Pcodes.add(new Pcode(PcodeKey.label, While_Labels.get(While_Labels.size() - 1).get(\"while\"))); getWordMove();//while IndexWhile++; getWordMove();//( analyseCond(\"while\"); checkRightParent(); Pcodes.add(new Pcode(PcodeKey.jz, While_Labels.get(While_Labels.size() - 1).get(\"endwhile\"))); Pcodes.add(new Pcode(PcodeKey.label, While_Labels.get(While_Labels.size() - 1).get(\"whileblock\"))); analyseStmt(); IndexWhile--; Pcodes.add(new Pcode(PcodeKey.jmp, While_Labels.get(While_Labels.size() - 1).get(\"while\"))); Pcodes.add(new Pcode(PcodeKey.label, While_Labels.get(While_Labels.size() - 1).get(\"endwhile\"))); While_Labels.remove(While_Labels.size() - 1); }//break else if (word.ClassCodeOf(\"BREAKTK\")) { getWordMove();//break if (IndexWhile == 0) { Error(\"m\", curTokenWord.getLineNum()); } checkSemicn(); Pcodes.add(new Pcode(PcodeKey.jmp, While_Labels.get(While_Labels.size() - 1).get(\"endwhile\"))); }//continue else if (word.ClassCodeOf(\"CONTINUETK\")) { getWordMove();//continue if (IndexWhile == 0) { Error(\"m\", curTokenWord.getLineNum()); } checkSemicn(); Pcodes.add(new Pcode(PcodeKey.jmp, While_Labels.get(While_Labels.size() - 1).get(\"while\"))); } 加减、乘除，比较运算表达式 以比较为例\npublic void analyseRelExp(ArrayList\u003cTokenWord\u003e exp) { Expressions exps = divideExp(exp, new ArrayList\u003c\u003e(Arrays.asList(\"LSS\", \"LEQ\", \"GRE\", \"GEQ\"))); int j = 0; for (ArrayList\u003cTokenWord\u003e tmpExp : exps.getExpressions()) { analyseAddExp(tmpExp); if (j \u003e 0 \u0026\u0026 j \u003c= exps.getExpressions().size()) { if (exps.getSymbols().get(j - 1).ClassCodeOf(\"LSS\")) { Pcodes.add(new Pcode(PcodeKey.cmplt)); } else if (exps.getSymbols().get(j - 1).ClassCodeOf(\"LEQ\")) { Pcodes.add(new Pcode(PcodeKey.cmple)); } else if (exps.getSymbols().get(j - 1).ClassCodeOf(\"GRE\")) { Pcodes.add(new Pcode(PcodeKey.cmpgt)); } else if (exps.getSymbols().get(j - 1).ClassCodeOf(\"GEQ\")) { Pcodes.add(new Pcode(PcodeKey.cmpge)); } } GrammarString.add(\"\"); if (j \u003c exps.getSymbols().size()) { GrammarString.add(exps.getSymbols().get(j++).toString()); } } } 需要注意的是，由于采用逆波兰表达式，当分析到第二个表达式的时候，其实j已经跳到第二个表达式后面了，所以需要判断的是j-1位置处\n如何运行Pcode Pcode虚拟机是用于运行Pcode命令的虚构机器。 它由一个代码区(pcodes)、一个指令指针(EIP)、一个main函数指针(mainAddress）、一个堆栈（存放各种数值）、存放返回信息的数组、一个变量表var_table,一个函数表func_table和一个标签表label_table组成。\n我定义了一个PcodeExecutor类，对应着我的Pcode虚拟机\nprivate int eip = 0; //mainAddress标记main函数的地址 private int mainAddress; private Scanner scanner; private ArrayList\u003cPcode\u003e pcodes; private ArrayList\u003cRetInfo\u003e retInfos = new ArrayList\u003c\u003e(); //模拟存放各种数值的栈 private ArrayList\u003cInteger\u003e stack = new ArrayList\u003c\u003e(); private HashMap\u003cString, Variety\u003e varTable = new HashMap\u003c\u003e(); private HashMap\u003cString, Function\u003e funcTable = new HashMap\u003c\u003e(); //label对应的代码行数(eip) private HashMap\u003cString, Integer\u003e labelTable = new HashMap\u003c\u003e(); 初始化 将scanner和pcode代码初始化，同时扫描Pcode代码,将扫描到的标签(名称，位置）加入标签表，函数（名称，function）加入函数表，\npublic PcodeExecutor(ArrayList\u003cPcode\u003e pcodes, Scanner sc) { this.pcodes = pcodes; this.scanner = sc; int index = 0; while (index \u003c pcodes.size()) { Pcode pcode = pcodes.get(index); switch (pcode.getKey()) { case label: labelTable.put(pcode.getFirstValue().toString(), index); break; case func: funcTable.put(pcode.getFirstValue().toString(), new Function(index, (int) pcode.getSecondValue())); break; case mainfunc: mainAddress = index; break; } index++; } } 基本操作 获取变量 如果当前变量表中存在该变量，则直接返回，否则在全局变量中寻找\nprivate Variety getVar(String varName) { if (varTable.containsKey(varName)) { return varTable.get(varName); } else { //全局变量 return retInfos.get(0).getVarTable().get(varName); } } push、pop private void push(int value) { stack.add(value); } //弹出并返回 private int pop() { int value = stack.get(stack.size() - 1); stack.remove(stack.size() - 1); return value; } 获取变量在栈上的绝对地址 注意这里的维数是相对的 for example, to int a[3][2] ,a[0][0] is 0, a[0] is 1, a is 2 a[3][2],SecondDim:2;FirstDim:3\nprivate int getAddress(Variety var, int Dimension) { int Address = 0; int n = var.getDimension() - Dimension; if (n == 0) { Address = var.getOffset(); } if (n == 1) { int i = pop(); if (var.getDimension() == 1) { Address = var.getOffset() + i; } else { Address = var.getOffset() + i * var.getSecondDimNum(); } } if (n == 2) { int i = pop(); int j = pop(); Address = var.getOffset() + j * var.getSecondDimNum() + i; } return Address; } 运行代码 首先定义几个变量\n//已经存在的参数数量 int ExistParamsNum = 0; //调用所需的参数数量 int CallParamsNum = 0; boolean MainFuncFlag = false; //函数实参对应的栈上的地址列表 ArrayList\u003cInteger\u003e rparams = new ArrayList\u003c\u003e(); var 产生新的变量，置于stack末尾，放进变量表\ncase var: { Variety var = new Variety(stack.size()); varTable.put((String) pcode.getFirstValue(), var); } push //对于数字的话，push进栈里 case push: { if (pcode.getFirstValue() instanceof Integer) { push((int) pcode.getFirstValue()); } } pop pop操作:*value1 = value2 在我的定义中，我会在变量赋值以前依次将其在栈中对应的地址以及所赋的值压进栈中\ncase pop: { int value = pop(); int address = pop(); stack.set(address, value); } 计算 Calculation Type\nTwo operators:\nint b = pop(); int a = pop(); push(cal(a,b)); Single operator:\npush(cal(pop())); 数组维数 声明变量维数,紧跟着的是维数\ncase dimarrayvar: { Variety var = getVar((String) pcode.getFirstValue()); int dimension = (int) pcode.getSecondValue(); var.setDimension(dimension); if (dimension == 2) { var.setSecondDimNum(pop()); var.setFirstDimNum(pop()); } if (dimension == 1) { var.setFirstDimNum(pop()); } } 占位符 case defaultvalue: { Variety var = getVar((String) pcode.getFirstValue()); int dimension = (int) pcode.getSecondValue(); if (dimension == 0) { push(0); } if (dimension == 1) { for (int i = 0; i \u003c var.getFirstDimNum(); i++) { push(0); } } if (dimension == 2) { for (int i = 0; i \u003c var.getFirstDimNum() * var.getSecondDimNum(); i++) { push(0); } } } getint 读取int\ncase getint: { int value = scanner.nextInt(); push(value); } 跳转 如果是条件跳转，取出stack中最后一个值判断\n函数定义 main函数\ncase mainfunc: { MainFuncFlag = true; //retInfos[0] storage 全局变量(varTable) retInfos.add(new RetInfo(pcodes.size(), stack.size() - 1, varTable, 0, 0, 0)); varTable = new HashMap\u003c\u003e(); } 自定义函数\n遇见func定义的话，均先进入到main函数中，等到调用的时候再跳转\ncase func: { int flag = MainFuncFlag ? 1 : 0; if (flag == 0) { eip = mainAddress - 1; } } 函数调用 总体上来说，就是遇到函数调用-\u003e存实参数（值/地址）-\u003e存下retInfo，产生新变量表（用于函数），跳转到定义处-\u003e遇到形参，依次存入新变量表-\u003e遇到ret，进行返回，将原retinfo还原\nFirst, before function call, there will be some parameters to be pushed into the stack. Each will be followed by a rparam command, which memorize the address of the previous variety.\n注意：对于传值实参，若是数组具体到某个数（本质是传具体值），对应操作先push各维度，再getvalue，若是具体数值，就是push数值，因此直接rparams.add(stack.size() - 1)。对于传地址参数，则是先push数组名，再getaddress，因此需要将其地址压入\ncase rparam: { int dimension = (int) pcode.getSecondValue(); if (dimension == 0) { //对于非数组的参数，直接将其值压入栈中 //因此其地址是栈顶的地址 rparams.add(stack.size() - 1); } else { //对于数组的参数，将其地址压入栈中 rparams.add(stack.get(stack.size() - 1)); } } Second, function CALL.\nMemorize the eip, stack top address, and information about the function(In fact, they will be pushed into stack too). Then update the varTable and eip. Ready for execute function.\ncase call: { Function func = funcTable.get((String) pcode.getFirstValue()); retInfos.add(new RetInfo(eip, stack.size() - 1, varTable, func.getParamsNum(), func.getParamsNum(), ExistParamsNum)); //跳转至函数定义处 eip = func.getOffset(); varTable = new HashMap\u003c\u003e(); CallParamsNum = func.getParamsNum(); ExistParamsNum = 0; } Finally, return when it’s RET\nRestore eip, varTable from RetInfo, clear the new information pushed when function in the stack.\ncase ret: { int type = (int) pcode.getFirstValue(); RetInfo retInfo = retInfos.remove(retInfos.size() - 1); eip = retInfo.getEip(); varTable = retInfo.getVarTable(); CallParamsNum = retInfo.getCallParamsNum(); ExistParamsNum = retInfo.getNowParamsNum(); if (type == 1) { //有返回值的话，由于之前将返回值压入栈中，故需要保留栈顶元素 stack.subList(retInfo.getStackPtr() + 1 - retInfo.getParamsNum(), stack.size() - 1).clear(); } else { stack.subList(retInfo.getStackPtr() + 1 - retInfo.getParamsNum(), stack.size()).clear(); } } Additional：\n储存完实参，调用函数以后跳转到函数定义的地方\nfparam:Firstvalue:Ident_name Secondvalue:Type/Dimension\ncase fparam: { //函数现在需要的形参的index int nowfparamIndex = rparams.size() - CallParamsNum + ExistParamsNum; int addressOnStack = rparams.get(nowfparamIndex); Variety fparam = new Variety(addressOnStack); int dimension = (int) pcode.getSecondValue(); fparam.setDimension(dimension); //二维数组需要将第二维大小作为参数传入 if (dimension == 2) { fparam.setSecondDimNum(pop()); } varTable.put((String) pcode.getFirstValue(), fparam); ExistParamsNum++; //如果形参已经全部生成，就清空rparams数组里对应的其形参 if (ExistParamsNum == CallParamsNum) { rparams.subList(rparams.size() - CallParamsNum, rparams.size()).clear(); } } break; 打印输出 print:Firstvalue:String Secondvalue:output num quantity\ncase print: { String str = (String) pcode.getFirstValue(); int num = (int) pcode.getSecondValue(); int q = num - 1; StringBuilder sb = new StringBuilder(); ArrayList\u003cInteger\u003e OutParams = new ArrayList\u003c\u003e(); for (int i = 0; i \u003c num; i++) { OutParams.add(pop()); } for (int j = 0; j \u003c str.length(); j++) { if (j \u003c str.length() - 1) { if (str.charAt(j) == '%' \u0026\u0026 str.charAt(j + 1) == 'd') { sb.append(OutParams.get(q--).toString()); j++; continue; } } sb.append(str.charAt(j)); } //除去引号 OutputString.add(sb.substring(1, sb.length() - 1)); } break; 获取变量的值，地址 Firstvalue:Ident_name Secondvalue:Dimension\ncase getvalue: { Variety var = getVar((String) pcode.getFirstValue()); int dimension = (int) pcode.getSecondValue(); int address = getAddress(var, dimension); push(stack.get(address)); } break; //获得变量在栈上的地址，给定变量名和维度 case getaddress: { Variety var = getVar((String) pcode.getFirstValue()); int dimension = (int) pcode.getSecondValue(); int address = getAddress(var, dimension); push(address); } break; 编码后设计 小细节问题 在GrammarAnalysis中，新增CurLayerId变量，注意和layer区分\n前者为了区分符号表内变量所处层级，因此不考虑出区块减一，而后者用来构造符号表的HashMap，有并列关系，所以出了区块就要减一\n两者每次新进入一个区块之后，都会加一\n但是退出一个区块的时候，前者不会减一，而后者依旧减一\npublic void addSymbol(TokenWord tokenWord, String type, int Dimension, int CurLayerId) { SymbolTables.get(layer).SymbolInsert(type, Dimension, tokenWord, CurLayerId); } Pcode代码对应表 Common Type CodeType Value1 Value2 Operation label label_name set a label var ident_name declare a variety push ident_name/digit push(value1) pop ident_name 在pop命令以前push进来的赋值语句右面的式子的值 *value1 = value2（这个value2指的是在pop命令以前push进来的赋值语句右面的式子的值） jz label_name jump if stack top is zero jnz label_name jump if stack top is not zero jmp label_name jump unconditionally main main function label func function label endfunc end of function label fparam ident_name dimension/type 函数形参parameters ret return value or not（0：void；1：int） function return（ret 0无返回值，1有返回值） call function name function call rparam ident_name dimension 函数实参get parameters ready for function call getint get a integer and put it into stack top print string para num pop values and print. dimarrayvar ident_name type/dimension set dimension info for array variety getvalue ident_name type/dimension 对于普通变量，get the variety value getaddress ident_name type/dimension 对于数组，get the variety address defaultvalue ident_name type/dimension push something to hold places exit exit 运算比较 CodeType Value1 Value2 Operation add + sub - mul * div / mod % cmpeq == cmpne != cmpgt \u003e cmplt \u003c cmpge \u003e= cmple \u003c= and \u0026\u0026 or || not ! neg - pos + 短路求值问题 There are two situations I need to use short circuit calculation :\n1. if(a\u0026\u0026b) // a is false 2. if(a||b) // a is true My method is as follows:\nFirst, when I analyze analyseLOrExp, every analyseLAndExp will be followed by a JNZ, which is used for detect if the cond is true. If it is, jump to the if body label. At the same time, I generated cond label, which is ready for the analyseLAndExp.\nprivate void analyseLOrExp(ArrayList\u003cWord\u003e exp, String from) { ... for (...) { ... String label = labelGenerator.getLabel(\"cond_\" + i); analyseLAndExp(exp1, from, label); codes.add(new PCode(CodeType.LABEL, label)); if (...) { codes.add(new PCode(CodeType.OR)); } if (...) { if (...) { codes.add(new PCode(CodeType.JNZ, ifLabels.get(ifLabels.size() - 1).get(\"if_block\"))); } ... } ... } } In the analyseLAndExp, every analyseEqExp will be followed by a JZ, which is used for detect if the cond is true. If it is not, jump to the cond label I set just now.\nprivate void analyseLAndExp(ArrayList\u003cWord\u003e exp, String from, String label) { ... for (...) { ... analyseEqExp(exp1); if (...) { codes.add(new PCode(CodeType.AND)); } if (...) { if (...) { codes.add(new PCode(CodeType.JZ, label)); } ... } } } By these means, short circuit calculation is solved.\n七. 代码示例 int y=3; int b[1][3]={{1,2,3}}; int func(int x[][3]) { return x[0][2]+y; } int func2(int a) { int s=a+b; return a; } int main(){ int q=3; int x=q; int z; int y=func(b); z=func2(3); printf(\"%d\",3); return 0; } var 0_y push 3 var 0_b push 1 push 3 dimarrayvar 0_b, 2 push 1 push 2 push 3 FUNC @func: push 3 fparam 1_x, 2 push 1_x push 0 push 2 getvalue 1_x, 0 push 0_y getvalue 0_y, 0 add ret 1 endfunc FUNC @func2: fparam 2_a, 0 var 2_s push 2_a getvalue 2_a, 0 push 0_b getaddress 0_b, 2 add push 2_a getvalue 2_a, 0 ret 1 endfunc mainfunc main var 3_q push 3 var 3_x push 3_q getvalue 3_q, 0 var 3_z defaultvalue 3_z, 0 var 3_y push 0_b getaddress 0_b, 2 rparam b, 2 $func push 3_z getaddress 3_z, 0 push 3 rparam 3, 0 $func2 pop 3_z push 3 print \"%d\" push 0 ret 1 exit ",
  "wordCount" : "11138",
  "inLanguage": "en",
  "image":"https://mksasx.github.io/posts/tech/os/great.png","datePublished": "2022-12-30T12:31:30+08:00",
  "dateModified": "2022-12-30T12:31:30+08:00",
  "author":[{
    "@type": "Person",
    "name": "AustinMa"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mksasx.github.io/posts/tech/compile/summary/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AustinMa's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mksasx.github.io/img/1.jpg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mksasx.github.io/" accesskey="h" title="AustinMa&#39;s Blog (Alt + H)">
            <img src="https://mksasx.github.io/img/Avator.jpg" alt="logo" aria-label="logo"
                 height="35">AustinMa&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mksasx.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/posts" title="📚 文章">
                <span>📚 文章</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/archives/" title="⏱ 时间轴">
                <span>⏱ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://mksasx.github.io/links" title="🤝 友链">
                <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs" style="margin-bottom: 5px;"><a href="https://mksasx.github.io/">🏠主页</a>&nbsp;»&nbsp;<a href="https://mksasx.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://mksasx.github.io/posts/tech/">👨🏻‍💻 技术</a>&nbsp;»&nbsp;<a href="https://mksasx.github.io/posts/tech/compile/">⚛️ 编译</a></div>
            <h1 class="post-title">
                编译期末总结文档
            </h1>
            <div class="post-description">
                这是我的编译课程期末总结文档
            </div>
            <div class="post-meta">创建:&nbsp;<span title='2022-12-30 12:31:30 +0800 CST'>2022-12-30</span>&nbsp;|&nbsp;更新:&nbsp;2022-12-30&nbsp;|&nbsp;字数:&nbsp;11138字&nbsp;|&nbsp;时长:&nbsp;23分钟&nbsp;|&nbsp;
作者:&nbsp;AustinMa



                &nbsp;|&nbsp;标签: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://mksasx.github.io/tags/compiler/">Compiler</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| 访问: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
<figure class="entry-cover1"><img loading="lazy" src="https://mksasx.github.io/posts/tech/os/great.png" alt="">
        
</figure>
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%bc%96%e8%af%91%e8%ae%be%e8%ae%a1%e6%96%87%e6%a1%a3" aria-label="编译设计文档">编译设计文档</a><ul>
                        
                <li>
                    <a href="#%e4%b8%80-%e5%8f%82%e8%80%83%e7%bc%96%e8%af%91%e5%99%a8%e4%bb%8b%e7%bb%8d" aria-label="一. 参考编译器介绍">一. 参考编译器介绍</a></li>
                <li>
                    <a href="#%e4%ba%8c-%e7%bc%96%e8%af%91%e5%99%a8%e6%80%bb%e4%bd%93%e8%ae%be%e8%ae%a1" aria-label="二. 编译器总体设计">二. 编译器总体设计</a><ul>
                        
                <li>
                    <a href="#%e6%80%bb%e4%bd%93%e7%bb%93%e6%9e%84" aria-label="总体结构">总体结构</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e7%bb%84%e7%bb%87" aria-label="文件组织">文件组织</a></li>
                <li>
                    <a href="#%e7%b1%bb%e5%9b%be" aria-label="类图">类图</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%89-%e8%af%8d%e6%b3%95%e5%88%86%e6%9e%90%e8%ae%be%e8%ae%a1" aria-label="三. 词法分析设计">三. 词法分析设计</a><ul>
                        
                <li>
                    <a href="#1-%e6%80%bb%e8%bf%b0" aria-label="1 总述">1 总述</a></li>
                <li>
                    <a href="#2-%e5%ae%9e%e7%8e%b0" aria-label="2 实现">2 实现</a><ul>
                        
                <li>
                    <a href="#21-%e6%96%87%e4%bb%b6%e8%af%bb%e5%86%99" aria-label="2.1 文件读写">2.1 文件读写</a></li>
                <li>
                    <a href="#22-%e8%af%8d%e6%b3%95%e5%88%86%e6%9e%90%e8%bf%87%e7%a8%8b" aria-label="2.2 词法分析过程">2.2 词法分析过程</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c" aria-label="准备工作">准备工作</a></li>
                <li>
                    <a href="#%e5%85%b7%e4%bd%93%e5%88%86%e6%9e%90" aria-label="具体分析">具体分析</a><ul>
                        
                <li>
                    <a href="#%e9%80%90%e4%b8%aa%e5%ad%97%e7%ac%a6%e8%af%bb%e5%85%a5" aria-label="逐个字符读入">逐个字符读入</a></li>
                <li>
                    <a href="#%e8%b7%b3%e8%bf%87%e6%8d%a2%e8%a1%8c%e7%a9%ba%e6%a0%bctr" aria-label="跳过换行、空格、\t、\r">跳过换行、空格、<code>\t</code>、<code>\r</code></a></li>
                <li>
                    <a href="#%e6%a0%87%e8%af%86%e7%ac%a6" aria-label="标识符">标识符</a></li>
                <li>
                    <a href="#intcon" aria-label="INTCON">INTCON</a></li>
                <li>
                    <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2" aria-label="字符串">字符串</a></li>
                <li>
                    <a href="#%e5%8d%95%e4%b8%aa%e5%ad%97%e7%ac%a6%e6%88%96%e8%80%85%e5%bf%85%e9%a1%bb%e4%b8%a4%e4%b8%aa%e5%ad%97%e7%ac%a6%e7%9a%84tokenword" aria-label="单个字符或者必须两个字符的TokenWord">单个字符或者必须两个字符的<code>TokenWord</code></a></li>
                <li>
                    <a href="#%e5%8f%af%e8%83%bd%e6%98%af%e5%8d%95%e4%b8%aa%e4%b9%9f%e5%8f%af%e8%83%bd%e4%b8%a4%e4%b8%aa%e5%ad%97%e7%ac%a6%e7%9a%84tokenword" aria-label="可能是单个也可能两个字符的TokenWord">可能是单个也可能两个字符的<code>TokenWord</code></a></li>
                <li>
                    <a href="#%e6%b3%a8%e9%87%8a" aria-label="注释">注释</a></li></ul>
                </li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%9b%9b-%e8%af%ad%e6%b3%95%e5%88%86%e6%9e%90%e8%ae%be%e8%ae%a1" aria-label="四. 语法分析设计">四. 语法分析设计</a><ul>
                        
                <li>
                    <a href="#1-%e6%80%bb%e8%bf%b0-1" aria-label="1 总述">1 总述</a></li>
                <li>
                    <a href="#2-%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0" aria-label="2 具体实现">2 具体实现</a><ul>
                        
                <li>
                    <a href="#21-%e8%8e%b7%e5%8f%96%e8%a1%a8%e8%be%be%e5%bc%8f--getexpression" aria-label="2.1 获取表达式&amp;ndash;getExpression">2.1 获取表达式&ndash;<code>getExpression</code></a></li>
                <li>
                    <a href="#22-%e9%80%92%e5%bd%92%e4%b8%8b%e9%99%8d" aria-label="2.2 递归下降">2.2 递归下降</a></li>
                <li>
                    <a href="#23-%e5%b7%a6%e9%80%92%e5%bd%92%e6%b6%88%e9%99%a4" aria-label="2.3 左递归消除">2.3 左递归消除</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%94-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e8%ae%be%e8%ae%a1" aria-label="五. 错误处理设计">五. 错误处理设计</a><ul>
                        
                <li>
                    <a href="#1-%e6%80%bb%e4%bd%93%e8%ae%be%e8%ae%a1" aria-label="1 总体设计">1 总体设计</a></li>
                <li>
                    <a href="#2-%e5%85%b7%e4%bd%93%e5%88%86%e6%9e%90-errors" aria-label="2 具体分析 Errors">2 具体分析 Errors</a><ul>
                        
                <li>
                    <a href="#a" aria-label="a">a</a></li>
                <li>
                    <a href="#b-c" aria-label="b c">b c</a></li>
                <li>
                    <a href="#d-e" aria-label="d e">d e</a></li>
                <li>
                    <a href="#f-g" aria-label="f g">f g</a></li>
                <li>
                    <a href="#h" aria-label="h">h</a></li>
                <li>
                    <a href="#i-j-k" aria-label="i j k"><strong>i j k</strong></a></li>
                <li>
                    <a href="#l" aria-label="l">l</a></li>
                <li>
                    <a href="#m" aria-label="m">m</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%85%ad-%e7%94%9f%e6%88%90%e4%bb%a3%e7%a0%81%e8%ae%be%e8%ae%a1" aria-label="六. 生成代码设计">六. 生成代码设计</a><ul>
                        
                <li>
                    <a href="#%e7%bc%96%e7%a0%81%e5%89%8d%e8%ae%be%e8%ae%a1" aria-label="编码前设计">编码前设计</a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e7%94%9f%e6%88%90pcode" aria-label="如何生成Pcode">如何生成Pcode</a><ul>
                        
                <li>
                    <a href="#%e6%96%b0%e5%a2%9e%e7%9a%84%e7%b1%bb" aria-label="新增的类">新增的类</a></li>
                <li>
                    <a href="#%e5%8f%98%e9%87%8f%e5%a3%b0%e6%98%8e" aria-label="变量声明">变量声明</a></li>
                <li>
                    <a href="#%e8%b5%8b%e5%80%bc%e8%af%ad%e5%8f%a5" aria-label="赋值语句">赋值语句</a></li>
                <li>
                    <a href="#%e5%8f%98%e9%87%8f%e5%8f%96%e5%80%bc" aria-label="变量取值">变量取值</a></li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e5%ae%9a%e4%b9%89" aria-label="函数定义"><strong>函数定义</strong></a></li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e5%bd%a2%e5%8f%82" aria-label="函数形参">函数形参</a></li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8" aria-label="函数调用">函数调用</a></li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e8%bf%94%e5%9b%9e" aria-label="函数返回">函数返回</a></li>
                <li>
                    <a href="#%e6%89%93%e5%8d%b0%e8%af%ad%e5%8f%a5" aria-label="打印语句">打印语句</a></li>
                <li>
                    <a href="#%e6%9d%a1%e4%bb%b6%e8%b7%b3%e8%bd%ac%e6%8e%a7%e5%88%b6%e8%af%ad%e5%8f%a5" aria-label="条件跳转控制语句">条件跳转控制语句</a></li>
                <li>
                    <a href="#%e5%8a%a0%e5%87%8f%e4%b9%98%e9%99%a4%e6%af%94%e8%be%83%e8%bf%90%e7%ae%97%e8%a1%a8%e8%be%be%e5%bc%8f" aria-label="加减、乘除，比较运算表达式">加减、乘除，比较运算表达式</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e8%bf%90%e8%a1%8cpcode" aria-label="如何运行Pcode">如何运行Pcode</a><ul>
                        
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="初始化">初始化</a></li>
                <li>
                    <a href="#%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c" aria-label="基本操作">基本操作</a><ul>
                        
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e5%8f%98%e9%87%8f" aria-label="获取变量">获取变量</a></li>
                <li>
                    <a href="#pushpop" aria-label="push、pop">push、pop</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e5%8f%98%e9%87%8f%e5%9c%a8%e6%a0%88%e4%b8%8a%e7%9a%84%e7%bb%9d%e5%af%b9%e5%9c%b0%e5%9d%80" aria-label="获取变量在栈上的绝对地址">获取变量在栈上的绝对地址</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%90%e8%a1%8c%e4%bb%a3%e7%a0%81" aria-label="运行代码">运行代码</a><ul>
                        
                <li>
                    <a href="#var" aria-label="var">var</a></li>
                <li>
                    <a href="#push" aria-label="push">push</a></li>
                <li>
                    <a href="#pop" aria-label="pop">pop</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97" aria-label="计算">计算</a></li>
                <li>
                    <a href="#%e6%95%b0%e7%bb%84%e7%bb%b4%e6%95%b0" aria-label="数组维数">数组维数</a></li>
                <li>
                    <a href="#%e5%8d%a0%e4%bd%8d%e7%ac%a6" aria-label="占位符">占位符</a></li>
                <li>
                    <a href="#getint" aria-label="getint">getint</a></li>
                <li>
                    <a href="#%e8%b7%b3%e8%bd%ac" aria-label="跳转">跳转</a></li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e5%ae%9a%e4%b9%89-1" aria-label="函数定义">函数定义</a></li>
                <li>
                    <a href="#%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8-1" aria-label="函数调用">函数调用</a></li>
                <li>
                    <a href="#%e6%89%93%e5%8d%b0%e8%be%93%e5%87%ba" aria-label="打印输出">打印输出</a></li>
                <li>
                    <a href="#%e8%8e%b7%e5%8f%96%e5%8f%98%e9%87%8f%e7%9a%84%e5%80%bc%e5%9c%b0%e5%9d%80" aria-label="获取变量的值，地址">获取变量的值，地址</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%bc%96%e7%a0%81%e5%90%8e%e8%ae%be%e8%ae%a1" aria-label="编码后设计">编码后设计</a><ul>
                        
                <li>
                    <a href="#%e5%b0%8f%e7%bb%86%e8%8a%82%e9%97%ae%e9%a2%98" aria-label="小细节问题">小细节问题</a></li>
                <li>
                    <a href="#pcode%e4%bb%a3%e7%a0%81%e5%af%b9%e5%ba%94%e8%a1%a8" aria-label="Pcode代码对应表">Pcode代码对应表</a><ul>
                        
                <li>
                    <a href="#common-type" aria-label="Common Type">Common Type</a></li>
                <li>
                    <a href="#%e8%bf%90%e7%ae%97%e6%af%94%e8%be%83" aria-label="运算比较">运算比较</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%9f%ad%e8%b7%af%e6%b1%82%e5%80%bc%e9%97%ae%e9%a2%98" aria-label="短路求值问题">短路求值问题</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%83-%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b" aria-label="七. 代码示例">七. 代码示例</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="编译设计文档">编译设计文档<a hidden class="anchor" aria-hidden="true" href="#编译设计文档">#</a></h1>
<blockquote>
<p>姓名：马泽远</p>
<p>学号：20373793</p>
</blockquote>
<h2 id="一-参考编译器介绍">一. 参考编译器介绍<a hidden class="anchor" aria-hidden="true" href="#一-参考编译器介绍">#</a></h2>
<p>Pcode代码生成部分（包括Pcode代码执行）部分参考了<a href="https://pandolia.net/tinyc/index.html">《自己动手写编译器》</a>。</p>
<p>其余部分参考了往年的编译指导文档，包括一些往届学长的编译器设计架构</p>
<h2 id="二-编译器总体设计">二. 编译器总体设计<a hidden class="anchor" aria-hidden="true" href="#二-编译器总体设计">#</a></h2>
<h3 id="总体结构">总体结构<a hidden class="anchor" aria-hidden="true" href="#总体结构">#</a></h3>
<p>我的编译器总体结构按照编译的顺序，即<strong>词法分析</strong>、<strong>语法分析</strong>、<strong>语义分析</strong>、<strong>代码生成</strong>，分为四个部分。</p>
<ul>
<li>
<p>有几个类用来定义基本的一些需要用到的变量，比如**<code>TokenWord</code>类<strong>对应着</strong>单词类**，其属性包括<strong>单词内容，类别码，所在行数</strong>。类似的，还有**<code>Symbol</code>类<strong>对应着</strong>符号类**,<strong><code>Expressions</code>类</strong>对应着<strong>表达式类</strong>,<strong>用于表示一个具有多个表达式的大表达式</strong>，以及**<code>SymbolTable</code>类<strong>对应着</strong>符号表类**，<strong><code>Func</code>类</strong>对应着<strong>函数类</strong>，还有**<code>Error</code>类**。</p>
</li>
<li>
<p>另外的几个类，则是分别对应着相应的几个编译器<strong>执行过程</strong>，<strong><code>LexicalAanlysis</code>类</strong>对应<strong>词法分析</strong>，<strong><code>GrammarAanlysis</code>类</strong>综合了<strong>语法分析，语义分析、错误处理，以及生成中间代码（Pcode码）</strong></p>
</li>
<li>
<p>而对于<code>Pcode</code>的<code>定义，执行</code>则是单独设置了一个文件包**<code>PcodeGeneration</code><strong>,其中包含对</strong><code>Pcode</code><strong>的</strong><code>Function</code><strong>、</strong><code>Execute</code><strong>，</strong><code>retinfo</code><strong>，</strong><code>variety</code>**以及其本身。</p>
</li>
<li>
<p><strong><code>Compiler</code>类</strong>对应着编译器的总入口。在其中，依次调用**<code>LexicalAanlysis</code><strong>，</strong><code>GrammarAanlysis</code><strong>，</strong><code>PcodeExecutor</code><strong>类，即可完成</strong>词法分析<strong>到</strong>语法分析<strong>到</strong>语义分析<strong>到</strong>代码生成<strong>的整个过程，形成了类似一个</strong>单向链**，每一个部分都是一个<strong>单独的模块</strong>。</p>
</li>
</ul>
<h3 id="文件组织">文件组织<a hidden class="anchor" aria-hidden="true" href="#文件组织">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>src 
</span></span><span style="display:flex;"><span>│  Compiler.java <span style="color:#75715e">#入口程序</span>
</span></span><span style="display:flex;"><span>│  Error.java <span style="color:#75715e">#错误类</span>
</span></span><span style="display:flex;"><span>│  Expressions.java <span style="color:#75715e">#表达式类</span>
</span></span><span style="display:flex;"><span>│  Func.java <span style="color:#75715e">#函数类</span>
</span></span><span style="display:flex;"><span>│  GrammarAnalysis.java <span style="color:#75715e">#语法分析、错误处理、代码生成类</span>
</span></span><span style="display:flex;"><span>│  lexicalAnalysis.java <span style="color:#75715e">#词法分析类</span>
</span></span><span style="display:flex;"><span>│  Symbol.java <span style="color:#75715e">#符号类</span>
</span></span><span style="display:flex;"><span>│  SymbolTable.java <span style="color:#75715e">#符号表类</span>
</span></span><span style="display:flex;"><span>│  TokenWord.java <span style="color:#75715e">#单词类</span>
</span></span><span style="display:flex;"><span>└─PcodeGeneration
</span></span><span style="display:flex;"><span>        Function.java <span style="color:#75715e">#Pcode中的函数类</span>
</span></span><span style="display:flex;"><span>        LabelCreator.java <span style="color:#75715e">#标签制造</span>
</span></span><span style="display:flex;"><span>        Pcode.java <span style="color:#75715e">#Pcode代码类</span>
</span></span><span style="display:flex;"><span>        PcodeExecutor.java <span style="color:#75715e">#Pcode运行虚拟机类</span>
</span></span><span style="display:flex;"><span>        PcodeKey.java <span style="color:#75715e">#枚举Pcode中的关键词</span>
</span></span><span style="display:flex;"><span>        RetInfo.java <span style="color:#75715e">#返回信息类</span>
</span></span><span style="display:flex;"><span>        Variety.java <span style="color:#75715e">#变量类</span>
</span></span></code></pre></div><h3 id="类图">类图<a hidden class="anchor" aria-hidden="true" href="#类图">#</a></h3>
<p><img loading="lazy" src="https://s2.51cto.com/images/blog/202107/21/b457fccfffcc3bccbf2a0025475ea7f8.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184" alt="image-20221129093419595(1)"  />
</p>
<h2 id="三-词法分析设计">三. 词法分析设计<a hidden class="anchor" aria-hidden="true" href="#三-词法分析设计">#</a></h2>
<h3 id="1-总述">1 总述<a hidden class="anchor" aria-hidden="true" href="#1-总述">#</a></h3>
<p>词法分析的总任务是从源程序中识别出单词，记录单词类别和单词值。在词法分析的设计中给了一张表，其中有三项是加粗说明的，分别是 <strong><code>变量名（Ident）</code></strong>，<strong><code>整常数（IntConst）</code></strong> 和 <strong><code>格式字符串（FormatString）</code></strong> 而剩下都可以认为是 <strong><code>特殊字符</code></strong>。</p>
<p>词法分析的作业本质上就是把文件转换成一个个的词，在之后的文章中我们称之为 <strong><code>TokenWord</code></strong>。然后再把分出来的**<code>TokenWord</code>**进行类别的判断，最后输出。</p>
<h3 id="2-实现">2 实现<a hidden class="anchor" aria-hidden="true" href="#2-实现">#</a></h3>
<h4 id="21-文件读写">2.1 文件读写<a hidden class="anchor" aria-hidden="true" href="#21-文件读写">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>InputStreamReader Reader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InputStreamReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;testfile.txt&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>BufferedReader bufferedReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader<span style="color:#f92672">(</span>Reader<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>OutputStreamWriter Writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> OutputStreamWriter<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;output.txt&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;UTF-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>BufferedWriter bufferedWriter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedWriter<span style="color:#f92672">(</span>Writer<span style="color:#f92672">);</span>
</span></span></code></pre></div><p>利用<code>bufferedReader</code>逐行读入文件，注意需要手动加入换行符（最后添加的一个要删掉）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>line <span style="color:#f92672">=</span> bufferedReader<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    str<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>line<span style="color:#f92672">).</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">,</span> str<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">());</span>
</span></span></code></pre></div><p>将<code>lexicalAnalysis</code>中分析得到的<code>tokenWords</code>写出</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>TokenWord tokenWord <span style="color:#f92672">:</span>lexicalAnalysis<span style="color:#f92672">.</span><span style="color:#a6e22e">tokenWords</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    bufferedWriter<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>tokenWord<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassCode</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span> tokenWord<span style="color:#f92672">.</span><span style="color:#a6e22e">getToken</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="22-词法分析过程">2.2 词法分析过程<a hidden class="anchor" aria-hidden="true" href="#22-词法分析过程">#</a></h4>
<h5 id="准备工作">准备工作<a hidden class="anchor" aria-hidden="true" href="#准备工作">#</a></h5>
<p><strong>标识符定义</strong>采用enum枚举ClassCode的方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">enum</span> ClassCode <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    IDENFR<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>    INTCON<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>    STRCON<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">......</span>
</span></span></code></pre></div><p>同时采用<code>HashMap</code>构造一些特定标识符的对应关系</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> ResCode <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasResCode</span><span style="color:#f92672">(</span>String token<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ResCode<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>token<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ResCode<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;main&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;MAINTK&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ResCode<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;const&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;CONSTTK&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">......</span>
</span></span></code></pre></div><h5 id="具体分析">具体分析<a hidden class="anchor" aria-hidden="true" href="#具体分析">#</a></h5>
<p><strong>总体采取逐个字符读入的方式，同时一些特定字符采取预读取来判断。</strong></p>
<h6 id="逐个字符读入">逐个字符读入<a hidden class="anchor" aria-hidden="true" href="#逐个字符读入">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getCh</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ch <span style="color:#f92672">=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>cursor<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    cursor<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="跳过换行空格tr">跳过换行、空格、<code>\t</code>、<code>\r</code><a hidden class="anchor" aria-hidden="true" href="#跳过换行空格tr">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\t&#39;</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\r&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\r&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        LineNum<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="标识符">标识符<a hidden class="anchor" aria-hidden="true" href="#标识符">#</a></h6>
<p>字母或者下划线开头，先从<code>ResCode</code>看是否是保留字,否则按照<code>IDNEFR</code>处理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isLetter<span style="color:#f92672">(</span>ch<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>isLetter<span style="color:#f92672">(</span>ch<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> isDigit_with_0<span style="color:#f92672">(</span>ch<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;_&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//reback
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hasResCode<span style="color:#f92672">(</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>ResCode<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>        tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">IDENFR</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="intcon">INTCON<a hidden class="anchor" aria-hidden="true" href="#intcon">#</a></h6>
<p>先判断是否是0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isDigit_with_0<span style="color:#f92672">(</span>ch<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>isDigit_with_0<span style="color:#f92672">(</span>ch<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">INTCON</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>      tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="字符串">字符串<a hidden class="anchor" aria-hidden="true" href="#字符串">#</a></h6>
<p>遇到<code>&quot;</code>开始，直到遇到下一个<code>&quot;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#34;&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1 <span style="color:#f92672">&amp;&amp;</span> ch <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#34;&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">STRCON</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="单个字符或者必须两个字符的tokenword">单个字符或者必须两个字符的<code>TokenWord</code><a hidden class="anchor" aria-hidden="true" href="#单个字符或者必须两个字符的tokenword">#</a></h6>
<p>比如<code>[</code>，<code>]</code>，<code>+</code>，<code>&amp;&amp;</code>等，直接读就可以</p>
<h6 id="可能是单个也可能两个字符的tokenword">可能是单个也可能两个字符的<code>TokenWord</code><a hidden class="anchor" aria-hidden="true" href="#可能是单个也可能两个字符的tokenword">#</a></h6>
<p>比如<code>&gt;=</code>，<code>!=</code>之类的</p>
<p>采用预读</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;=&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;=&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">EQL</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">ASSIGN</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                cursor<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">ASSIGN</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="注释">注释<a hidden class="anchor" aria-hidden="true" href="#注释">#</a></h6>
<p>遇到<code>/</code>的情况下，采用预读</p>
<p><code>//</code>：并且一直读到遇到换行符</p>
<p><code>/*</code>：利用<code>BackStr = allFile.substring(cursor);</code>提取出第一个<code>*</code>后面的字符串<code>BackStr</code>；然后判断其中有没有<code>*/</code>，若是没有，就将后面的内容全部注释掉，若是有就将cursor移动到其后面，但是注意要遇到换行符时加行数。</p>
<p>否则<code>/</code>：直接按照<code>DIV</code>输出</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Token<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>ch<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&lt;=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    getCh<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    noteFlag <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>noteFlag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                LineNum<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            noteFlag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>2<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;*&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String BackStr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">boolean</span> flagnote<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> cursortmp <span style="color:#f92672">=</span> cursor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            BackStr <span style="color:#f92672">=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>cursor<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>BackStr<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*/&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                cursor <span style="color:#f92672">=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>2<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                cursor <span style="color:#f92672">=</span> cursor <span style="color:#f92672">+</span> BackStr<span style="color:#f92672">.</span><span style="color:#a6e22e">indexOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*/&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> 2<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> originLength <span style="color:#f92672">=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>cursortmp<span style="color:#f92672">,</span> cursor<span style="color:#f92672">).</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> replaceLength <span style="color:#f92672">=</span> allFile<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>cursortmp<span style="color:#f92672">,</span> cursor<span style="color:#f92672">).</span><span style="color:#a6e22e">replace</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                LineNum <span style="color:#f92672">+=</span> originLength <span style="color:#f92672">-</span> replaceLength<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>2<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">DIV</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>cursor <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                cursor<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        classCode <span style="color:#f92672">=</span> ClassCode<span style="color:#f92672">.</span><span style="color:#a6e22e">DIV</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TokenWord<span style="color:#f92672">(</span>classCode<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>Token<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span>LineNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="四-语法分析设计">四. 语法分析设计<a hidden class="anchor" aria-hidden="true" href="#四-语法分析设计">#</a></h2>
<h3 id="1-总述-1">1 总述<a hidden class="anchor" aria-hidden="true" href="#1-总述-1">#</a></h3>
<p>在语法分析阶段，根据词法分析程序识别出的Token单词，根据<code>SysY</code>语法规则识别出各种语法元素。采用递归下降法对语法中定义的语法成分进行分析。<strong>注意要消除左递归，以及面对可能的回溯问题进行预读。</strong></p>
<p>从**<code>CompUnit</code>**开始逐层往下进行分析。</p>
<h3 id="2-具体实现">2 具体实现<a hidden class="anchor" aria-hidden="true" href="#2-具体实现">#</a></h3>
<ul>
<li>
<p>设置<code>getWordMove()</code>,<code>getNowWord()</code>,<code>getNextWord()</code>,<code>getThirdWord()</code>工具函数用于读入<code>tokenWord</code>,同时设置<code>GrammarString</code>,<code>curTokenWord</code>等全局变量，用于存储获得的语法分析成分，以及当前所读到的<code>tokenWord</code>。</p>
</li>
<li>
<p>对于普通的语法成分，我逐个读入<code>tokenWord</code>，然后对其进行常规的分析。</p>
<p>对于表达式<code>Expression</code>，我首先扫描出整个的<code>Expression</code>,然后对于具有左递归性的语法规则，再依据特定的<strong>分隔符</strong>，对整个大的<code>Expression</code>进行<strong>分割</strong>成若干个较短的<code>Expression</code>，然后依次<strong>调用对应子表达式的分析方法</strong>，进行<strong>递归下降法</strong>进行分析。</p>
</li>
<li>
<p>构建了一个新的<code>Expressions</code>类，<strong>用于存放分割出的子表达式,其中记录有分隔符，分割出的子表达式</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Expressions</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> symbols<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;&gt;</span> expressions<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ArrayList<span style="color:#f92672">&lt;</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">getExpressions</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> expressions<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> symbols<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Expressions</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> symbols<span style="color:#f92672">,</span> ArrayList<span style="color:#f92672">&lt;</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;&gt;</span> expressions<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">symbols</span> <span style="color:#f92672">=</span> symbols<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">expressions</span> <span style="color:#f92672">=</span> expressions<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="21-获取表达式--getexpression">2.1 获取表达式&ndash;<code>getExpression</code><a hidden class="anchor" aria-hidden="true" href="#21-获取表达式--getexpression">#</a></h4>
<p>通过一些特定的判断条件，结合<strong>当前字符以及前一个字符的值</strong>进行判断，以及<strong>是否位于函数</strong>的判断等，进行表达式的获取（后续改写的时候比较繁琐）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getExpression</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        TokenWord preWord <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        TokenWord word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> inFunc <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> FuncFlag <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> FlagSmall <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> FlagBig <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SEMICN&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ASSIGN&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RBRACE&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOfTrueStmt</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//不在函数声明或者引用内，且遇到&#39;,&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;COMMA&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>inFunc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//单词不在表达式内
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preWord <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>preWord<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTCON&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> preWord<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTCON&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>preWord<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RPARENT&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> preWord<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RBRACK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTCON&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FlagSmall <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span> FlagBig <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preWord<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTCON&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LBRACK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preWord<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTCON&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LBRACE&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOfNotInExp</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//在函数内部
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getNextWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LPARENT&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    inFunc <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//(),[]识别
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LPARENT&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                FlagSmall<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inFunc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    FuncFlag<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RPARENT&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                FlagSmall<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inFunc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    FuncFlag<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FuncFlag <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        inFunc <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassCode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;LBRACK&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    FlagBig<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;RBRACK&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    FlagBig<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FlagSmall <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FlagBig <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            curTokenWord <span style="color:#f92672">=</span> tokenWords<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>cursor<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            cursor<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>            exp<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>curTokenWord<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            preWord <span style="color:#f92672">=</span> word<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> exp<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="22-递归下降">2.2 递归下降<a hidden class="anchor" aria-hidden="true" href="#22-递归下降">#</a></h4>
<p>对于一条语法推导规则，若其推导出的式子中含有$V_{N}$,那么考虑采用<code>递归下降分析法</code></p>
<p>在我的实现中，我每读一个<code>tokenWord</code>，检查它属于哪一个$V_{N}$，然后进入下一个相应的分析函数。</p>
<p><strong>例如<code>CompUnit</code>:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>CompUnit <span style="color:#960050;background-color:#1e0010">→</span> <span style="color:#f92672">{</span>Decl<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>FuncDef<span style="color:#f92672">}</span> MainFuncDef <span style="color:#75715e">// 1.是否存在Decl 2.是否存在 FuncDef
</span></span></span></code></pre></div><p><strong>具体实现</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseCompUnit</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        TokenWord word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CONSTTK&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTTK&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> getNextWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>getThirdWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LPARENT&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            analyseDecl<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;VOIDTK&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">((</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTTK&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>getNextWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MAINTK&#34;</span><span style="color:#f92672">))))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            analyseFuncDef<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTTK&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> getNextWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;MAINTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            analyseMainFuncDef<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Error<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;CompUnit&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>又比如<code>Stmt</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>语句 Stmt <span style="color:#960050;background-color:#1e0010">→</span> LVal <span style="color:#e6db74">&#39;=&#39;</span> Exp <span style="color:#e6db74">&#39;;&#39;</span> <span style="color:#75715e">// 每种类型的语句都要覆盖
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		  <span style="color:#f92672">|</span> <span style="color:#f92672">[</span>Exp<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;;&#39;</span> <span style="color:#75715e">//有无Exp两种情况
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		  <span style="color:#f92672">|</span> Block
</span></span><span style="display:flex;"><span>		  <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">if</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span> Cond <span style="color:#e6db74">&#39;)&#39;</span> Stmt <span style="color:#f92672">[</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">else</span><span style="color:#960050;background-color:#1e0010">&#39;</span> Stmt <span style="color:#f92672">]</span> <span style="color:#75715e">// 1.有else 2.无else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		  <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">while</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span> Cond <span style="color:#e6db74">&#39;)&#39;</span> Stmt
</span></span><span style="display:flex;"><span>		  <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">break</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">;</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">continue</span><span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">;</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#66d9ef">return</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#f92672">[</span>Exp<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;;&#39;</span> <span style="color:#75715e">// 1.有Exp 2.无Exp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		  <span style="color:#f92672">|</span> LVal <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>getint<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#e6db74">&#39;(&#39;&#39;)&#39;&#39;;&#39;</span>
</span></span><span style="display:flex;"><span>		  <span style="color:#f92672">|</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>printf<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#e6db74">&#39;(&#39;</span>FormatString<span style="color:#f92672">{</span><span style="color:#e6db74">&#39;,&#39;</span>Exp<span style="color:#f92672">}</span><span style="color:#e6db74">&#39;)&#39;&#39;;&#39;</span> <span style="color:#75715e">// 1.有Exp 2.无Exp
</span></span></span></code></pre></div><p><strong>具体实现</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseStmt</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        TokenWord word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp <span style="color:#f92672">=</span> getExpression<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>getNowWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SEMICN&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                analyseLVal<span style="color:#f92672">(</span>exp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//=
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getNowWord<span style="color:#f92672">().</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GETINTTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//getint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    analyseExp<span style="color:#f92672">(</span>getExpression<span style="color:#f92672">());</span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    getWordMove<span style="color:#f92672">();</span> <span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                analyseExp<span style="color:#f92672">(</span>exp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOfBeginOfExp</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            analyseExp<span style="color:#f92672">(</span>getExpression<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LBRACE&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            analyseBlock<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IFTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//if
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            analyseCond<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            analyseStmt<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ELSETK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                getWordMove<span style="color:#f92672">();</span> <span style="color:#75715e">//else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                analyseStmt<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;WHILETK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//while
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            analyseCond<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            analyseStmt<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;BREAKTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//break
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CONTINUETK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//continue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RETURNTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOfBeginOfExp</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                analyseExp<span style="color:#f92672">(</span>getExpression<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;PRINTFTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//printf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//STRCON
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;COMMA&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                analyseExp<span style="color:#f92672">(</span>getExpression<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SEMICN&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;Stmt&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在以上的分析过程中，需要注意的是</p>
<ul>
<li>一些语法成分内部分析过程的细节性注意（括号匹配等问题）</li>
<li>面对$V_{N}$，需要<code>getNowWord()</code>预读，但是不能直接加入<code>GrammarString</code>中，需要进一步判断属于哪个$V_{N}$</li>
</ul>
<h4 id="23-左递归消除">2.3 左递归消除<a hidden class="anchor" aria-hidden="true" href="#23-左递归消除">#</a></h4>
<p>采用转换为<code>BNF范式</code>的方法消除左递归</p>
<p>例如<strong>加减表达式</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>AddExp <span style="color:#960050;background-color:#1e0010">→</span> MulExp <span style="color:#f92672">|</span> AddExp (<span style="color:#e6db74">&#39;+&#39;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;−&#39;</span>) MulExp <span style="color:#75715e">// 1.MulExp 2.+ 需覆盖 3.- 需覆盖
</span></span></span></code></pre></div><p>改写为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>AddExp <span style="color:#960050;background-color:#1e0010">→</span> MulExp (<span style="color:#e6db74">&#39;+&#39;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;−&#39;</span>) MulExp  (<span style="color:#e6db74">&#39;+&#39;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#39;−&#39;</span>) MulExp ...
</span></span></code></pre></div><p>改写完以后，构造**<code>divideExp()</code>**方法，将整个大的表达式进行分割，再依次调用子程序进行分析</p>
<p><strong><code>private Expressions (divideExp(ArrayList&lt;TokenWord&gt; exp, ArrayList&lt;String&gt; symbol)</code></strong>:</p>
<ul>
<li>
<p>输入：表达式<code>exp</code>,分隔符列表</p>
<p>返回：分割出的子表达式，分割符号列表 ———— <code>return new Expressions(symbols, exps)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Expressions <span style="color:#a6e22e">divideExp</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">,</span> ArrayList<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> symbol<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ArrayList<span style="color:#f92672">&lt;</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;&gt;</span> exps <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> tmpExp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> symbols <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> unaryFlag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> FlagSmall <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> FlagBig <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TokenWord word <span style="color:#f92672">:</span> exp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassCode</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;LPARENT&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    FlagSmall<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;RPARENT&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    FlagSmall<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;LBRACK&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    FlagBig<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;RBRACK&#34;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                    FlagBig<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//遇到指定分隔符，并且(),[]得到匹配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>symbol<span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassCode</span><span style="color:#f92672">())</span> <span style="color:#f92672">&amp;&amp;</span> FlagSmall <span style="color:#f92672">==</span> 0 <span style="color:#f92672">&amp;&amp;</span> FlagBig <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//如果分隔符是单目运算符
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOfUnary</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">//如果上一个word不是识别符,),],int常数，那么不在此处分割，仅将当前word加入exp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>unaryFlag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        tmpExp<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//如果上一个word不是识别符,),],int常数，向exps中加入当前表达式，并且重置表达式，向分隔符列表中加入当前word
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                exps<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                symbols<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                tmpExp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                tmpExp<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            unaryFlag <span style="color:#f92672">=</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IDENFR&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RPARENT&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;INTCON&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RBRACK&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        exps<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Expressions<span style="color:#f92672">(</span>symbols<span style="color:#f92672">,</span> exps<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<p>最终例如<strong>加减表达式</strong>,分析代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseAddExp</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Expressions exps <span style="color:#f92672">=</span> divideExp<span style="color:#f92672">(</span>exp<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;PLUS&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;MINU&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> tmpExp <span style="color:#f92672">:</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressions</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         analyseMulExp<span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>         GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;AddExp&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>j <span style="color:#f92672">&lt;</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>              GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j<span style="color:#f92672">++).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="五-错误处理设计">五. 错误处理设计<a hidden class="anchor" aria-hidden="true" href="#五-错误处理设计">#</a></h2>
<h3 id="1-总体设计">1 总体设计<a hidden class="anchor" aria-hidden="true" href="#1-总体设计">#</a></h3>
<ul>
<li>
<p><strong>新定义类</strong></p>
<ul>
<li>定义<code>Error</code>类，存放错误的类型，所在行数</li>
<li>定义<code>Symbol</code>类，<code>type</code>是指符号的类型,例如<code>const</code>,<code>var</code>,<code>para</code>。<code>Dimension</code>是一个整数,指出了符号的维数。如果为0，则符号为int。如果为1，则符号为int[]；如果为2，则符号为int[][]&hellip;。<code>token</code>是指<code>Symbol</code>的内容。<code>layer</code>就是这个<code>符号</code>所在的层级。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Symbol</span><span style="color:#f92672">(</span>String type<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> Dimension<span style="color:#f92672">,</span> TokenWord tokenWord<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> layer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> type<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Dimension</span> <span style="color:#f92672">=</span> Dimension<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> tokenWord<span style="color:#f92672">.</span><span style="color:#a6e22e">getToken</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">layer</span> <span style="color:#f92672">=</span> layer<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>
<p>定义<code>SymbolTable</code>类来存放符号表，在其中用<code>HashMap&lt;String, Symbol&gt; mapSymbol</code>来存放符号，同时在其中定义了一些基础的方法</p>
</li>
<li>
<p>定义<code>Func</code>类，分别记录函数名、函数返回类型（void，int）、以及函数的参数类型</p>
<p>用<code>ArrayList&lt;Integer&gt; TypeOfParas</code>来记录函数的参数类型，0、1、2分别代表着int,int[],int[][]</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Example</th>
<th>Integer</th>
</tr>
</thead>
<tbody>
<tr>
<td>Void</td>
<td>（函数返回值为空）</td>
<td>-1</td>
</tr>
<tr>
<td>Int</td>
<td>a</td>
<td>0</td>
</tr>
<tr>
<td>Int[]</td>
<td>a[]</td>
<td>1</td>
</tr>
<tr>
<td>Int[] []</td>
<td>a[] [3]</td>
<td>2</td>
</tr>
</tbody>
</table>
</li>
</ul>
</li>
<li>
<p>在<code>GrammarAnalysis</code>类中，我定义了如下几个新的变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ArrayList<span style="color:#f92672">&lt;</span>Error<span style="color:#f92672">&gt;</span> errors <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//函数名Hashmap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Func<span style="color:#f92672">&gt;</span> funcs <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//层级layer对应符号表,每当进入一个新层级，就将layer++，新构造一个SymbolTables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> HashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> SymbolTable<span style="color:#f92672">&gt;</span> SymbolTables <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> layer <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> ReturnFlag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span><span style="color:#75715e">//表示当前函数是否需要返回。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> IndexWhile <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> <span style="color:#75715e">//表示当前代码块是否在while中。
</span></span></span></code></pre></div></li>
<li>
<p><strong>注意</strong>：</p>
<blockquote>
<p><strong>在<code>AnalyseBlock</code>中对于一个自定义函数，与函数的参数是同一个<code>Layer</code>的（否则无法判断函数内部重复定义函数参数等错误）而对于main函数，进入到Block的时候，<code>Layer</code>要加1（main函数内部可以重复定义全局变量）</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">analyseBlock</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> fromFunc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>fromFunc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            IncreaseLayer<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>fromFunc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            DecreaseLayer<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></blockquote>
</li>
</ul>
<h3 id="2-具体分析-errors">2 具体分析 Errors<a hidden class="anchor" aria-hidden="true" href="#2-具体分析-errors">#</a></h3>
<h4 id="a">a<a hidden class="anchor" aria-hidden="true" href="#a">#</a></h4>
<p>检查格式就好</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">IllegalFormatString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;=</span> content<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>NormalChar<span style="color:#f92672">(</span>content<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>content<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\\&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>content<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i <span style="color:#f92672">+</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;n&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            i<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>content<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#f92672">&amp;&amp;</span> content<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i <span style="color:#f92672">+</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                i<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="b-c">b c<a hidden class="anchor" aria-hidden="true" href="#b-c">#</a></h4>
<p>b: <code>对于变量、函数参数来说</code>，每次我得到一个<code>Ident</code>识别符，检查是否有相同的符号被定义在同一层级。<code>对于函数来说</code>，直接查看<code>funcs.containsKey(curTokenWord.getToken())</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//判断当前区块是否有当前符号 b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">existSymbolInThisArea</span><span style="color:#f92672">(</span>TokenWord tokenWord<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> SymbolTables<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>layer<span style="color:#f92672">).</span><span style="color:#a6e22e">SymbolExist</span><span style="color:#f92672">(</span>tokenWord<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>c: 检查所有层级的符号表，此函数符号是否已定义。函数直接查看<code>funcs</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasSymbol</span><span style="color:#f92672">(</span>Word word<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Symbols s <span style="color:#f92672">:</span> symbols<span style="color:#f92672">.</span><span style="color:#a6e22e">values</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">hasSymbol</span><span style="color:#f92672">(</span>word<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="d-e">d e<a hidden class="anchor" aria-hidden="true" href="#d-e">#</a></h4>
<p>首先，为了获取每一个函数参数（可能为表达式）的真实维数，我在语法分析器的递归下降过程中，按照<code>Exp-&gt;Add-&gt;Mul-&gt;Unary-&gt;Primary/Func-&gt;Lval/Exp</code>这个路径，每个分析函数分别返回维数（调用下一层获得），直到<code>Lval</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">analyseExp</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> Dimension <span style="color:#f92672">=</span> analyseAddExp<span style="color:#f92672">(</span>exp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;Exp&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Dimension<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>在<code>Lval</code>中，结束递归调用，返回最终结果</p>
<p><strong>注意</strong></p>
<blockquote>
<p>例如a[3][5],lval对应a[3],那么实际数组维数是1
考虑到a[b[3]]</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">analyseLVal</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>Word<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> 	    TokenWord Ident <span style="color:#f92672">=</span> exp<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>existSymbol<span style="color:#f92672">(</span>Ident<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">,</span> Ident<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Ident<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span><span style="color:#75715e">//Ident
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//若是数组	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exp<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> tmpExp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> flag <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//逐个扫描
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> exp<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                TokenWord word <span style="color:#f92672">=</span> exp<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LBRACK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        Dimension<span style="color:#f92672">++;</span>  <span style="color:#75715e">//a[]这种，而不是a[[]](不能加维数)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    flag<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                        tmpExp <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        tmpExp<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RBRACK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    flag<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        analyseExp<span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        tmpExp<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    tmpExp<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>word<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                analyseExp<span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;k&#34;</span><span style="color:#f92672">,</span> exp<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>exp<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span> <span style="color:#75715e">// not sure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;LVal&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#75715e">//如上注意
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>existSymbol<span style="color:#f92672">(</span>Ident<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> getSymbol<span style="color:#f92672">(</span>Ident<span style="color:#f92672">).</span><span style="color:#a6e22e">getDimension</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> Dimension<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>定义<code>checkFuncParas</code>函数来进行参数数目，参数维数判断,在分析<code>analyseFuncRParams</code>时进行调用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//检查函数参数匹配问题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkFuncParas</span><span style="color:#f92672">(</span>TokenWord funcName<span style="color:#f92672">,</span> ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> standardTypeOfParas<span style="color:#f92672">,</span> ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> nowTypeOfParas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>standardTypeOfParas<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> nowTypeOfParas<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">,</span> funcName<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> standardTypeOfParas<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>Objects<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>standardTypeOfParas<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">),</span> nowTypeOfParas<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;e&#34;</span><span style="color:#f92672">,</span> funcName<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseFuncRParams</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">,</span> TokenWord Ident<span style="color:#f92672">,</span> ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> TypeOfParas<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> nowParas <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    Expressions exps <span style="color:#f92672">=</span> divideExp<span style="color:#f92672">(</span>exp<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;COMMA&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> tmpExp <span style="color:#f92672">:</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressions</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> Dimension <span style="color:#f92672">=</span> analyseExp<span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        nowParas<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Dimension<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>j <span style="color:#f92672">&lt;</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j<span style="color:#f92672">++).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>TypeOfParas <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        checkFuncParas<span style="color:#f92672">(</span>Ident<span style="color:#f92672">,</span> TypeOfParas<span style="color:#f92672">,</span> nowParas<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;FuncRParams&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>然后在<code>analyseFuncRParams</code>时，如果遇到了函数调用那么进行判断</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exp<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 3<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//实参列表有东西
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    analyseFuncRParams<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>exp<span style="color:#f92672">.</span><span style="color:#a6e22e">subList</span><span style="color:#f92672">(</span>2<span style="color:#f92672">,</span> exp<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)),</span> Ident<span style="color:#f92672">,</span> TypeOfParas<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//实参列表没东西
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>TypeOfParas <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>TypeOfParas<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;d&#34;</span><span style="color:#f92672">,</span> Ident<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="f-g">f g<a hidden class="anchor" aria-hidden="true" href="#f-g">#</a></h4>
<p>如果当前函数需要返回，会有一个全局变量<code> ReturnFlag</code>来显示，初始化为false。其在<code>analyseFuncDef()</code>以及<code>analyseMainFuncDef()</code>中，得到赋值。</p>
<ul>
<li>
<p>对于<strong>f</strong></p>
<p>在分析<code>Stmt</code>中的<code>RETURNTK</code>时候，若<code> ReturnFlag</code>为<code>false</code>,那么就产生**<code>f</code>**错误</p>
</li>
<li>
<p>对于<strong>g</strong></p>
<p>定义了<code>hasReturn</code>变量，其在<code>analyseBlock→BlockItem/Stmt→Stmt</code>这条路径上进行调用传递，并作为返回值返回</p>
<p>然后在<code>analyseFuncDef()</code>以及<code>analyseMainFuncDef()</code>中对<code>ReturnFlag &amp;&amp; !hasReturn</code>进行判断，若是真则产生**<code>g</code>**错误</p>
</li>
</ul>
<h4 id="h">h<a hidden class="anchor" aria-hidden="true" href="#h">#</a></h4>
<p>判断是否为常数即可</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>if (isConst(word)) {
</span></span><span style="display:flex;"><span>    Error(&#34;h&#34;, word.getLineNum());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="i-j-k"><strong>i j k</strong><a hidden class="anchor" aria-hidden="true" href="#i-j-k">#</a></h4>
<p>定义函数来检查，以<code>）</code>为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//检查右小括号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">checkRightParent</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>getNowWord<span style="color:#f92672">().</span><span style="color:#a6e22e">getClassCode</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;RPARENT&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getWordMove<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;j&#34;</span><span style="color:#f92672">,</span> curTokenWord<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h4 id="l">l<a hidden class="anchor" aria-hidden="true" href="#l">#</a></h4>
<p>分析<code>Stmt</code>遇到<code>PRINTFTK</code>时，判断一下<code>printf</code>里面逗号的数量和<code>STRCON</code>中的要求输出数是否一致即可</p>
<h4 id="m">m<a hidden class="anchor" aria-hidden="true" href="#m">#</a></h4>
<p>如果代码块在<code>While</code>循环中，则有一个全局变量<code>WhileFlag</code>表示,其值不为0。在遇到<code>break</code>或是<code>continue</code>的时候判断一下即可</p>
<h2 id="六-生成代码设计">六. 生成代码设计<a hidden class="anchor" aria-hidden="true" href="#六-生成代码设计">#</a></h2>
<p>在这一部分中，我选择生成pcode代码。我设计了一种基于<strong>逆波兰表达式</strong>堆栈和符号表的虚拟Pcode代码,在进行语法分析的过程中，随之生成Pcode代码。
<strong>同时，我设计了执行它们的虚拟机。Pcode虚拟机是用于运行Pcode命令的虚构机器。</strong>
<strong>它由一个代码区(pcodes)、一个指令指针(EIP)、一个main函数指针(mainAddress）、一个堆栈（存放各种数值）、存放返回信息的数组、一个变量表var_table,一个函数表func_table和一个标签表label_table组成。</strong></p>
<p>在接下来的文章中，我将首先介绍如何生成pcode，然后介绍pcode如何执行。</p>
<h3 id="编码前设计">编码前设计<a hidden class="anchor" aria-hidden="true" href="#编码前设计">#</a></h3>
<h4 id="如何生成pcode">如何生成Pcode<a hidden class="anchor" aria-hidden="true" href="#如何生成pcode">#</a></h4>
<h5 id="新增的类">新增的类<a hidden class="anchor" aria-hidden="true" href="#新增的类">#</a></h5>
<p>在<code>PcodeGeneration</code>包中，我新增了</p>
<ul>
<li>
<p><code>Function</code>类————记录函数声明在Pcodes代码中的位置以及其参数数量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Function</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> argsNum<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">StackOffset</span> <span style="color:#f92672">=</span> index<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ParamsNum</span> <span style="color:#f92672">=</span> argsNum<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>LabelCreator</code>类————用于产生标签</p>
</li>
<li>
<p><code>Variety</code>类————记录变量在栈上的位置，维度数，各维数的数量</p>
</li>
<li>
<p><code>RetInfo</code>类————记录函数的返回地址（调用函数指令的下一条指令的EIP），调用函数前栈上的末尾位置（<code>stack.size() - 1</code>），虚拟机中当前的变量表（var_table），函数的参数数量，函数所需调用的参数数量，目前已有的参数数量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">RetInfo</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> eip<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> stackPtr<span style="color:#f92672">,</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Variety<span style="color:#f92672">&gt;</span> varTable<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> paramsNum<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> callArgsNum<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> nowArgsNum<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">eip</span> <span style="color:#f92672">=</span> eip<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">stackPtr</span> <span style="color:#f92672">=</span> stackPtr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">varTable</span> <span style="color:#f92672">=</span> varTable<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">paramsNum</span> <span style="color:#f92672">=</span> paramsNum<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">callParamsNum</span> <span style="color:#f92672">=</span> callArgsNum<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">nowParamsNum</span> <span style="color:#f92672">=</span> nowArgsNum<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>Pcode</code>类————记录一个<code>Pcode</code>指令的名称<code>key</code>,<code>FirstValue</code>,<code>LastValue</code>(如有)，同时规定了<code>Pcode</code>的规范化输出（<code>label,func,call,print</code>进行特殊考虑)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String first <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    String second <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FirstValue<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">func</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;FUNC @&#34;</span> <span style="color:#f92672">+</span> FirstValue<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">call</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;$&#34;</span> <span style="color:#f92672">+</span> FirstValue<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>key<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> FirstValue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>FirstValue <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        first <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        first <span style="color:#f92672">=</span> FirstValue<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>SecondValue <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        second <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        second <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> SecondValue<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span> <span style="color:#f92672">+</span> first <span style="color:#f92672">+</span> second<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p><code>PcodeKey</code>枚举类，存放<code>Pcode</code>的基本指令名称,后面会详细介绍</p>
</li>
</ul>
<h5 id="变量声明">变量声明<a hidden class="anchor" aria-hidden="true" href="#变量声明">#</a></h5>
<p><strong>如何区分不同的变量</strong>
根据唯一的作用域号区分不同作用域的变量，如：<code>CurLayerId + &quot;_&quot; + Ident.getToken()</code>。在这种情况下，除了递归函数调用以外，代码中不会多次重复出现该变量，可以通过将<code>varTable</code>到堆栈来解决。</p>
<p><strong>不区分const和var。</strong></p>
<ul>
<li><strong>非数组变量</strong>：新建一个变量<code>var</code>并让它指向堆栈顶部。如果它有初始化，<code>push</code>初始化的值进入堆栈（如果<code>int x=q</code>这种初始化，那么需要<code>push q</code>，然后再<code>getvalue</code>）。如果未初始化，则添加一个<code>defaultvalue</code>命令来将变量的默认初始值(我将其推入0)推送到堆栈。</li>
<li><strong>数组变量</strong>：新建一个变量<code>var</code>并让它指向堆栈顶部。然后<code>push</code>其各维的维数，然后用<code>dimarrayvar</code>命令表示他是数组,如果它有初始化，依次<code>push</code>初始化的值进入堆栈。如果未初始化，则添加一个<code>defaultvalue</code>命令来将变量的默认初始值(我将其推入0)推送到堆栈。</li>
<li>如果是<code>getint</code>，那么加入<code>getint</code></li>
</ul>
<p>eg：int x[1][3];</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JAVA" data-lang="JAVA"><span style="display:flex;"><span>var 1_x
</span></span><span style="display:flex;"><span>push 1
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>dimarrayvar 1_x<span style="color:#f92672">,</span> 2
</span></span><span style="display:flex;"><span>defaultvalue 1_x<span style="color:#f92672">,</span> 2
</span></span></code></pre></div><h5 id="赋值语句">赋值语句<a hidden class="anchor" aria-hidden="true" href="#赋值语句">#</a></h5>
<p>首先<code>push</code>待赋值的变量（若是数组，还需要<code>push</code>偏移量），然后利用<code>getaddress</code>计算并将变量的地址推送到堆栈顶部。然后分析赋值语句右侧的表达式，对于数值，直接<code>push</code>,对于表达式，利用<code>getvalue</code>获取表达式的值。（若是算术运算表达式，就先执行）在此之后，堆栈中有两个数字，即地址和值。利用<code>pop</code>将该值分配给该地址。</p>
<h5 id="变量取值">变量取值<a hidden class="anchor" aria-hidden="true" href="#变量取值">#</a></h5>
<blockquote>
<p>例如要取得x[0][2]的值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>push <span style="color:#ae81ff">2</span>_x
</span></span><span style="display:flex;"><span>push <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>push <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>getvalue <span style="color:#ae81ff">2</span>_x, <span style="color:#ae81ff">0</span>
</span></span></code></pre></div></blockquote>
<h5 id="函数定义"><strong>函数定义</strong><a hidden class="anchor" aria-hidden="true" href="#函数定义">#</a></h5>
<p>直接<code>Pcodes.add(new Pcode(PcodeKey.func, curTokenWord.getToken()));</code>（mainfunc特殊定义）</p>
<h5 id="函数形参">函数形参<a hidden class="anchor" aria-hidden="true" href="#函数形参">#</a></h5>
<p><code>fparam</code>+名字+维数</p>
<p><strong>注意</strong>：若是数组，需要先<code>push</code>进去各维数量（二维形参，只需要<code>push</code>第二维数量）</p>
<h5 id="函数调用">函数调用<a hidden class="anchor" aria-hidden="true" href="#函数调用">#</a></h5>
<p><strong>实参类型</strong></p>
<ul>
<li>
<p>数值：先<code>push</code>函数实参，再<code>rparam</code>+函数实参名字+维数,再<code>call</code>相应函数名</p>
</li>
<li>
<p>变量：先<code>push</code>变量名</p>
<ul>
<li>
<p>若是数组，就<code>getaddress</code>加维数</p>
</li>
<li>
<p>若是普通变量，就<code>getvalue</code>+维数；若是<code>a[1][3]</code>这种，就先<code>push</code>进去1,3，再<code>getvalue</code></p>
<p><strong>剩下的操作同上</strong></p>
</li>
</ul>
</li>
</ul>
<h5 id="函数返回">函数返回<a hidden class="anchor" aria-hidden="true" href="#函数返回">#</a></h5>
<p><code>ret 0</code>代表无返回值</p>
<p><code>ret 1</code>代表有返回值，在<code>ret</code>之前会有<code>push</code>（由分析表达式产生）之类的，代表返回指的具体数值</p>
<h5 id="打印语句">打印语句<a hidden class="anchor" aria-hidden="true" href="#打印语句">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">,</span> STRCON<span style="color:#f92672">.</span><span style="color:#a6e22e">getToken</span><span style="color:#f92672">(),</span> OutputNum<span style="color:#f92672">));</span>
</span></span></code></pre></div><p><strong>注意</strong>：打印变量，则按照老套路，先<code>push</code>变量，再<code>getvalue</code>例如<code>printf(&quot;%d&quot;,x);</code>，则是<code>push 2_x , getvalue 2_x, 0 print &quot;%d&quot;</code></p>
<h5 id="条件跳转控制语句">条件跳转控制语句<a hidden class="anchor" aria-hidden="true" href="#条件跳转控制语句">#</a></h5>
<p>首先，我定义了三个<code>ArrayList</code>,分别存放着对应标签的<code>HashMap</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;&gt;</span> If_Labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;&gt;</span> While_Labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>HashMap<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;&gt;</span> Cond_Labels <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span></code></pre></div><p>每当遇到<code>IFTK</code>或其他判断语句时，生成相应标签</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">getNewIfLabel</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> tmpIfLabel <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    tmpIfLabel<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;if&#34;</span><span style="color:#f92672">,</span> LabelCreator<span style="color:#f92672">.</span><span style="color:#a6e22e">CreateLabel</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;if&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    tmpIfLabel<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;else&#34;</span><span style="color:#f92672">,</span> LabelCreator<span style="color:#f92672">.</span><span style="color:#a6e22e">CreateLabel</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;else&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    tmpIfLabel<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endif&#34;</span><span style="color:#f92672">,</span> LabelCreator<span style="color:#f92672">.</span><span style="color:#a6e22e">CreateLabel</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endif&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    tmpIfLabel<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ifblock&#34;</span><span style="color:#f92672">,</span> LabelCreator<span style="color:#f92672">.</span><span style="color:#a6e22e">CreateLabel</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ifblock&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>tmpIfLabel<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>以<code>if</code>为例子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;IFTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   getNewIfLabel<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>   Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;if&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>   getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//if
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   analyseCond<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;if&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>   checkRightParent<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>   Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">jz</span><span style="color:#f92672">,</span> If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;else&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>   Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ifblock&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>   analyseStmt<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>   word <span style="color:#f92672">=</span> getNowWord<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>   Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">jmp</span><span style="color:#f92672">,</span> If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endif&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>   Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;else&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;ELSETK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       getWordMove<span style="color:#f92672">();</span> <span style="color:#75715e">//else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       analyseStmt<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>   Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endif&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>   If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>If_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>while</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;WHILETK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    getNewWhileLabel<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;while&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//while
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    IndexWhile<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    analyseCond<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;while&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    checkRightParent<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">jz</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endwhile&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;whileblock&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    analyseStmt<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    IndexWhile<span style="color:#f92672">--;</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">jmp</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;while&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">label</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endwhile&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#75715e">//break
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;BREAKTK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//break
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>IndexWhile <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;m&#34;</span><span style="color:#f92672">,</span> curTokenWord<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    checkSemicn<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">jmp</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;endwhile&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span><span style="color:#75715e">//continue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>word<span style="color:#f92672">.</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;CONTINUETK&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    getWordMove<span style="color:#f92672">();</span><span style="color:#75715e">//continue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>IndexWhile <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Error<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;m&#34;</span><span style="color:#f92672">,</span> curTokenWord<span style="color:#f92672">.</span><span style="color:#a6e22e">getLineNum</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    checkSemicn<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">jmp</span><span style="color:#f92672">,</span> While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>While_Labels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;while&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="加减乘除比较运算表达式">加减、乘除，比较运算表达式<a hidden class="anchor" aria-hidden="true" href="#加减乘除比较运算表达式">#</a></h5>
<p>以比较为例</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseRelExp</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Expressions exps <span style="color:#f92672">=</span> divideExp<span style="color:#f92672">(</span>exp<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LSS&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;LEQ&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;GRE&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;GEQ&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>TokenWord<span style="color:#f92672">&gt;</span> tmpExp <span style="color:#f92672">:</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressions</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        analyseAddExp<span style="color:#f92672">(</span>tmpExp<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>j <span style="color:#f92672">&gt;</span> 0 <span style="color:#f92672">&amp;&amp;</span> j <span style="color:#f92672">&lt;=</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getExpressions</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LSS&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">cmplt</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;LEQ&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">cmple</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GRE&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">cmpgt</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">ClassCodeOf</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;GEQ&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Pcode<span style="color:#f92672">(</span>PcodeKey<span style="color:#f92672">.</span><span style="color:#a6e22e">cmpge</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&lt;RelExp&gt;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>j <span style="color:#f92672">&lt;</span> exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            GrammarString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>exps<span style="color:#f92672">.</span><span style="color:#a6e22e">getSymbols</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>j<span style="color:#f92672">++).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>需要注意的是，由于采用逆波兰表达式，当分析到第二个表达式的时候，其实<code>j</code>已经跳到第二个表达式后面了，所以需要判断的是<code>j-1</code>位置处</strong></p>
<h4 id="如何运行pcode">如何运行Pcode<a hidden class="anchor" aria-hidden="true" href="#如何运行pcode">#</a></h4>
<p><strong>Pcode虚拟机是用于运行Pcode命令的虚构机器。</strong>
<strong>它由一个代码区(pcodes)、一个指令指针(EIP)、一个main函数指针(mainAddress）、一个堆栈（存放各种数值）、存放返回信息的数组、一个变量表var_table,一个函数表func_table和一个标签表label_table组成。</strong></p>
<p><strong>我定义了一个<code>PcodeExecutor</code>类，对应着我的Pcode虚拟机</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> eip <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//mainAddress标记main函数的地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> mainAddress<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Scanner scanner<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>Pcode<span style="color:#f92672">&gt;</span> pcodes<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>RetInfo<span style="color:#f92672">&gt;</span> retInfos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//模拟存放各种数值的栈
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> stack <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Variety<span style="color:#f92672">&gt;</span> varTable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Function<span style="color:#f92672">&gt;</span> funcTable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//label对应的代码行数(eip)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> HashMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;</span> labelTable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span></code></pre></div><h5 id="初始化">初始化<a hidden class="anchor" aria-hidden="true" href="#初始化">#</a></h5>
<p>将<code>scanner</code>和<code>pcode</code>代码初始化，同时扫描<code>Pcode</code>代码,将扫描到的标签(名称，位置）加入标签表，函数（名称，function）加入函数表，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">PcodeExecutor</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>Pcode<span style="color:#f92672">&gt;</span> pcodes<span style="color:#f92672">,</span> Scanner sc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pcodes</span> <span style="color:#f92672">=</span> pcodes<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">scanner</span> <span style="color:#f92672">=</span> sc<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> index <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>index <span style="color:#f92672">&lt;</span> pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Pcode pcode <span style="color:#f92672">=</span> pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> label<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                labelTable<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> index<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> func<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                funcTable<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> Function<span style="color:#f92672">(</span>index<span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> mainfunc<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                mainAddress <span style="color:#f92672">=</span> index<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        index<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="基本操作">基本操作<a hidden class="anchor" aria-hidden="true" href="#基本操作">#</a></h5>
<h6 id="获取变量">获取变量<a hidden class="anchor" aria-hidden="true" href="#获取变量">#</a></h6>
<p>如果当前变量表中存在该变量，则直接返回，否则在全局变量中寻找</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Variety <span style="color:#a6e22e">getVar</span><span style="color:#f92672">(</span>String varName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>varTable<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>varName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> varTable<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>varName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//全局变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> retInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>0<span style="color:#f92672">).</span><span style="color:#a6e22e">getVarTable</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>varName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="pushpop">push、pop<a hidden class="anchor" aria-hidden="true" href="#pushpop">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">push</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> value<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stack<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//弹出并返回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pop</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> value <span style="color:#f92672">=</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    stack<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="获取变量在栈上的绝对地址">获取变量在栈上的绝对地址<a hidden class="anchor" aria-hidden="true" href="#获取变量在栈上的绝对地址">#</a></h6>
<p>注意这里的维数是相对的
for example, to int a[3][2] ,a[0][0] is 0, a[0] is 1, a is 2
a[3][2],SecondDim:2;FirstDim:3</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getAddress</span><span style="color:#f92672">(</span>Variety var<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> Dimension<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> Address <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getDimension</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> Dimension<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Address <span style="color:#f92672">=</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getOffset</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>var<span style="color:#f92672">.</span><span style="color:#a6e22e">getDimension</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Address <span style="color:#f92672">=</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Address <span style="color:#f92672">=</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">*</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondDimNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>n <span style="color:#f92672">==</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Address <span style="color:#f92672">=</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getOffset</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> j <span style="color:#f92672">*</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondDimNum</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Address<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h5 id="运行代码">运行代码<a hidden class="anchor" aria-hidden="true" href="#运行代码">#</a></h5>
<p>首先定义几个变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//已经存在的参数数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> ExistParamsNum <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//调用所需的参数数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> CallParamsNum <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">boolean</span> MainFuncFlag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//函数实参对应的栈上的地址列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> rparams <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span></code></pre></div><h6 id="var">var<a hidden class="anchor" aria-hidden="true" href="#var">#</a></h6>
<p>产生新的变量，置于stack末尾，放进变量表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> var<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Variety var <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Variety<span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    varTable<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">(),</span> var<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="push">push<a hidden class="anchor" aria-hidden="true" href="#push">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//对于数字的话，push进栈里
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">case</span> push<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">instanceof</span> Integer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        push<span style="color:#f92672">((</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="pop">pop<a hidden class="anchor" aria-hidden="true" href="#pop">#</a></h6>
<p><code>pop</code>操作:<code>*value1 = value2</code>
在我的定义中，我会在变量赋值以前依次将其在栈中对应的地址以及所赋的值压进栈中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> pop<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> value <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> address <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    stack<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>address<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="计算">计算<a hidden class="anchor" aria-hidden="true" href="#计算">#</a></h6>
<p>Calculation Type</p>
<p>Two operators:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> pop<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>push<span style="color:#f92672">(</span>cal<span style="color:#f92672">(</span>a<span style="color:#f92672">,</span>b<span style="color:#f92672">));</span>
</span></span></code></pre></div><p>Single operator:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>push<span style="color:#f92672">(</span>cal<span style="color:#f92672">(</span>pop<span style="color:#f92672">()));</span>
</span></span></code></pre></div><h6 id="数组维数">数组维数<a hidden class="anchor" aria-hidden="true" href="#数组维数">#</a></h6>
<p>声明变量维数,紧跟着的是维数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> dimarrayvar<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Variety var <span style="color:#f92672">=</span> getVar<span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dimension <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    var<span style="color:#f92672">.</span><span style="color:#a6e22e">setDimension</span><span style="color:#f92672">(</span>dimension<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        var<span style="color:#f92672">.</span><span style="color:#a6e22e">setSecondDimNum</span><span style="color:#f92672">(</span>pop<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        var<span style="color:#f92672">.</span><span style="color:#a6e22e">setFirstDimNum</span><span style="color:#f92672">(</span>pop<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        var<span style="color:#f92672">.</span><span style="color:#a6e22e">setFirstDimNum</span><span style="color:#f92672">(</span>pop<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="占位符">占位符<a hidden class="anchor" aria-hidden="true" href="#占位符">#</a></h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> defaultvalue<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Variety var <span style="color:#f92672">=</span> getVar<span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dimension <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        push<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstDimNum</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            push<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstDimNum</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> var<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondDimNum</span><span style="color:#f92672">();</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            push<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="getint">getint<a hidden class="anchor" aria-hidden="true" href="#getint">#</a></h6>
<p>读取int</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> getint<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> value <span style="color:#f92672">=</span> scanner<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    push<span style="color:#f92672">(</span>value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h6 id="跳转">跳转<a hidden class="anchor" aria-hidden="true" href="#跳转">#</a></h6>
<p>如果是条件跳转，取出<code>stack</code>中最后一个值判断</p>
<h6 id="函数定义-1">函数定义<a hidden class="anchor" aria-hidden="true" href="#函数定义-1">#</a></h6>
<ul>
<li>
<p><code>main</code>函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> mainfunc<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    MainFuncFlag <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//retInfos[0] storage 全局变量(varTable)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    retInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RetInfo<span style="color:#f92672">(</span>pcodes<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(),</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">,</span> varTable<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> 0<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    varTable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
<li>
<p>自定义函数</p>
<p>遇见func定义的话，均先进入到main函数中，等到调用的时候再跳转</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> func<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> flag <span style="color:#f92672">=</span> MainFuncFlag <span style="color:#f92672">?</span> 1 <span style="color:#f92672">:</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        eip <span style="color:#f92672">=</span> mainAddress <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
<h6 id="函数调用-1">函数调用<a hidden class="anchor" aria-hidden="true" href="#函数调用-1">#</a></h6>
<p>总体上来说，就是<code>遇到函数调用</code>-&gt;<code>存实参数（值/地址）</code>-&gt;<code>存下retInfo，产生新变量表（用于函数），跳转到定义处</code>-&gt;<code>遇到形参，依次存入新变量表</code>-&gt;<code>遇到ret，进行返回，将原retinfo还原</code></p>
<p>First, before function call, there will be some parameters to be pushed into the stack. Each will be followed by a <code>rparam</code> command, which memorize the address of the previous variety.</p>
<p><strong>注意：对于传值实参，若是数组具体到某个数（本质是传具体值），对应操作<code>先push各维度，再getvalue</code>，若是具体数值，就是push数值，因此直接<code>rparams.add(stack.size() - 1)</code>。对于传地址参数，则是<code>先push数组名，再getaddress</code>，因此需要将其<code>地址</code>压入</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> rparam<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dimension <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//对于非数组的参数，直接将其值压入栈中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//因此其地址是栈顶的地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//对于数组的参数，将其地址压入栈中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Second, function <code>CALL</code>.</p>
<p>Memorize the eip, stack top address, and information about the function(In fact, they will be pushed into stack too). Then update the <code>varTable</code> and <code>eip</code>.  Ready for execute function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> call<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Function func <span style="color:#f92672">=</span> funcTable<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    retInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RetInfo<span style="color:#f92672">(</span>eip<span style="color:#f92672">,</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">,</span> varTable<span style="color:#f92672">,</span> func<span style="color:#f92672">.</span><span style="color:#a6e22e">getParamsNum</span><span style="color:#f92672">(),</span> func<span style="color:#f92672">.</span><span style="color:#a6e22e">getParamsNum</span><span style="color:#f92672">(),</span> ExistParamsNum<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//跳转至函数定义处
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    eip <span style="color:#f92672">=</span> func<span style="color:#f92672">.</span><span style="color:#a6e22e">getOffset</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    varTable <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    CallParamsNum <span style="color:#f92672">=</span> func<span style="color:#f92672">.</span><span style="color:#a6e22e">getParamsNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    ExistParamsNum <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Finally, return when it&rsquo;s <code>RET</code></p>
<p>Restore <code>eip</code>, <code>varTable</code> from <code>RetInfo</code>, clear the new information pushed when function in the stack.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> ret<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> type <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    RetInfo retInfo <span style="color:#f92672">=</span> retInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>retInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    eip <span style="color:#f92672">=</span> retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getEip</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    varTable <span style="color:#f92672">=</span> retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getVarTable</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    CallParamsNum <span style="color:#f92672">=</span> retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getCallParamsNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    ExistParamsNum <span style="color:#f92672">=</span> retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getNowParamsNum</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//有返回值的话，由于之前将返回值压入栈中，故需要保留栈顶元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        stack<span style="color:#f92672">.</span><span style="color:#a6e22e">subList</span><span style="color:#f92672">(</span>retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getStackPtr</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> 1 <span style="color:#f92672">-</span> retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getParamsNum</span><span style="color:#f92672">(),</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        stack<span style="color:#f92672">.</span><span style="color:#a6e22e">subList</span><span style="color:#f92672">(</span>retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getStackPtr</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> 1 <span style="color:#f92672">-</span> retInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getParamsNum</span><span style="color:#f92672">(),</span> stack<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>Additional：</strong></p>
<p><code>储存完实参，调用函数以后跳转到函数定义的地方</code></p>
<blockquote>
<p><code>fparam</code>:Firstvalue:Ident_name Secondvalue:Type/Dimension</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> fparam<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//函数现在需要的形参的index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> nowfparamIndex <span style="color:#f92672">=</span> rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> CallParamsNum <span style="color:#f92672">+</span> ExistParamsNum<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> addressOnStack <span style="color:#f92672">=</span> rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>nowfparamIndex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Variety fparam <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Variety<span style="color:#f92672">(</span>addressOnStack<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dimension <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    fparam<span style="color:#f92672">.</span><span style="color:#a6e22e">setDimension</span><span style="color:#f92672">(</span>dimension<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//二维数组需要将第二维大小作为参数传入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>dimension <span style="color:#f92672">==</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        fparam<span style="color:#f92672">.</span><span style="color:#a6e22e">setSecondDimNum</span><span style="color:#f92672">(</span>pop<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    varTable<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">(),</span> fparam<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ExistParamsNum<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//如果形参已经全部生成，就清空rparams数组里对应的其形参
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ExistParamsNum <span style="color:#f92672">==</span> CallParamsNum<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">subList</span><span style="color:#f92672">(</span>rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> CallParamsNum<span style="color:#f92672">,</span> rparams<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span></code></pre></div><h6 id="打印输出">打印输出<a hidden class="anchor" aria-hidden="true" href="#打印输出">#</a></h6>
<p><code>print</code>:Firstvalue:String Secondvalue:output num quantity</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> print<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String str <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> q <span style="color:#f92672">=</span> num <span style="color:#f92672">-</span> 1<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    StringBuilder sb <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    ArrayList<span style="color:#f92672">&lt;</span>Integer<span style="color:#f92672">&gt;</span> OutParams <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> num<span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        OutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>pop<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;</span> str<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span> j<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>j <span style="color:#f92672">&lt;</span> str<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>j<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;%&#39;</span> <span style="color:#f92672">&amp;&amp;</span> str<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>j <span style="color:#f92672">+</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>OutParams<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>q<span style="color:#f92672">--).</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                j<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        sb<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>str<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>j<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//除去引号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    OutputString<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>sb<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> sb<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span></code></pre></div><h6 id="获取变量的值地址">获取变量的值，地址<a hidden class="anchor" aria-hidden="true" href="#获取变量的值地址">#</a></h6>
<p>Firstvalue:Ident_name Secondvalue:Dimension</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> getvalue<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Variety var <span style="color:#f92672">=</span> getVar<span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dimension <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> address <span style="color:#f92672">=</span> getAddress<span style="color:#f92672">(</span>var<span style="color:#f92672">,</span> dimension<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    push<span style="color:#f92672">(</span>stack<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>address<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//获得变量在栈上的地址，给定变量名和维度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">case</span> getaddress<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Variety var <span style="color:#f92672">=</span> getVar<span style="color:#f92672">((</span>String<span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getFirstValue</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dimension <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)</span> pcode<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecondValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> address <span style="color:#f92672">=</span> getAddress<span style="color:#f92672">(</span>var<span style="color:#f92672">,</span> dimension<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    push<span style="color:#f92672">(</span>address<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span></code></pre></div><h3 id="编码后设计">编码后设计<a hidden class="anchor" aria-hidden="true" href="#编码后设计">#</a></h3>
<h4 id="小细节问题">小细节问题<a hidden class="anchor" aria-hidden="true" href="#小细节问题">#</a></h4>
<ul>
<li>
<p>在<code>GrammarAnalysis</code>中，新增<code>CurLayerId</code>变量，注意和<code>layer</code>区分</p>
<ul>
<li>
<p>前者为了区分符号表内<code>变量</code>所处层级，因此不考虑出区块减一，而后者用来构造符号表的<code>HashMap</code>，有并列关系，所以出了区块就要减一</p>
</li>
<li>
<p>两者每次新进入一个区块之后，都会加一</p>
</li>
<li>
<p>但是退出一个区块的时候，前者不会减一，而后者依旧减一</p>
</li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addSymbol</span><span style="color:#f92672">(</span>TokenWord tokenWord<span style="color:#f92672">,</span> String type<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> Dimension<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> CurLayerId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    SymbolTables<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>layer<span style="color:#f92672">).</span><span style="color:#a6e22e">SymbolInsert</span><span style="color:#f92672">(</span>type<span style="color:#f92672">,</span> Dimension<span style="color:#f92672">,</span> tokenWord<span style="color:#f92672">,</span> CurLayerId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h4 id="pcode代码对应表">Pcode代码对应表<a hidden class="anchor" aria-hidden="true" href="#pcode代码对应表">#</a></h4>
<h5 id="common-type">Common Type<a hidden class="anchor" aria-hidden="true" href="#common-type">#</a></h5>
<table>
<thead>
<tr>
<th>CodeType</th>
<th>Value1</th>
<th>Value2</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td>label</td>
<td>label_name</td>
<td></td>
<td>set  a label</td>
</tr>
<tr>
<td>var</td>
<td>ident_name</td>
<td></td>
<td>declare  a variety</td>
</tr>
<tr>
<td>push</td>
<td>ident_name/digit</td>
<td></td>
<td>push(value1)</td>
</tr>
<tr>
<td>pop</td>
<td>ident_name</td>
<td><strong>在pop命令以前push进来的赋值语句右面的式子的值</strong></td>
<td>*value1 = value2（<strong>这个value2指的是在pop命令以前push进来的赋值语句右面的式子的值</strong>）</td>
</tr>
<tr>
<td>jz</td>
<td>label_name</td>
<td></td>
<td>jump if stack top is zero</td>
</tr>
<tr>
<td>jnz</td>
<td>label_name</td>
<td></td>
<td>jump if stack top is not zero</td>
</tr>
<tr>
<td>jmp</td>
<td>label_name</td>
<td></td>
<td>jump unconditionally</td>
</tr>
<tr>
<td>main</td>
<td></td>
<td></td>
<td>main function label</td>
</tr>
<tr>
<td>func</td>
<td></td>
<td></td>
<td>function label</td>
</tr>
<tr>
<td>endfunc</td>
<td></td>
<td></td>
<td>end of function label</td>
</tr>
<tr>
<td>fparam</td>
<td>ident_name</td>
<td>dimension/type</td>
<td><strong>函数形参</strong>parameters</td>
</tr>
<tr>
<td>ret</td>
<td>return value or not（0：void；1：int）</td>
<td></td>
<td>function return（ret 0无返回值，1有返回值）</td>
</tr>
<tr>
<td>call</td>
<td>function name</td>
<td></td>
<td>function call</td>
</tr>
<tr>
<td>rparam</td>
<td>ident_name</td>
<td>dimension</td>
<td><strong>函数实参</strong>get parameters ready for function call</td>
</tr>
<tr>
<td>getint</td>
<td></td>
<td></td>
<td>get a integer and put it into stack top</td>
</tr>
<tr>
<td>print</td>
<td>string</td>
<td>para num</td>
<td>pop values and print.</td>
</tr>
<tr>
<td>dimarrayvar</td>
<td>ident_name</td>
<td>type/dimension</td>
<td>set dimension info for array variety</td>
</tr>
<tr>
<td>getvalue</td>
<td>ident_name</td>
<td>type/dimension</td>
<td>对于普通变量，get the variety value</td>
</tr>
<tr>
<td>getaddress</td>
<td>ident_name</td>
<td>type/dimension</td>
<td>对于数组，get the variety address</td>
</tr>
<tr>
<td>defaultvalue</td>
<td>ident_name</td>
<td>type/dimension</td>
<td>push something to hold places</td>
</tr>
<tr>
<td>exit</td>
<td></td>
<td></td>
<td>exit</td>
</tr>
</tbody>
</table>
<h5 id="运算比较">运算比较<a hidden class="anchor" aria-hidden="true" href="#运算比较">#</a></h5>
<table>
<thead>
<tr>
<th>CodeType</th>
<th>Value1</th>
<th>Value2</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td>add</td>
<td></td>
<td></td>
<td>+</td>
</tr>
<tr>
<td>sub</td>
<td></td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>mul</td>
<td></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>div</td>
<td></td>
<td></td>
<td>/</td>
</tr>
<tr>
<td>mod</td>
<td></td>
<td></td>
<td>%</td>
</tr>
<tr>
<td>cmpeq</td>
<td></td>
<td></td>
<td>==</td>
</tr>
<tr>
<td>cmpne</td>
<td></td>
<td></td>
<td>!=</td>
</tr>
<tr>
<td>cmpgt</td>
<td></td>
<td></td>
<td>&gt;</td>
</tr>
<tr>
<td>cmplt</td>
<td></td>
<td></td>
<td>&lt;</td>
</tr>
<tr>
<td>cmpge</td>
<td></td>
<td></td>
<td>&gt;=</td>
</tr>
<tr>
<td>cmple</td>
<td></td>
<td></td>
<td>&lt;=</td>
</tr>
<tr>
<td>and</td>
<td></td>
<td></td>
<td>&amp;&amp;</td>
</tr>
<tr>
<td>or</td>
<td></td>
<td></td>
<td>||</td>
</tr>
<tr>
<td>not</td>
<td></td>
<td></td>
<td>!</td>
</tr>
<tr>
<td>neg</td>
<td></td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>pos</td>
<td></td>
<td></td>
<td>+</td>
</tr>
</tbody>
</table>
<h4 id="短路求值问题">短路求值问题<a hidden class="anchor" aria-hidden="true" href="#短路求值问题">#</a></h4>
<p>There are two situations I need to use short circuit calculation :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1.</span> <span style="color:#66d9ef">if</span>(a<span style="color:#f92672">&amp;&amp;</span>b) <span style="color:#75715e">// a is false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">2.</span> <span style="color:#66d9ef">if</span>(a<span style="color:#f92672">||</span>b) <span style="color:#75715e">// a is true
</span></span></span></code></pre></div><p>My method is as follows:</p>
<p>First, when I analyze <code>analyseLOrExp</code>, every <code>analyseLAndExp</code> will be followed by a <code>JNZ</code>, which is used for detect if the cond is true. If it is, jump to the if body label. At the same time, I generated cond label, which is ready for the <code>analyseLAndExp</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseLOrExp</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>Word<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">,</span> String from<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        String label <span style="color:#f92672">=</span> labelGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLabel</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cond_&#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        analyseLAndExp<span style="color:#f92672">(</span>exp1<span style="color:#f92672">,</span> from<span style="color:#f92672">,</span> label<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        codes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PCode<span style="color:#f92672">(</span>CodeType<span style="color:#f92672">.</span><span style="color:#a6e22e">LABEL</span><span style="color:#f92672">,</span> label<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            codes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PCode<span style="color:#f92672">(</span>CodeType<span style="color:#f92672">.</span><span style="color:#a6e22e">OR</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                codes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PCode<span style="color:#f92672">(</span>CodeType<span style="color:#f92672">.</span><span style="color:#a6e22e">JNZ</span><span style="color:#f92672">,</span> ifLabels<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>ifLabels<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;if_block&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>In the <code>analyseLAndExp</code>, every <code>analyseEqExp</code> will be followed by a <code>JZ</code>, which is used for detect if the cond is true. If it is not, jump to the cond label I set just now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">analyseLAndExp</span><span style="color:#f92672">(</span>ArrayList<span style="color:#f92672">&lt;</span>Word<span style="color:#f92672">&gt;</span> exp<span style="color:#f92672">,</span> String from<span style="color:#f92672">,</span> String label<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        analyseEqExp<span style="color:#f92672">(</span>exp1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            codes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PCode<span style="color:#f92672">(</span>CodeType<span style="color:#f92672">.</span><span style="color:#a6e22e">AND</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(...)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                codes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> PCode<span style="color:#f92672">(</span>CodeType<span style="color:#f92672">.</span><span style="color:#a6e22e">JZ</span><span style="color:#f92672">,</span> label<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>By these means, short circuit calculation is solved.</p>
<h2 id="七-代码示例">七. 代码示例<a hidden class="anchor" aria-hidden="true" href="#七-代码示例">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> y<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> b[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">3</span>]<span style="color:#f92672">=</span>{{<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>}};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">func</span>(<span style="color:#66d9ef">int</span> x[][<span style="color:#ae81ff">3</span>])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> x[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">2</span>]<span style="color:#f92672">+</span>y;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">func2</span>(<span style="color:#66d9ef">int</span> a)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> s<span style="color:#f92672">=</span>a<span style="color:#f92672">+</span>b;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> q<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> x<span style="color:#f92672">=</span>q;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> z;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> y<span style="color:#f92672">=</span>func(b);
</span></span><span style="display:flex;"><span>z<span style="color:#f92672">=</span>func2(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>printf(<span style="color:#e6db74">&#34;%d&#34;</span>,<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>var 0_y
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>var 0_b
</span></span><span style="display:flex;"><span>push 1
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>dimarrayvar 0_b, 2
</span></span><span style="display:flex;"><span>push 1
</span></span><span style="display:flex;"><span>push 2
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>FUNC @func:
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>fparam 1_x, 2
</span></span><span style="display:flex;"><span>push 1_x
</span></span><span style="display:flex;"><span>push 0
</span></span><span style="display:flex;"><span>push 2
</span></span><span style="display:flex;"><span>getvalue 1_x, 0
</span></span><span style="display:flex;"><span>push 0_y
</span></span><span style="display:flex;"><span>getvalue 0_y, 0
</span></span><span style="display:flex;"><span>add 
</span></span><span style="display:flex;"><span>ret 1
</span></span><span style="display:flex;"><span>endfunc 
</span></span><span style="display:flex;"><span>FUNC @func2:
</span></span><span style="display:flex;"><span>fparam 2_a, 0
</span></span><span style="display:flex;"><span>var 2_s
</span></span><span style="display:flex;"><span>push 2_a
</span></span><span style="display:flex;"><span>getvalue 2_a, 0
</span></span><span style="display:flex;"><span>push 0_b
</span></span><span style="display:flex;"><span>getaddress 0_b, 2
</span></span><span style="display:flex;"><span>add 
</span></span><span style="display:flex;"><span>push 2_a
</span></span><span style="display:flex;"><span>getvalue 2_a, 0
</span></span><span style="display:flex;"><span>ret 1
</span></span><span style="display:flex;"><span>endfunc 
</span></span><span style="display:flex;"><span>mainfunc main
</span></span><span style="display:flex;"><span>var 3_q
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>var 3_x
</span></span><span style="display:flex;"><span>push 3_q
</span></span><span style="display:flex;"><span>getvalue 3_q, 0
</span></span><span style="display:flex;"><span>var 3_z
</span></span><span style="display:flex;"><span>defaultvalue 3_z, 0
</span></span><span style="display:flex;"><span>var 3_y
</span></span><span style="display:flex;"><span>push 0_b
</span></span><span style="display:flex;"><span>getaddress 0_b, 2
</span></span><span style="display:flex;"><span>rparam b, 2
</span></span><span style="display:flex;"><span>$func
</span></span><span style="display:flex;"><span>push 3_z
</span></span><span style="display:flex;"><span>getaddress 3_z, 0
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>rparam 3, 0
</span></span><span style="display:flex;"><span>$func2
</span></span><span style="display:flex;"><span>pop 3_z
</span></span><span style="display:flex;"><span>push 3
</span></span><span style="display:flex;"><span>print &#34;%d&#34;
</span></span><span style="display:flex;"><span>push 0
</span></span><span style="display:flex;"><span>ret 1
</span></span><span style="display:flex;"><span>exit
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>微信</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="/img/alipay.jpg" alt="alipay"></a>
                        <p>支付宝</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>🧧 鼓励</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://mksasx.github.io/posts/sport/%E7%AF%AE%E7%90%83%E5%9F%BA%E6%9C%AC%E6%88%98%E6%9C%AF%E5%8F%8A%E5%9B%BE%E8%A7%A3/">
    <span class="title">« 上一页</span>
    <br>
    <span>篮球基本战术及图解</span>
  </a>
  <a class="next" href="https://mksasx.github.io/posts/tech/os/great/">
    <span class="title">下一页 »</span>
    <br>
    <span>操作系统申优文档</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">💬评论</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://vercal-mogodb-comment.vercel.app/", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou',
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<meting-js
        id="8109915341"
        lrc-type="0"
        server="tencent"
        order="random"
        type="playlist"
        fixed="true"
        list-olded="true">
</meting-js>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://mksasx.github.io/" style="color:#939393;">AustinMa&#39;s Blog</a>
         All Rights Reserved
    </span>

    

     <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        总访客数: <i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span>
        总访问量: <i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"AustinMa's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"AustinMa's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"AustinMa's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                    '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
